<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŠã˜.exe v4.1 | å®‰å®šç‰ˆ</title>
  <style>
    :root{
      --bg:#0f172a; --card:#1e293b; --accent:#38bdf8; --text:#f8fafc;
      --muted:#94a3b8; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:16px; --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", sans-serif;
      background-color: var(--bg); color: var(--text); line-height: 1.6;
    }
    .stepper { display: flex; gap: 4px; padding: 12px 16px; background: rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px); }
    .step-dot { flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
    .step-dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
    .wrap{ max-width:600px; margin:0 auto; padding:16px; }
    .header{ margin-bottom: 24px; text-align: center; }
    .title{ font-weight:900; font-size:24px; color: var(--accent); }
    .sub{ font-size:12px; color: var(--muted); }
    .card{ background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); display: none; }
    h2 { margin: 0 0 16px; font-size: 18px; display: flex; align-items: center; gap: 8px; }
    .note { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px; font-size: 13px; color: var(--muted); margin-bottom: 16px; }
    label { display: block; font-size: 12px; font-weight: bold; color: var(--accent); margin-bottom: 6px; text-transform: uppercase; }
    select, input, textarea { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; font-size: 16px; margin-bottom: 16px; }
    .btn-group { display: flex; gap: 8px; margin-bottom: 16px; }
    .tgl-btn { flex: 1; background: #334155; border: none; color: var(--muted); padding: 10px 4px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }
    .tgl-btn.active { background: var(--accent); color: #0f172a; }
    .tgl-btn.active.bad { background: var(--bad); color: white; }
    .btn-row { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    button.main { background: var(--accent); color: #0f172a; border: none; padding: 16px; border-radius: 12px; font-weight: 900; font-size: 16px; cursor: pointer; transition: 0.2s; }
    button.main:disabled { opacity: 0.3; filter: grayscale(1); }
    button.sub-btn { background: transparent; color: var(--muted); border: 1px solid #334155; padding: 12px; border-radius: 12px; }
    button.danger { background: rgba(239, 68, 68, 0.1); color: var(--bad); border: 1px solid var(--bad); padding: 12px; border-radius: 12px; }
    .res-box { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; margin-top: 12px; border: 1px solid rgba(255,255,255,0.1); }
    .res-score { font-size: 32px; font-weight: 900; color: var(--good); text-align: center; margin: 8px 0; }
    .res-label { text-align: center; font-size: 14px; color: var(--muted); }
    .log-item { background: #1e293b; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 12px; border-left: 4px solid var(--accent); }
    .log-item.skip { border-left-color: var(--muted); opacity: 0.7; }
    .mono { font-family: var(--font-mono); font-size: 11px; white-space: pre-wrap; word-break: break-all; }
  </style>
</head>
<body>

  <!-- 6ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆp1ã€œp6ï¼‰ãªã®ã§ãƒ‰ãƒƒãƒˆã¯6å€‹ã§OK -->
  <div class="stepper" id="stepper">
    <div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div>
    <div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div>
  </div>

  <div class="wrap">
    <div class="header">
      <div class="title">ãŠã˜.exe v4.1</div>
      <div class="sub">æ„Ÿæƒ…ã‚’æ’é™¤ã€‚æ‰‹é †ã‚’å®ˆã‚‹ã€‚</div>
    </div>

    <div class="card" id="p1" style="display: block;">
      <h2>ğŸ‡ ãƒ¬ãƒ¼ã‚¹è¨­å®š</h2>
      <label>æ—¥ä»˜</label><input type="date" id="date">

      <div style="display: flex; gap: 8px;">
        <div style="flex: 1;">
          <label>å ´æ‰€</label>
          <select id="track">
            <option>ä¸­å±±</option><option>æ±äº¬</option><option>äº¬éƒ½</option><option>é˜ªç¥</option>
            <option>ä¸­äº¬</option><option>æœ­å¹Œ</option><option>å‡½é¤¨</option><option>ç¦å³¶</option>
            <option>æ–°æ½Ÿ</option><option>å°å€‰</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label>R</label>
          <select id="raceNo">
            <option>1R</option><option>2R</option><option>3R</option><option>4R</option><option>5R</option><option>6R</option>
            <option>7R</option><option>8R</option><option>9R</option><option>10R</option><option>11R</option><option>12R</option>
          </select>
        </div>
      </div>

      <label>ã‚¯ãƒ©ã‚¹</label>
      <select id="raceClass">
        <option value="G">é‡è³(G1-G3)</option><option value="OP">OP/L</option><option value="3S">3å‹ã‚¯ãƒ©ã‚¹</option>
        <option value="2S">2å‹ã‚¯ãƒ©ã‚¹</option><option value="1S">1å‹ã‚¯ãƒ©ã‚¹</option><option value="LOW">æœªå‹åˆ©/æ–°é¦¬</option>
      </select>

      <label>æ¡ä»¶</label>
      <select id="course">
        <option value="TARGET">å¾—æ„ï¼šä¸­å±±ãƒ€1800 / æ±äº¬ãƒ€1600</option>
        <option value="NORMAL">ãã®ä»–</option>
      </select>

      <div id="raceSummary" class="note"></div>

      <div class="btn-row">
        <button class="main" onclick="startAnalysis()">åˆ†æé–‹å§‹</button>
        <button class="danger" onclick="saveSkip('RACE_SKIP')">ä»Šæ—¥ã¯ã‚„ã‚ã‚‹ï¼ˆè¦‹é€ã‚Šä¿å­˜ï¼‰</button>
      </div>
    </div>

    <div class="card" id="p2">
      <h2>âš–ï¸ å‰æãƒã‚§ãƒƒã‚¯</h2>
      <div class="note">ä¸€ã¤ã§ã‚‚ã€ŒNOã€ãŒã‚ã‚Œã°å³çµ‚äº†ã€‚</div>

      <label>Q1. ä»Šæ—¥ã¯3ãƒ¬ãƒ¼ã‚¹ä»¥å†…ã‚’å®ˆã‚Œã‚‹ï¼Ÿ</label>
      <div class="btn-group">
        <button class="tgl-btn" id="q01y" onclick="setCheck('q01','y')">YES</button>
        <button class="tgl-btn" id="q01n" onclick="setCheck('q01','n')">NO</button>
      </div>

      <label>Q2. 1ç‚¹500å††å›ºå®šã‚’å®ˆã‚Œã‚‹ï¼Ÿ</label>
      <div class="btn-group">
        <button class="tgl-btn" id="q02y" onclick="setCheck('q02','y')">YES</button>
        <button class="tgl-btn" id="q02n" onclick="setCheck('q02','n')">NO</button>
      </div>

      <div class="btn-row">
        <button class="main" id="btnP2Next" disabled onclick="go(3)">æ¬¡ã¸</button>
        <button class="sub-btn" onclick="go(1)">æˆ»ã‚‹</button>
      </div>
    </div>

    <div class="card" id="p3">
      <h2>ğŸ” å€™è£œé¦¬æŠ½å‡º</h2>
      <div class="note">é¦¬ç•ªã‚’ 1ã€œ18 ã®ç¯„å›²ã§å…¥åŠ›ï¼ˆé‡è¤‡ç„¡åŠ¹ï¼‰ã€‚</div>

      <div id="candInputs">
        <input type="number" id="c1" inputmode="numeric" placeholder="å€™è£œ1">
        <input type="number" id="c2" inputmode="numeric" placeholder="å€™è£œ2">
        <input type="number" id="c3" inputmode="numeric" placeholder="å€™è£œ3">
      </div>

      <div class="btn-row">
        <button class="main" onclick="setupScoring()">ç‚¹æ•°ä»˜ã‘ã¸</button>
        <button class="danger" onclick="saveSkip('NO_CANDIDATES')">å€™è£œãªã—è¦‹é€ã‚Š</button>
      </div>
    </div>

    <div class="card" id="p4">
      <h2>ğŸ“Š ä¸‰æœ¬æŸ±ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°</h2>
      <div id="scoringArea"></div>
      <div class="btn-row">
        <button class="main" onclick="calcResult()">çµæœã‚’è¦‹ã‚‹</button>
        <button class="sub-btn" onclick="go(3)">æˆ»ã‚‹</button>
      </div>
    </div>

    <div class="card" id="p5">
      <h2>ğŸ çµè«–</h2>
      <div id="resultDisplay"></div>
      <div class="btn-row">
        <button class="main" id="btnP5Next" onclick="go(6)">æœ€çµ‚ãƒã‚§ãƒƒã‚¯ã¸</button>
        <button class="danger" onclick="saveSkip('LOW_SCORE_OR_TIE')">è¦‹é€ã‚Šä¿å­˜</button>
        <button class="sub-btn" onclick="go(4)">ã‚„ã‚Šç›´ã™</button>
      </div>
    </div>

    <div class="card" id="p6">
      <h2>ğŸš¨ æœ€çµ‚ãƒ–ãƒ¬ãƒ¼ã‚­</h2>

      <label>Q. é¦¬ä½“é‡ã®å¢—æ¸›ã¯ Â±12kg æœªæº€ï¼Ÿ</label>
      <div class="btn-group">
        <button class="tgl-btn" id="f1y" onclick="setCheck('f1','y')">YES</button>
        <button class="tgl-btn" id="f1n" onclick="setCheck('f1','n')">NO</button>
      </div>

      <label>Q. ç›´å‰ã§ä¸å®‰è¦ç´ ï¼ˆé¦¬å ´æ‚ªåŒ–ç­‰ï¼‰ã¯ãªã„ï¼Ÿ</label>
      <div class="btn-group">
        <button class="tgl-btn" id="f2y" onclick="setCheck('f2','y')">YES</button>
        <button class="tgl-btn" id="f2n" onclick="setCheck('f2','n')">NO</button>
      </div>

      <label>è² ã‘ç­‹ã‚’ä¸€è¨€ï¼ˆãƒªã‚¹ã‚¯è¨˜å…¥å¿…é ˆï¼‰</label>
      <input type="text" id="risk" placeholder="ä¾‹ï¼šå‰ãŒæ­¢ã¾ã‚‰ãªã„ç­‰" oninput="validateFinal()">

      <div class="btn-row">
        <button class="main" id="btnFinal" disabled onclick="saveFinal('BUY')">BUYä¿å­˜</button>
        <button class="danger" onclick="saveFinal('SKIP')">SKIPä¿å­˜</button>
      </div>
    </div>

    <div style="margin-top: 32px;">
      <h3 style="font-size: 14px; color: var(--muted);">æœ€è¿‘ã®è¨˜éŒ²</h3>
      <div id="historyList"></div>

      <div class="btn-row" style="flex-direction: row;">
        <button class="sub-btn" style="flex:1" onclick="copyLog()">CSVã‚³ãƒ”ãƒ¼</button>
        <button class="sub-btn" style="flex:1; color:var(--bad)" onclick="clearLog()">æ¶ˆå»</button>
      </div>

      <div class="note mono" id="csvPreview" style="margin-top: 10px; max-height: 80px;"></div>
    </div>
  </div>

<script>
  let state = { step: 1, checks: {}, cands: [], scores: {}, best: null };
  const STORAGE_KEY = "oji_exe_v41_logs";

  // --- 1) Race Summary Logic ---
  function updateRaceSummary() {
    const vals = {
      date: document.getElementById('date').value,
      track: document.getElementById('track').value,
      raceNo: document.getElementById('raceNo').value,
      raceClass: document.getElementById('raceClass').value,
      course: document.getElementById('course').value
    };
    const clsLabel = { G:"é‡è³", OP:"OP/L", "3S":"3å‹", "2S":"2å‹", "1S":"1å‹" }[vals.raceClass] || "æœªå‹åˆ©/æ–°é¦¬";
    const targetOK = (vals.raceClass === "G" || vals.course === "TARGET");

    document.getElementById('raceSummary').innerHTML = `
      <b>${vals.date} ${vals.track}${vals.raceNo}</b><br>
      ã‚¯ãƒ©ã‚¹ï¼š${clsLabel} ï¼ åˆ¤å®šï¼š${targetOK
        ? "<span style='color:var(--good)'>å¯¾è±¡</span>"
        : "<span style='color:var(--bad)'>å¯¾è±¡å¤–ï¼ˆè¦‹é€ã‚Šæ¨å¥¨ï¼‰</span>"}
    `;
  }

  ["date","track","raceNo","raceClass","course"].forEach(id => {
    document.getElementById(id).addEventListener("change", updateRaceSummary);
  });

  // --- 2) Analysis Filterï¼ˆå¼·è¡Œãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤ï¼šå¯¾è±¡å¤–ã¯å³SKIPï¼‰---
  function startAnalysis(){
    const ok =
      (document.getElementById('raceClass').value === "G" ||
       document.getElementById('course').value === "TARGET");

    if(!ok){
      alert("å¯¾è±¡å¤–ã§ã™ã€‚ãƒ«ãƒ¼ãƒ«é€šã‚Šè¦‹é€ã‚Šä¿å­˜ã—ã¾ã™ã€‚");
      saveSkip("OUT_OF_SCOPE");
      return;
    }
    go(2);
  }

  // --- 3) Scoring Setup (Cleaned) ---
  function setupScoring() {
    state.scores = {};
    const raw = [
      document.getElementById('c1').value,
      document.getElementById('c2').value,
      document.getElementById('c3').value
    ];

    const cleaned = [...new Set(
      raw
        .map(v => String(v).trim())
        .filter(v => v !== "")
        .map(Number)
        .filter(n => Number.isFinite(n) && n >= 1 && n <= 18)
    )];

    state.cands = cleaned.map(String);

    if (state.cands.length === 0) {
      alert("æœ‰åŠ¹ãªé¦¬ç•ª(1ã€œ18)ã‚’1ã¤ä»¥ä¸Šå…¥ã‚Œã¦ãã ã•ã„");
      return;
    }

    let html = "";
    state.cands.forEach(num => {
      state.scores[num] = { p1: 0, p2: 0, p3: 0 };
      html += `
        <div class="res-box">
          <div style="font-weight:bold; color:var(--accent); margin-bottom:8px;">é¦¬ç•ª: ${num}</div>

          <label>é©æ€§(0-2)</label>
          <div class="btn-group">
            <button class="tgl-btn" onclick="setScore('${num}','p1',2,this)">â—</button>
            <button class="tgl-btn" onclick="setScore('${num}','p1',1,this)">â—‹</button>
            <button class="tgl-btn" onclick="setScore('${num}','p1',0,this)">â–³</button>
          </div>

          <label>å±•é–‹(0-2)</label>
          <div class="btn-group">
            <button class="tgl-btn" onclick="setScore('${num}','p2',2,this)">è‰¯</button>
            <button class="tgl-btn" onclick="setScore('${num}','p2',1,this)">ä¸¦</button>
            <button class="tgl-btn" onclick="setScore('${num}','p2',0,this)">ä¸</button>
          </div>

          <label>é¨æ‰‹(0~-1)</label>
          <div class="btn-group">
            <button class="tgl-btn" onclick="setScore('${num}','p3',0,this)">0</button>
            <button class="tgl-btn" onclick="setScore('${num}','p3',-0.5,this)">-0.5</button>
            <button class="tgl-btn" onclick="setScore('${num}','p3',-1,this)">-1</button>
          </div>
        </div>`;
    });

    document.getElementById('scoringArea').innerHTML = html;
    go(4);
  }

  function setScore(n, p, v, b) {
    state.scores[n][p] = v;
    b.parentElement.querySelectorAll('.tgl-btn').forEach(x => x.classList.remove('active', 'bad'));
    b.classList.add('active');
    if(v < 0) b.classList.add('bad');
  }

  // --- 4) Strict Result ---
  function calcResult() {
    let res = Object.keys(state.scores).map(n => ({
      num:n,
      total: (state.scores[n].p1 + state.scores[n].p2 + state.scores[n].p3),
      ...state.scores[n]
    }));

    res.sort((a,b) => b.total - a.total || b.p1 - a.p1 || b.p2 - a.p2 || b.p3 - a.p3);

    state.best = res[0];

    const isTie =
      res.length > 1 &&
      res[0].total === res[1].total &&
      res[0].p1 === res[1].p1 &&
      res[0].p2 === res[1].p2 &&
      res[0].p3 === res[1].p3;

    let html =
      `<div class="res-box">
        <div class="res-label">æœ¬å‘½</div>
        <div class="res-score">${isTie ? "åŒç‚¹(è¦‹é€ã‚Š)" : "é¦¬" + state.best.num}</div>
        <div class="res-label">Score: ${state.best.total.toFixed(1)}</div>
      </div>`;

    res.forEach(r => {
      html += `<div style="font-size:11px; color:var(--muted)">é¦¬${r.num}: ${r.total.toFixed(1)} (é©${r.p1}/å±•${r.p2}/é¨${r.p3})</div>`;
    });

    document.getElementById('resultDisplay').innerHTML = html;

    // åŒç‚¹ or 1.0æœªæº€ã¯æ¬¡ã¸è¡Œã‹ã›ãªã„ï¼ˆãƒ«ãƒ¼ãƒ«å›ºå®šï¼‰
    document.getElementById('btnP5Next').disabled = (isTie || state.best.total < 1.0);

    // æœ€çµ‚ä¿å­˜ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚‚æ›´æ–°ï¼ˆbestãŒå¤‰ã‚ã‚‹ã®ã§ï¼‰
    validateFinal();

    go(5);
  }

  // --- 5) Secure Log & CSV ---
  function toCSV(logs) {
    const headers = ["ts","date","race","horse","score","decision","risk"];
    const esc = (v) => `"${String(v ?? "").replace(/"/g,'""')}"`;
    return [headers.join(","), ...logs.map(l => headers.map(k => esc(l[k])).join(","))].join("\n");
  }

  function renderHistory() {
    const all = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    document.getElementById('historyList').innerHTML = [...all].reverse().slice(0, 5).map(l => `
      <div class="log-item ${l.decision === 'SKIP' ? 'skip' : ''}">
        <b>${l.date} ${l.race}</b> [${l.decision}] é¦¬${l.horse ?? "-"}(${l.score ?? "-"}ç‚¹)<br>
        ãƒªã‚¹ã‚¯: ${l.risk ?? ""}
      </div>`).join('');
    document.getElementById('csvPreview').textContent = toCSV(all);
  }

  // --- æœ€çµ‚ãƒ–ãƒ¬ãƒ¼ã‚­ã®ã€ŒBUYå¯èƒ½æ¡ä»¶ã€ ---
  function validateFinal() {
    const hasChecks = state.checks.f1 && state.checks.f2;
    const hasRisk = document.getElementById('risk').value.trim() !== "";
    const okBest = state.best && typeof state.best.total === "number" && state.best.total >= 1.0;

    document.getElementById('btnFinal').disabled = !(hasChecks && hasRisk && okBest);
  }

  function setCheck(id, val) {
    state.checks[id] = val;
    document.getElementById(id + 'y').classList.toggle('active', val === 'y');
    document.getElementById(id + 'n').classList.toggle('active', val === 'n');

    if (id.startsWith('q')) {
      document.getElementById('btnP2Next').disabled = !(state.checks.q01 === 'y' && state.checks.q02 === 'y');
    }
    if (id.startsWith('f')) {
      validateFinal();
    }
  }

  // --- ä¿å­˜ï¼ˆBUYã¯1.0æœªæº€ç¦æ­¢ï¼†bestæœªç¢ºå®šç¦æ­¢ï¼‰---
  function saveFinal(dec) {
    if (!state.best || typeof state.best.total !== "number") {
      alert("æœ¬å‘½ãŒç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ï¼ˆçµæœã‚’å‡ºã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰");
      return;
    }
    if (dec === "BUY" && state.best.total < 1.0) {
      alert("ãƒˆãƒƒãƒ—ãŒ1.0ç‚¹æœªæº€ã®ãŸã‚ BUY ã¯ä¸å¯ï¼ˆè¦‹é€ã‚Šæ¨å¥¨ï¼‰");
      return;
    }

    const logs = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    logs.push({
      ts: new Date().toLocaleString(),
      date: document.getElementById('date').value,
      race: document.getElementById('track').value + document.getElementById('raceNo').value,
      horse: state.best.num,
      score: state.best.total,
      decision: dec,
      risk: document.getElementById('risk').value.trim()
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
    location.reload();
  }

  function saveSkip(reason) {
    const logs = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    logs.push({
      ts: new Date().toLocaleString(),
      date: document.getElementById('date').value,
      race: document.getElementById('track').value + document.getElementById('raceNo').value,
      horse: "-",
      score: "-",
      decision: "SKIP",
      risk: reason
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
    location.reload();
  }

  function go(s) {
    document.querySelectorAll('.card').forEach(c => c.style.display = 'none');
    document.getElementById('p' + s).style.display = 'block';
    state.step = s;
    updateStepper();
    window.scrollTo(0,0);
  }
  function updateStepper() {
    document.querySelectorAll('.step-dot').forEach((d, i) => d.classList.toggle('active', i < state.step));
  }

  function copyLog() {
    navigator.clipboard.writeText(toCSV(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]")));
    alert("CSVã‚³ãƒ”ãƒ¼å®Œäº†");
  }
  function clearLog() {
    if(confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  }

  // Init
  document.getElementById('date').valueAsDate = new Date();
  updateRaceSummary();
  renderHistory();
  updateStepper();
</script>
</body>
</html>
