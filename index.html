<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŠã˜.exe v5.4.1 | æµã‚Œåæ˜ ï¼‹ä¼‘ã¿æ˜ã‘</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0f172a; --card:#1e293b; --accent:#38bdf8; --text:#f8fafc;
      --muted:#94a3b8; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:16px; --tap:44px;
      --focus: 0 0 0 3px rgba(56,189,248,.35);
      --line: rgba(255,255,255,.10);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    input, select, button { font: inherit; }

    h2, h3{ margin: 0 0 12px; font-size: 18px; }
    h3{ font-size: 14px; }

    .stepper{
      display:flex; gap:4px; padding:12px 16px;
      background: rgba(0,0,0,0.2);
      position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .step-dot{ flex:1; height:4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
    .step-dot.active{ background: var(--accent); box-shadow: 0 0 8px rgba(56,189,248,.75); }

    .wrap{ max-width:600px; margin:0 auto; padding:16px; }
    .header{ margin-bottom: 24px; text-align:center; }
    .title{ font-weight:900; font-size:24px; color: var(--accent); }
    .sub{ color: var(--muted); font-size: 13px; margin-top: 6px; }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      display: none;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 10px 28px rgba(0,0,0,.18);
    }
    .card[aria-hidden="false"]{ display:block; }

    .note{
      background: rgba(0,0,0,0.2);
      padding: 12px;
      border-radius: 12px;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .note b{ color: var(--text); }

    .row{ display:flex; gap:8px; align-items:stretch; }
    .row > *{ flex:1; }

    label{
      display:block;
      font-size: 12px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 6px;
    }
    select, input{
      width: 100%;
      background: #0f172a;
      border: 1px solid #334155;
      color: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 16px;
      font-size: 16px;
      min-height: var(--tap);
    }
    input:focus-visible, select:focus-visible{
      outline:none; box-shadow: var(--focus); border-color: rgba(56,189,248,.6);
    }

    .btn-row{ display:flex; gap:8px; }
    .btn-group{ display:flex; gap: 6px; margin-bottom: 14px; }

    .tgl-btn{
      flex:1;
      min-height: var(--tap);
      background: #334155;
      border: 1px solid rgba(255,255,255,0.06);
      color: var(--muted);
      padding: 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 900;
      cursor: pointer;
      touch-action: manipulation;
      user-select:none;
    }
    .tgl-btn.active{ background: var(--accent); color: #0f172a; border-color: rgba(56,189,248,.35); }
    .tgl-btn:focus-visible{ outline:none; box-shadow: var(--focus); }
    .tgl-btn:disabled{ opacity:.35; cursor:not-allowed; }

    button.main{
      width: 100%;
      min-height: var(--tap);
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
      touch-action: manipulation;
    }
    button.main:disabled{ opacity: 0.3; cursor: not-allowed; }
    button.main:focus-visible{ outline:none; box-shadow: var(--focus); }

    button.danger{
      width: 100%;
      min-height: var(--tap);
      background: rgba(239, 68, 68, 0.1);
      color: var(--bad);
      border: 1px solid var(--bad);
      padding: 12px;
      border-radius: 12px;
      margin-top: 10px;
      cursor: pointer;
      touch-action: manipulation;
    }
    button.danger:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(239,68,68,.25); }

    .horse-grid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }
    .horse-btn{
      min-height: var(--tap);
      aspect-ratio: 1/1;
      background: #334155;
      border: 1px solid rgba(255,255,255,0.06);
      color: white;
      border-radius: 10px;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
      touch-action: manipulation;
      user-select: none;
    }
    .horse-btn:focus-visible{ outline: none; box-shadow: var(--focus); }
    .horse-btn.eliminated{
      background: #1e293b;
      color: #475569;
      text-decoration: line-through;
      opacity: 0.55;
      border: 1px solid #0f172a;
    }
    /* å‰²å¼•Aï¼šå†…æ Ã—å…ˆè¡Œä¸å¯ */
    .horse-btn.discountA{
      background: rgba(245, 158, 11, 0.22);
      border: 1px solid rgba(245, 158, 11, 0.45);
      color: #fde68a;
    }
    /* 5ã€œ8ã‚¿ã‚° */
    .horse-btn.tag58{
      background: rgba(56, 189, 248, 0.18);
      border: 1px solid rgba(56, 189, 248, 0.45);
      color: #e0f2fe;
    }
    /* è‡ªå‹•å‰²å¼•ï¼ˆâ—ä¸å¯ï¼‰ */
    .horse-btn.flowDiscount{
      background: rgba(239, 68, 68, 0.16);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #fecaca;
    }
    .horse-btn.eliminated.discountA,
    .horse-btn.eliminated.tag58,
    .horse-btn.eliminated.flowDiscount{
      background:#1e293b;
      border: 1px solid #0f172a;
      color:#475569;
    }

    .res-box{
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .res-score{ font-size: 32px; font-weight: 900; color: var(--good); text-align:center; }

    .sub-btn{
      flex:1;
      min-height: var(--tap);
      border:none;
      padding:10px;
      border-radius:10px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
      touch-action: manipulation;
      background:#334155; color:white;
    }
    .sub-btn:focus-visible{ outline:none; box-shadow: var(--focus); }

.pill{
  display:inline-block;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.08);
  color: var(--muted);
  font-size: 12px;
  font-weight: 800;
}

.tools{
  margin: 0 0 14px;
  display: flex;
  justify-content: flex-end;
}

.tools .sub-btn{
  flex: 0 0 auto;
}

    @media (max-width: 360px){
      .horse-grid{ grid-template-columns: repeat(5, 1fr); }
      .title{ font-size: 22px; }
    }
  </style>
</head>
<body>

  <div class="stepper" aria-label="é€²è¡ŒçŠ¶æ³">
    <div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div>
    <div class="step-dot"></div><div class="step-dot"></div>
  </div>

  <div class="wrap">
    <div class="header">
      <div class="title">ãŠã˜.exe v5.4.1</div>
      <div class="sub">æµã‚Œåæ˜ ï¼ˆ5ã€œ8ã‚¿ã‚°ï¼‰ï¼‹ä¼‘ã¿æ˜ã‘B/C</div>
    </div>
  <div class="tools">
    <button class="sub-btn" id="btnExportCsv" type="button">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  </div>

    <!-- p1 -->
    <div class="card" id="p1" aria-hidden="false">
      <h2>ğŸ‡ ãƒ¬ãƒ¼ã‚¹è¨­å®š</h2>

      <label for="raceDate">æ—¥ä»˜</label>
      <input type="date" id="raceDate" />

      <label>ç«¶é¦¬å ´ / èŠãƒ€ / è·é›¢</label>
      <div class="row">
        <select id="track" aria-label="ç«¶é¦¬å ´">
          <option value="æ±äº¬">æ±äº¬</option><option value="ä¸­å±±">ä¸­å±±</option><option value="é˜ªç¥">é˜ªç¥</option><option value="äº¬éƒ½">äº¬éƒ½</option>
          <option value="ä¸­äº¬">ä¸­äº¬</option><option value="æ–°æ½Ÿ">æ–°æ½Ÿ</option><option value="æœ­å¹Œ">æœ­å¹Œ</option><option value="å‡½é¤¨">å‡½é¤¨</option>
          <option value="ç¦å³¶">ç¦å³¶</option><option value="å°å€‰">å°å€‰</option>
        </select>
        <select id="surface" aria-label="èŠãƒ€">
          <option value="ãƒ€">ãƒ€</option><option value="èŠ">èŠ</option>
        </select>
        <select id="dist" aria-label="è·é›¢">
          <option value="1200">1200</option>
          <option value="1400" selected>1400</option>
          <option value="1600">1600</option>
          <option value="1800">1800</option>
          <option value="2000">2000</option>
          <option value="2400">2400</option>
        </select>
      </div>

      <label>é¦¬å ´ï¼ˆãƒ¡ãƒ¢ç”¨ï¼‰</label>
      <div class="btn-group" role="group" aria-label="é¦¬å ´çŠ¶æ…‹">
        <button class="tgl-btn active" id="condDry" type="button">è‰¯ãƒ»ç¨é‡</button>
        <button class="tgl-btn" id="condWet" type="button">é‡ãƒ»ä¸è‰¯</button>
      </div>

      <label for="raceNo">ãƒ¬ãƒ¼ã‚¹</label>
      <select id="raceNo" aria-label="ãƒ¬ãƒ¼ã‚¹ç•ªå·">
        <option value="1">1R</option><option value="2">2R</option><option value="3">3R</option><option value="4">4R</option>
        <option value="5">5R</option><option value="6">6R</option><option value="7">7R</option><option value="8">8R</option>
        <option value="9">9R</option><option value="10">10R</option><option value="11">11R</option><option value="12">12R</option>
      </select>

      <label for="raceName">ãƒ¬ãƒ¼ã‚¹åï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="raceName" placeholder="ä¾‹ï¼šæ ¹å²¸S" autocomplete="off" inputmode="text" />

      <div class="btn-row">
        <button class="main" id="btnStart" type="button">åˆ†æé–‹å§‹</button>
      </div>

      <div style="margin-top:10px; text-align:center;">
        <span class="pill" id="raceBadge">æœªè¨­å®š</span>
      </div>
    </div>

    <!-- p2 -->
    <div class="card" id="p2" aria-hidden="true">
      <h2>âœ‚ï¸ STEP1: æ¡ä»¶ä¸é©åˆã‚’æ¶ˆã™</h2>
      <div class="note" id="noteStep1"></div>
      <div class="horse-grid" id="grid1" aria-label="STEP1 è¶³åˆ‡ã‚Š"></div>
      <div class="note" id="count1">ç”Ÿå­˜æ•°: 18é ­</div>
      <button class="main" id="btnToStep2" type="button">STEP2ï¼ˆå±•é–‹ï¼‰ã¸</button>
    </div>

    <!-- p3 -->
    <div class="card" id="p3" aria-hidden="true">
      <h2>âœ‚ï¸ STEP2: å±•é–‹ã§æ¶ˆã™</h2>
      <div class="note" id="noteStep2"></div>

      <div class="horse-grid" id="grid2" aria-label="STEP2 è¶³åˆ‡ã‚Š"></div>
      <div class="note" id="count2">ç”Ÿå­˜æ•°: -</div>

      <div class="note" style="border-color: rgba(56,189,248,.22);">
        <b>ğŸ· 5ã€œ8ç•ªæ‰‹æƒ³å®šï¼ˆç”Ÿå­˜é¦¬ã®ã¿ï¼‰</b><br>
        ã€Œã“ã®é¦¬ã¯5ã€œ8ç•ªæ‰‹ã«ãªã‚Šãã†ã€ã‚’ä»˜ã‘ã‚‹ï¼ˆæµã‚Œã§æ„å‘³ãŒå¤‰ã‚ã‚‹ï¼‰ã€‚
      </div>
      <div class="horse-grid" id="gridTag58" aria-label="5ã€œ8ç•ªæ‰‹ã‚¿ã‚°"></div>

      <div class="note" style="border-color: rgba(245,158,11,.25);">
        <b>âš ï¸ å‰²å¼•Aï¼ˆæ¶ˆã•ãªã„ï¼‰</b><br>
        ã€Œå†…æ Ã—å…ˆè¡Œã§ããªã„ï¼ˆ5ã€œ8ç•ªæ‰‹æƒ³å®šï¼‰ã€ã ã‘ã‚’å‰²å¼•ã«ã™ã‚‹ã€‚
      </div>
      <div class="horse-grid" id="gridDiscountA" aria-label="å‰²å¼•A"></div>

      <div class="note">
        <b>ğŸ” æµã‚Œï¼ˆå‰ã«è¡ŒããŸã„é¦¬ã®æ•°ï¼‰</b><br>
        å®šç¾©ï¼šç›´è¿‘3èµ°ã®4è§’ã§<b>ã€Œ1ã€œ3ç•ªæ‰‹ãŒ2å›ä»¥ä¸Šã€</b>ã®é¦¬ã‚’ã‚«ã‚¦ãƒ³ãƒˆã€‚<br>
        é¸ã‚“ã æµã‚Œã«å¿œã˜ã¦ã€<b>5ã€œ8ã‚¿ã‚°</b>ã¯è‡ªå‹•ã§â—ä¸å¯ã«ãªã‚‹ï¼ˆæ™®é€šã®ã¨ãã ã‘â—OKï¼‰ã€‚
      </div>
      <div class="btn-group" role="group" aria-label="æµã‚Œé¸æŠ">
        <button class="tgl-btn" id="flowFew" type="button">å°‘ãªã„ï¼ˆ1ã€œ2ï¼‰</button>
        <button class="tgl-btn active" id="flowMid" type="button">æ™®é€šï¼ˆ3ã€œ5ï¼‰</button>
        <button class="tgl-btn" id="flowMany" type="button">å¤šã„ï¼ˆ6ã€œï¼‰</button>
      </div>

      <div class="note" id="noteFlowEffect"></div>

      <div class="note" style="border-color: rgba(56,189,248,.22);">
        <b>ğŸ›Œ ä¼‘ã¿æ˜ã‘ã‚¿ã‚°ï¼ˆç”Ÿå­˜é¦¬ã®ã¿ï¼‰</b><br>
        ä¼‘ã¿æ˜ã‘ã¯ã€Œæ¶ˆã—ã€ã§ã¯ãªãåŸºæœ¬ã¯<b>å‰²å¼•</b>ã§æ‰±ã†ï¼ˆâ—ä¸å¯ï¼‰ã€‚<br>
        ãƒ»9ã€œ20é€±ï¼šå‰²å¼•Bã€€ãƒ»21é€±ä»¥ä¸Šï¼šå‰²å¼•Cï¼ˆæ¶ˆã—æ¨å¥¨ï¼‰
      </div>

      <div class="note" style="margin-top:-8px;">
        <b>9ã€œ20é€±ï¼ˆå‰²å¼•Bï¼‰</b>ï¼šã‚¿ãƒƒãƒ—ã§ON/OFF
      </div>
      <div class="horse-grid" id="gridRestMid" aria-label="ä¼‘ã¿æ˜ã‘9ã€œ20é€±"></div>

      <div class="note" style="margin-top:-8px;">
        <b>21é€±ä»¥ä¸Šï¼ˆå‰²å¼•Cï¼‰</b>ï¼šã‚¿ãƒƒãƒ—ã§ON/OFFï¼ˆè¿·ã†ãªã‚‰STEP2ã§æ¶ˆã™ï¼‰
      </div>
      <div class="horse-grid" id="gridRestLong" aria-label="ä¼‘ã¿æ˜ã‘21é€±ä»¥ä¸Š"></div>

      <button class="main" id="btnToScore" type="button">ä¸‰æœ¬æŸ±æŸ»å®šã¸</button>
      <button class="danger" id="btnSkipAll" type="button">å…¨æ»…ãƒ»è¦‹é€ã‚Š</button>
    </div>

    <!-- p4 -->
    <div class="card" id="p4" aria-hidden="true">
      <h2>ğŸ“Š ç²¾å¯†æŸ»å®šï¼ˆç”Ÿå­˜é¦¬ã®ã¿ï¼‰</h2>
      <div class="note" id="noteScoringRule"></div>
      <div id="scoringArea"></div>
      <button class="main" id="btnCalc" type="button">çµè«–ã‚’å‡ºã™</button>
    </div>

    <!-- p5 -->
    <div class="card" id="p5" aria-hidden="true">
      <h2>ğŸ æœ€çµ‚ã‚¸ãƒ£ãƒƒã‚¸</h2>

      <div id="resultDisplay"></div>

      <div class="btn-row" style="margin-top:10px;">
        <button class="sub-btn" id="btnRestart" type="button">æ–°ã—ã„äºˆæƒ³ã¸</button>
      </div>

      <label for="risk" style="margin-top:12px;">è² ã‘ç­‹ï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="risk" placeholder="ä¾‹ï¼šå†…æ ã©ã‚“è©°ã¾ã‚Š" autocomplete="off" inputmode="text" />

      <button class="main" id="btnFinalBuy" type="button">BUYä¿å­˜</button>
      <button class="danger" id="btnFinalSkip" type="button">è¦‹é€ã‚Šä¿å­˜</button>

      <div style="margin-top: 32px; border-top: 1px dashed var(--muted); padding-top: 16px;">
        <h3 style="font-size: 14px; color: var(--muted); margin:0 0 10px;">ğŸ“œ ç›´è¿‘ã®æˆ¦ç¸¾</h3>
        <div id="historyList"></div>
        <div class="btn-row">
          <button class="sub-btn" id="btnCopy" type="button">CSVã‚³ãƒ”ãƒ¼</button>
          <button class="sub-btn" id="btnClear" type="button" style="background:transparent; color:var(--bad); border:1px solid var(--bad);">å…¨æ¶ˆå»</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const STORAGE_KEY = "oji_exe_v54_logs";
  const MAX_HORSES = 18;
  const STEP_COUNT = 5;

  const state = {
    step: 1,
    condition: "dry", // dry | wet
    flow: "mid",      // few | mid | many
    horses: Array.from({length: MAX_HORSES}, (_, i) => i + 1),
    step1Out: [],
    step2Out: [],
    tag58: [],        // 5ã€œ8ç•ªæ‰‹æƒ³å®š
    discountA: [],    // å†…æ Ã—å…ˆè¡Œä¸å¯ï¼ˆ5ã€œ8æƒ³å®šï¼‰
    restMid: [],      // ä¼‘ã¿æ˜ã‘9ã€œ20é€±ï¼ˆå‰²å¼•Bï¼‰
    restLong: [],     // ä¼‘ã¿æ˜ã‘21é€±ä»¥ä¸Šï¼ˆå‰²å¼•Cï¼‰
    scores: {},
    best: null,
    scoringBound: false
  };

  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  const els = {
    cards: $$(".card"),
    dots: $$(".step-dot"),

    raceDate: $("#raceDate"),
    track: $("#track"),
    surface: $("#surface"),
    dist: $("#dist"),
    raceNo: $("#raceNo"),
    raceName: $("#raceName"),
    risk: $("#risk"),
    raceBadge: $("#raceBadge"),

    condDry: $("#condDry"),
    condWet: $("#condWet"),

    flowFew: $("#flowFew"),
    flowMid: $("#flowMid"),
    flowMany: $("#flowMany"),

    noteStep1: $("#noteStep1"),
    noteStep2: $("#noteStep2"),
    noteFlowEffect: $("#noteFlowEffect"),
    noteScoringRule: $("#noteScoringRule"),

    grid1: $("#grid1"),
    grid2: $("#grid2"),
    gridTag58: $("#gridTag58"),
    gridDiscountA: $("#gridDiscountA"),
    gridRestMid: $("#gridRestMid"),
    gridRestLong: $("#gridRestLong"),

    count1: $("#count1"),
    count2: $("#count2"),

    scoringArea: $("#scoringArea"),
    resultDisplay: $("#resultDisplay"),
    historyList: $("#historyList"),

    btnStart: $("#btnStart"),
    btnToStep2: $("#btnToStep2"),
    btnToScore: $("#btnToScore"),
    btnSkipAll: $("#btnSkipAll"),
    btnCalc: $("#btnCalc"),

    btnFinalBuy: $("#btnFinalBuy"),
    btnFinalSkip: $("#btnFinalSkip"),
    btnCopy: $("#btnCopy"),
    btnClear: $("#btnClear"),
    btnRestart: $("#btnRestart"),
  };

  // ---------- Storage ----------
  function safeParseJSON(str, fallback){ try { return JSON.parse(str); } catch { return fallback; } }
  function getLogs(){ return safeParseJSON(localStorage.getItem(STORAGE_KEY) || "[]", []); }
  function setLogs(logs){ localStorage.setItem(STORAGE_KEY, JSON.stringify(logs)); }
  function pushLog(entry){ const logs = getLogs(); logs.push(entry); setLogs(logs); }
  // ---------- Export CSV ----------
  function csvEscape(v){
    if (v === null || v === undefined) return "";
    const s = String(v);
    const needsQuote = /[",\n\r]/.test(s);
    const escaped = s.replace(/"/g, '""');
    return needsQuote ? `"${escaped}"` : escaped;
  }

  function downloadTextAsFile(filename, text){
    const blob = new Blob([text], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportLogsToCsv(){
    const logs = getLogs();
    if (!Array.isArray(logs) || logs.length === 0){
      alert("ãƒ­ã‚°ãŒç©ºã ã‚ˆã€‚ã¾ãšBUY/è¦‹é€ã‚Šä¿å­˜ã—ã¦ã­ã€‚");
      return;
    }

    const cols = [
      "date","track","surface","dist","cond","flow","raceNo","race",
      "horse","score","dec","risk",
      "tag58","discountA","flowDiscount","restMid","restLong",
      "at"
    ];

    const header = cols.map(csvEscape).join(",");
    const lines = logs.map(row => cols.map(c => csvEscape(row?.[c])).join(","));
    const csv = [header, ...lines].join("\r\n");

    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    downloadTextAsFile(`oji_exe_logs_${y}-${m}-${day}.csv`, csv);
  }

  // ---------- Utils ----------
  function toggleArray(arr, val){ return arr.includes(val) ? arr.filter(x => x !== val) : [...arr, val]; }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
  function survivors(){
    return state.horses.filter(h => !state.step1Out.includes(h) && !state.step2Out.includes(h));
  }
  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }
  function scrollTopInstant(){
    try { window.scrollTo({ top: 0, left: 0, behavior: "smooth" }); window.scrollTo({ top: 0, left: 0 }); }
    catch { window.scrollTo(0,0); }
  }

  function getRaceMeta(){
    const date = (els.raceDate?.value || "").trim();
    const raceNo = Number(els.raceNo?.value || 0) || null;
    const raceName = (els.raceName?.value || "").trim();
    const track = (els.track?.value || "æ±äº¬").trim();
    const surface = (els.surface?.value || "ãƒ€").trim();
    const dist = Number(els.dist?.value || 1400) || 1400;
    const condition = state.condition;
    const flow = state.flow;
    return { date, raceNo, raceName, track, surface, dist, condition, flow };
  }

  function updateBadge(){
    const meta = getRaceMeta();
    const d = meta.date || "æœªè¨­å®š";
    const r = meta.raceNo ? `${meta.raceNo}R` : "--R";
    const n = meta.raceName ? ` ${meta.raceName}` : "";
    const cond = meta.condition === "wet" ? "é‡ä¸" : "è‰¯ç¨";
    const flow = meta.flow === "few" ? "æµã‚Œ:å°‘" : meta.flow === "many" ? "æµã‚Œ:å¤š" : "æµã‚Œ:æ™®";
    els.raceBadge.textContent = `${d} / ${meta.track}${meta.surface}${meta.dist}(${cond}) / ${r}${n} / ${flow}`;
    els.btnStart.disabled = !meta.date;
  }

  function updateStep1Note(){
    els.noteStep1.innerHTML =
      "<b>ã€STEP1ï¼ˆé©æ€§ï¼‰ã€‘</b><br>" +
      "ãƒ»è·é›¢/èŠãƒ€/ã‚³ãƒ¼ã‚¹ãŒåˆã‚ãªã„é¦¬ã‚’æ¶ˆã™ã€‚<br>" +
      "ãƒ»åˆæŒ‘æˆ¦ã¯æ ¹æ‹ ãŒè–„ã‘ã‚Œã°æ¶ˆã—ã€‚<br>" +
      "<span style='color:var(--muted)'>â€»è„šè³ªï¼ˆ4è§’ä½ç½®ï¼‰ã¯STEP2ã€‚</span>";
  }

  function updateStep2Note(){
    els.noteStep2.innerHTML =
      "<b>ã€STEP2ï¼ˆå±•é–‹ï¼‰ã€‘</b><br>" +
      "ãƒ»ã€Œ4è§’9ç•ªæ‰‹ä»¥é™ãŒãƒ‡ãƒ•ã‚©ã€ã€Œå‡ºé…ã‚Œç™–ã€ã€Œæ¥µç«¯ãªè¿½è¾¼ã€ã¯æ¶ˆã™ã€‚<br>" +
      "ãƒ»5ã€œ8ç•ªæ‰‹ã®æ‰±ã„ã¯ã€æµã‚Œï¼ˆå‰ã«è¡ŒããŸã„é¦¬ã®æ•°ï¼‰ã§å¤‰ãˆã‚‹ã€‚";
  }

  function setCond(c){
    state.condition = c;
    els.condDry.classList.toggle("active", c === "dry");
    els.condWet.classList.toggle("active", c === "wet");
    updateBadge();
  }

  function setFlow(f){
    state.flow = f;
    els.flowFew.classList.toggle("active", f === "few");
    els.flowMid.classList.toggle("active", f === "mid");
    els.flowMany.classList.toggle("active", f === "many");
    updateFlowEffectNote();

    // åæ˜ ï¼šè¡¨ç¤ºæ›´æ–°
    renderTag58Grid();
    renderDiscountAGrid();
    renderRestMidGrid();
    renderRestLongGrid();
    updateBadge();
  }

  // ----- ãƒ«ãƒ¼ãƒ« -----
  function isFlowDiscountHorse(num){
    const tagged = state.tag58.includes(num);
    if (!tagged) return false;
    return state.flow !== "mid"; // æ™®é€šä»¥å¤–ã¯â—ä¸å¯
  }
  function isRestMidHorse(num){ return state.restMid.includes(num); }
  function isRestLongHorse(num){ return state.restLong.includes(num); }

  function isAnyDiscount(num){
    return (
      state.discountA.includes(num) ||
      isFlowDiscountHorse(num) ||
      isRestMidHorse(num) ||
      isRestLongHorse(num)
    );
  }

  function updateFlowEffectNote(){
    const msg = (() => {
      if (state.flow === "few") return "å°‘ãªã„ï¼ˆ1ã€œ2ï¼‰â†’ å‰æ®‹ã‚Šã€‚<b>5ã€œ8ã‚¿ã‚°ã¯å±é™º</b>ï¼ˆâ—ä¸å¯ï¼‰ã€‚";
      if (state.flow === "many") return "å¤šã„ï¼ˆ6ã€œï¼‰â†’ å‰å´©ã‚Œã€‚<b>5ã€œ8ã‚¿ã‚°ã¯å·»ãæ·»ãˆ</b>ï¼ˆâ—ä¸å¯ï¼‰ã€‚";
      return "æ™®é€šï¼ˆ3ã€œ5ï¼‰â†’ 5ã€œ8ãŒç‹™ã„ã‚¾ãƒ¼ãƒ³ã€‚<b>5ã€œ8ã‚¿ã‚°ã‚‚â—OK</b>ã€‚";
    })();
    els.noteFlowEffect.innerHTML = `<b>åæ˜ ï¼š</b>${msg}`;
  }

  // ---------- Step UI ----------
  function setStep(nextStep){
    const step = Math.min(Math.max(1, Number(nextStep) || 1), STEP_COUNT);
    state.step = step;

    els.cards.forEach(card => {
      const isTarget = card.id === `p${step}`;
      card.setAttribute("aria-hidden", String(!isTarget));
    });
    els.dots.forEach((d, i) => d.classList.toggle("active", i < step));
    scrollTopInstant();

    if (step === 2) {
      updateStep1Note();
      renderGrid(1);
      updateCount(1);
    }
    if (step === 3) {
      updateStep2Note();
      updateFlowEffectNote();
      renderGrid(2);
      renderTag58Grid();
      renderDiscountAGrid();
      renderRestMidGrid();
      renderRestLongGrid();
      updateCount(2);
    }
    if (step === 5) renderHistory();
  }

  function renderGrid(stepNum){
    const grid = stepNum === 1 ? els.grid1 : els.grid2;
    if (!grid) return;

    grid.innerHTML = "";

    const list = (stepNum === 1)
      ? state.horses
      : state.horses.filter(h => !state.step1Out.includes(h));

    const frag = document.createDocumentFragment();

    list.forEach(num => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "horse-btn";
      btn.textContent = String(num);

      const isOut = (stepNum === 1) ? state.step1Out.includes(num) : state.step2Out.includes(num);
      btn.classList.toggle("eliminated", isOut);
      btn.setAttribute("aria-pressed", String(isOut));

      btn.addEventListener("click", () => {
        if (stepNum === 1) {
          state.step1Out = toggleArray(state.step1Out, num);
          if (state.step1Out.includes(num)) {
            // STEP1ã§æ¶ˆã—ãŸã‚‰ä»–ã®ã‚¿ã‚°ã‚‚æƒé™¤
            state.step2Out = state.step2Out.filter(x => x !== num);
            state.tag58 = state.tag58.filter(x => x !== num);
            state.discountA = state.discountA.filter(x => x !== num);
            state.restMid = state.restMid.filter(x => x !== num);
            state.restLong = state.restLong.filter(x => x !== num);
          }
        } else {
          state.step2Out = toggleArray(state.step2Out, num);
          if (state.step2Out.includes(num)) {
            state.tag58 = state.tag58.filter(x => x !== num);
            state.discountA = state.discountA.filter(x => x !== num);
            state.restMid = state.restMid.filter(x => x !== num);
            state.restLong = state.restLong.filter(x => x !== num);
          }
        }

        renderGrid(stepNum);
        renderTag58Grid();
        renderDiscountAGrid();
        renderRestMidGrid();
        renderRestLongGrid();
        updateCount(stepNum);
      });

      frag.appendChild(btn);
    });

    grid.appendChild(frag);
  }

  function renderTag58Grid(){
    const grid = els.gridTag58;
    if (!grid) return;
    grid.innerHTML = "";

    const list = survivors();
    if (list.length === 0) {
      grid.innerHTML = `<div class="note" style="grid-column:1/-1; margin:0;">ç”Ÿå­˜é¦¬ãŒã„ã¾ã›ã‚“</div>`;
      return;
    }

    const frag = document.createDocumentFragment();
    list.forEach(num => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "horse-btn";
      btn.textContent = String(num);

      const tagged = state.tag58.includes(num);
      const flowDisc = isFlowDiscountHorse(num);

      if (tagged) btn.classList.add("tag58");
      if (flowDisc) btn.classList.add("flowDiscount");

      btn.setAttribute("aria-pressed", String(tagged));
      btn.addEventListener("click", () => {
        state.tag58 = toggleArray(state.tag58, num);
        renderTag58Grid();
        renderDiscountAGrid(); // è¦‹ãŸç›®åˆã‚ã›
      });

      frag.appendChild(btn);
    });

    grid.appendChild(frag);
  }

  function renderDiscountAGrid(){
    const grid = els.gridDiscountA;
    if (!grid) return;
    grid.innerHTML = "";

    const list = survivors();
    if (list.length === 0) {
      grid.innerHTML = `<div class="note" style="grid-column:1/-1; margin:0;">ç”Ÿå­˜é¦¬ãŒã„ã¾ã›ã‚“</div>`;
      return;
    }

    const frag = document.createDocumentFragment();
    list.forEach(num => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "horse-btn";
      btn.textContent = String(num);

      const discA = state.discountA.includes(num);
      const flowDisc = isFlowDiscountHorse(num);

      if (discA) btn.classList.add("discountA");
      if (flowDisc) btn.classList.add("flowDiscount");

      btn.setAttribute("aria-pressed", String(discA));
      btn.addEventListener("click", () => {
        state.discountA = toggleArray(state.discountA, num);
        renderDiscountAGrid();
      });

      frag.appendChild(btn);
    });

    grid.appendChild(frag);
  }

  // â˜…ä¼‘ã¿æ˜ã‘B
  function renderRestMidGrid(){
    const grid = els.gridRestMid;
    if (!grid) return;
    grid.innerHTML = "";

    const list = survivors();
    if (list.length === 0) {
      grid.innerHTML = `<div class="note" style="grid-column:1/-1; margin:0;">ç”Ÿå­˜é¦¬ãŒã„ã¾ã›ã‚“</div>`;
      return;
    }

    const frag = document.createDocumentFragment();
    list.forEach(num => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "horse-btn";
      btn.textContent = String(num);

      const on = state.restMid.includes(num);
      if (on) btn.classList.add("flowDiscount"); // èµ¤ç³»ï¼ˆâ—ä¸å¯ã®æ³¨æ„ï¼‰

      btn.setAttribute("aria-pressed", String(on));
      btn.addEventListener("click", () => {
        state.restMid = toggleArray(state.restMid, num);
        if (state.restMid.includes(num)) state.restLong = state.restLong.filter(x => x !== num);
        renderRestMidGrid();
        renderRestLongGrid();
      });

      frag.appendChild(btn);
    });

    grid.appendChild(frag);
  }

  // â˜…ä¼‘ã¿æ˜ã‘C
  function renderRestLongGrid(){
    const grid = els.gridRestLong;
    if (!grid) return;
    grid.innerHTML = "";

    const list = survivors();
    if (list.length === 0) {
      grid.innerHTML = `<div class="note" style="grid-column:1/-1; margin:0;">ç”Ÿå­˜é¦¬ãŒã„ã¾ã›ã‚“</div>`;
      return;
    }

    const frag = document.createDocumentFragment();
    list.forEach(num => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "horse-btn";
      btn.textContent = String(num);

      const on = state.restLong.includes(num);
      if (on) btn.classList.add("flowDiscount");

      btn.setAttribute("aria-pressed", String(on));
      btn.addEventListener("click", () => {
        state.restLong = toggleArray(state.restLong, num);
        if (state.restLong.includes(num)) state.restMid = state.restMid.filter(x => x !== num);
        renderRestLongGrid();
        renderRestMidGrid();
      });

      frag.appendChild(btn);
    });

    grid.appendChild(frag);
  }

  function updateCount(stepNum){
    const after1 = MAX_HORSES - state.step1Out.length;
    const after2 = after1 - state.step2Out.length;

    if (stepNum === 1) {
      els.count1.textContent = `ç”Ÿå­˜æ•°: ${after1}é ­`;
    } else {
      els.count2.textContent = `ç”Ÿå­˜æ•°: ${after2}é ­`;
      els.btnToScore.disabled = (after2 === 0 || after2 > 6);
    }
  }

  // ---------- Scoring ----------
  function setupScoring(){
    const list = survivors();
    if (list.length === 0) {
      alert("ç”Ÿå­˜é¦¬ãŒ0é ­ã§ã™ã€‚è¦‹é€ã‚Šã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    state.scores = {};
    els.scoringArea.innerHTML = "";

    els.noteScoringRule.innerHTML =
      "ç”Ÿå­˜é¦¬ã®ã€Œå®‰å®šæ„Ÿã€ã‚’ä»˜ã‘ã‚‹ã€‚<br>" +
      "ä¸ŠãŒã‚Šå›æ•°ï¼ˆè¿‘3èµ°ï¼‰ã¯ã€Œä¸ŠãŒã‚Šé †ä½3ä½ä»¥å†…ã€ã®å›æ•°ï¼ˆ0ã€œ3ï¼‰ã€‚â€»åŒç‚¹ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚¯å°‚ç”¨ã€‚<br>" +
      "<b>å‰²å¼•ï¼ˆA / æµã‚Œ / ä¼‘ã¿æ˜ã‘B/Cï¼‰</b>ãŒä»˜ã„ãŸé¦¬ã¯ã€Œâ—ä¸å¯ï¼ˆâ—‹ã¾ã§ï¼‰ã€ã€‚";

    const frag = document.createDocumentFragment();

    list.forEach(num => {
      state.scores[num] = { p1: 1, p2: 0 };

      const disc = isAnyDiscount(num);
      const badges = [
        state.tag58.includes(num) ? "5ã€œ8" : null,
        state.discountA.includes(num) ? "å‰²å¼•A" : null,
        isFlowDiscountHorse(num) ? "æµã‚Œå‰²å¼•" : null,
        state.restMid.includes(num) ? "ä¼‘ã¿æ˜ã‘B" : null,
        state.restLong.includes(num) ? "ä¼‘ã¿æ˜ã‘C" : null,
      ].filter(Boolean);

      const box = document.createElement("div");
      box.className = "res-box";
      box.dataset.horse = String(num);

      box.innerHTML = `
        <div style="font-weight:bold; color:var(--accent);">
          é¦¬ç•ª: ${num}
          ${badges.length ? `<span style="color:var(--muted); font-size:12px;">ï¼ˆ${badges.join(" / ")}ï¼‰</span>` : ""}
        </div>

        <label>å®‰å®šæ„Ÿï¼ˆ0.5ç§’å·®å†…ã‚’ç¶™ç¶šï¼Ÿï¼‰</label>
        <div class="btn-group" data-p="p1">
          <button class="tgl-btn" type="button" data-v="2" aria-pressed="false" ${disc ? "disabled" : ""}>â— å …å®Ÿ</button>
          <button class="tgl-btn active" type="button" data-v="1" aria-pressed="true">â—‹ ä¸¦</button>
          <button class="tgl-btn" type="button" data-v="0" aria-pressed="false">â–³ ä¸å®‰</button>
        </div>

        <label>ä¸ŠãŒã‚Šï¼ˆè¿‘3èµ°ï¼šä¸ŠãŒã‚Šé †ä½3ä½ä»¥å†…ã®å›æ•°ï¼‰â€»åŒç‚¹å°‚ç”¨</label>
        <div class="btn-group" data-p="p2">
          <button class="tgl-btn active" type="button" data-v="0" aria-pressed="true">0å›</button>
          <button class="tgl-btn" type="button" data-v="1" aria-pressed="false">1å›</button>
          <button class="tgl-btn" type="button" data-v="2" aria-pressed="false">2å›</button>
          <button class="tgl-btn" type="button" data-v="3" aria-pressed="false">3å›</button>
        </div>
      `;

      frag.appendChild(box);
    });

    els.scoringArea.appendChild(frag);

    if (!state.scoringBound) {
      els.scoringArea.addEventListener("click", onScoringClick, { passive: true });
      state.scoringBound = true;
    }

    els.btnFinalBuy.disabled = true;
    setStep(4);
  }

  function onScoringClick(e){
    const btn = e.target.closest(".tgl-btn");
    if (!btn || btn.disabled) return;

    const group = btn.closest(".btn-group");
    const box = btn.closest(".res-box");
    if (!group || !box) return;

    const horse = Number(box.dataset.horse);
    const p = group.dataset.p;
    const v = Number(btn.dataset.v);
    if (!state.scores[horse]) return;

    // ä¿é™ºï¼šå‰²å¼•é¦¬ã¯â—ä¸å¯
    if (p === "p1" && v === 2 && isAnyDiscount(horse)) return;

    state.scores[horse][p] = v;

    group.querySelectorAll(".tgl-btn").forEach(x => {
      x.classList.remove("active");
      x.setAttribute("aria-pressed", "false");
    });
    btn.classList.add("active");
    btn.setAttribute("aria-pressed", "true");
  }

  function calcResult(){
    const keys = Object.keys(state.scores);
    if (keys.length === 0) { alert("æŸ»å®šå¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }

    const res = keys.map(n => ({
      num: Number(n),
      p1: (state.scores[n].p1 ?? 0),
      p2: (state.scores[n].p2 ?? 0),
      total: (state.scores[n].p1 ?? 0)
    })).sort((a,b) => (b.total - a.total) || (b.p2 - a.p2));

    const top = res[0];
    const second = res[1] || null;

    if (second && top.total === second.total && top.p2 === second.p2) {
      state.best = null;
      els.resultDisplay.innerHTML = `
        <div class="res-box">
          <div class="res-score" style="color:var(--warn);">åŒç‚¹</div>
          <div style="text-align:center; margin-bottom:10px;">
            é¦¬ç•ª ${top.num} ã¨ é¦¬ç•ª ${second.num} ãŒå®Œå…¨åŒç‚¹ã€‚<br>
            ï¼ˆå®‰å®šæ„ŸScore: ${top.total} / ä¸ŠãŒã‚Š3ä½å†…å›æ•°: ${top.p2}å›ï¼‰
          </div>
          <div class="btn-row" style="margin-top:8px;">
            <button class="sub-btn" type="button" id="btnPickA">é¦¬${top.num}ã«ã™ã‚‹</button>
            <button class="sub-btn" type="button" id="btnPickB">é¦¬${second.num}ã«ã™ã‚‹</button>
          </div>
          <button class="sub-btn" type="button"
            id="btnPickSkip"
            style="width:100%; margin-top:8px; background:transparent; color:var(--bad); border:1px solid var(--bad);">
            è¦‹é€ã‚Šã«ã™ã‚‹
          </button>
          <div id="pickStatus" class="note" style="margin-top:10px;">ã¾ã æœªé¸æŠï¼ˆBUYä¿å­˜ã¯ã§ããªã„ï¼‰</div>
        </div>
      `;
      els.btnFinalBuy.disabled = true;

      $("#btnPickA")?.addEventListener("click", () => {
        state.best = { num: top.num, total: top.total, p2: top.p2 };
        $("#pickStatus").textContent = `é¸æŠï¼šé¦¬ç•ª ${top.num}ï¼ˆåŒç‚¹ãƒ»æ‰‹å‹•æ±ºå®šï¼‰`;
        els.btnFinalBuy.disabled = false;
      });
      $("#btnPickB")?.addEventListener("click", () => {
        state.best = { num: second.num, total: second.total, p2: second.p2 };
        $("#pickStatus").textContent = `é¸æŠï¼šé¦¬ç•ª ${second.num}ï¼ˆåŒç‚¹ãƒ»æ‰‹å‹•æ±ºå®šï¼‰`;
        els.btnFinalBuy.disabled = false;
      });
      $("#btnPickSkip")?.addEventListener("click", () => saveFinal("SKIP"));

      setStep(5);
      return;
    }

    state.best = { num: top.num, total: top.total, p2: top.p2 };
    const usedTiebreak = !!(second && top.total === second.total && top.p2 !== second.p2);

    const badges = [
      state.tag58.includes(top.num) ? "5ã€œ8" : null,
      state.discountA.includes(top.num) ? "å‰²å¼•A" : null,
      isFlowDiscountHorse(top.num) ? "æµã‚Œå‰²å¼•" : null,
      state.restMid.includes(top.num) ? "ä¼‘ã¿æ˜ã‘B" : null,
      state.restLong.includes(top.num) ? "ä¼‘ã¿æ˜ã‘C" : null,
    ].filter(Boolean);

    els.resultDisplay.innerHTML = `
      <div class="res-box">
        <div class="res-score">é¦¬ç•ª ${top.num}</div>
        <div style="text-align:center">
          å®‰å®šæ„ŸScore: ${top.total}<br>
          ä¸ŠãŒã‚Š3ä½å†…ï¼ˆè¿‘3èµ°ï¼‰: ${top.p2}å›
          ${badges.length ? `<div class="note" style="margin-top:8px;">ã‚¿ã‚°/å‰²å¼•ï¼š${badges.join(" / ")}</div>` : ""}
          ${usedTiebreak ? `<div class="note" style="margin-top:8px;">åŒç‚¹ â†’ ä¸ŠãŒã‚Šå›æ•°ã§æ±ºç€</div>` : ""}
        </div>
      </div>
    `;

    els.btnFinalBuy.disabled = false;
    setStep(5);
  }

  // ---------- Save / History ----------
  function afterSaveUI(message){
    renderHistory();
    els.resultDisplay.insertAdjacentHTML("beforeend", `
      <div class="note" style="margin-top:10px;">âœ… ${escapeHtml(message)}<br>ã“ã®ã¾ã¾æˆ¦ç¸¾ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆã€Œæ–°ã—ã„äºˆæƒ³ã¸ã€ã§æœ€åˆã«æˆ»ã‚‹ï¼‰</div>
    `);
    scrollTopInstant();
  }

  function saveFinal(dec){
    const meta = getRaceMeta();
    const risk = (els.risk?.value || "").trim();
    const now = new Date().toISOString();

    if (!meta.date) { alert("æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚"); return; }
    if (!meta.raceNo) { alert("ãƒ¬ãƒ¼ã‚¹ç•ªå·ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚"); return; }

    if (dec === "BUY") {
      if (!state.best) { alert("ã¾ã çµè«–ãŒå‡ºã¦ã„ã¾ã›ã‚“ã€‚"); return; }
      pushLog({
        date: meta.date,
        track: meta.track, surface: meta.surface, dist: meta.dist,
        cond: meta.condition, flow: meta.flow,
        raceNo: meta.raceNo, race: meta.raceName,
        horse: state.best.num,
        score: state.best.total,
        dec: "BUY",
        risk,
        tag58: state.tag58.includes(state.best.num) ? 1 : 0,
        discountA: state.discountA.includes(state.best.num) ? 1 : 0,
        flowDiscount: isFlowDiscountHorse(state.best.num) ? 1 : 0,
        restMid: state.restMid.includes(state.best.num) ? 1 : 0,
        restLong: state.restLong.includes(state.best.num) ? 1 : 0,
        at: now
      });
      afterSaveUI("BUYã§ä¿å­˜ã—ã¾ã—ãŸ");
    } else {
      pushLog({
        date: meta.date,
        track: meta.track, surface: meta.surface, dist: meta.dist,
        cond: meta.condition, flow: meta.flow,
        raceNo: meta.raceNo, race: meta.raceName,
        horse: "-",
        score: null,
        dec: "SKIP",
        risk: risk || "USER_SKIP",
        tag58: 0, discountA: 0, flowDiscount: 0, restMid: 0, restLong: 0,
        at: now
      });
      afterSaveUI("è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸ");
    }

    els.btnFinalBuy.disabled = true;
  }

  function saveSkip(reason){
    const meta = getRaceMeta();
    const now = new Date().toISOString();
    if (!meta.date) { alert("æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚"); return; }
    if (!meta.raceNo) { alert("ãƒ¬ãƒ¼ã‚¹ç•ªå·ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚"); return; }

    pushLog({
      date: meta.date,
      track: meta.track, surface: meta.surface, dist: meta.dist,
      cond: meta.condition, flow: meta.flow,
      raceNo: meta.raceNo, race: meta.raceName,
      horse: "-",
      score: null,
      dec: "SKIP",
      risk: reason,
      tag58: 0, discountA: 0, flowDiscount: 0, restMid: 0, restLong: 0,
      at: now
    });

    setStep(5);
    els.resultDisplay.innerHTML = `
      <div class="res-box">
        <div class="res-score" style="color:var(--bad);">è¦‹é€ã‚Š</div>
        <div style="text-align:center">ç†ç”±: ${escapeHtml(reason)}</div>
      </div>
    `;
    afterSaveUI("å…¨æ»…ãƒ»è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸ");
    els.btnFinalBuy.disabled = true;
  }

  function renderHistory(){
    const all = getLogs();
    const list = els.historyList;
    if (!list) return;

    if (all.length === 0) {
      list.innerHTML = "<div class='note'>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>";
      return;
    }

    list.innerHTML = [...all].reverse().slice(0, 10).map(l => {
      const date = l.date ? escapeHtml(l.date) : "----/--/--";
      const place = `${escapeHtml(l.track || "?")}${escapeHtml(l.surface || "?")}${escapeHtml(l.dist || "?")}`;
      const cond = l.cond ? (l.cond === "wet" ? "é‡ä¸" : "è‰¯ç¨") : "-";
      const flow = l.flow ? (l.flow === "few" ? "å°‘" : l.flow === "many" ? "å¤š" : "æ™®") : "-";
      const r = l.raceNo ? `${escapeHtml(l.raceNo)}R` : "--R";
      const raceName = escapeHtml(l.race || "ä¸æ˜");
      const horse = escapeHtml(l.horse);
      const dec = escapeHtml(l.dec || "");
      const score = (l.score != null) ? ` (å®‰å®šæ„Ÿ: ${escapeHtml(l.score)})` : "";
      const risk = escapeHtml(l.risk || "è¨˜è¼‰ãªã—");
      const bar = (l.dec === "BUY") ? "var(--good)" : "var(--muted)";

      const tags = [
        l.tag58 ? "5ã€œ8" : null,
        l.discountA ? "å‰²å¼•A" : null,
        l.flowDiscount ? "æµã‚Œå‰²å¼•" : null,
        l.restMid ? "ä¼‘B" : null,
        l.restLong ? "ä¼‘C" : null,
      ].filter(Boolean);

      const tagStr = tags.length ? ` / ${tags.join(",")}` : "";

      return `
        <div style="background:#1e293b; padding:10px; border-radius:8px; margin-bottom:8px; font-size:12px; border-left:4px solid ${bar}">
          <b>${date} ${place}(${cond}) æµã‚Œ:${flow} ${r} ${raceName}</b> [${dec}] é¦¬${horse}${score}${tagStr}<br>
          <span style="color:var(--muted)">ãƒªã‚¹ã‚¯: ${risk}</span>
        </div>
      `;
    }).join("");
  }

  async function copyLog(){
    const raw = localStorage.getItem(STORAGE_KEY) || "[]";
    try {
      await navigator.clipboard.writeText(raw);
      alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆExcelç­‰ã«è²¼ã‚Šä»˜ã‘å¯èƒ½ï¼‰");
    } catch {
      const ta = document.createElement("textarea");
      ta.value = raw;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      document.execCommand("copy");
      ta.remove();
      alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆäº’æ›ãƒ¢ãƒ¼ãƒ‰ï¼‰");
    }
  }

  function clearLog(){
    if (confirm("å…¨ã¦ã®å±¥æ­´ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
      alert("æ¶ˆå»ã—ã¾ã—ãŸ");
    }
  }

  function resetForNew(){
    state.step = 1;
    state.step1Out = [];
    state.step2Out = [];
    state.tag58 = [];
    state.discountA = [];
    state.restMid = [];
    state.restLong = [];
    state.scores = {};
    state.best = null;

    if (els.risk) els.risk.value = "";
    if (els.scoringArea) els.scoringArea.innerHTML = "";
    if (els.resultDisplay) els.resultDisplay.innerHTML = "";
    els.btnFinalBuy.disabled = true;

    setStep(1);
    renderGrid(1);
    renderGrid(2);
    renderTag58Grid();
    renderDiscountAGrid();
    renderRestMidGrid();
    renderRestLongGrid();
    updateCount(1);
    updateCount(2);
  }

  // ---------- Events ----------
  function bindEvents(){
    els.condDry?.addEventListener("click", () => setCond("dry"));
    els.condWet?.addEventListener("click", () => setCond("wet"));

    els.flowFew?.addEventListener("click", () => setFlow("few"));
    els.flowMid?.addEventListener("click", () => setFlow("mid"));
    els.flowMany?.addEventListener("click", () => setFlow("many"));

    els.raceDate?.addEventListener("change", updateBadge);
    els.track?.addEventListener("change", updateBadge);
    els.surface?.addEventListener("change", updateBadge);
    els.dist?.addEventListener("change", updateBadge);
    els.raceNo?.addEventListener("change", updateBadge);
    els.raceName?.addEventListener("input", updateBadge);

    els.btnStart?.addEventListener("click", () => setStep(2));
    els.btnToStep2?.addEventListener("click", () => setStep(3));

    els.btnToScore?.addEventListener("click", setupScoring);
    els.btnSkipAll?.addEventListener("click", () => saveSkip("NO_SURVIVORS"));

    els.btnCalc?.addEventListener("click", calcResult);

    els.btnFinalBuy?.addEventListener("click", () => saveFinal("BUY"));
    els.btnFinalSkip?.addEventListener("click", () => saveFinal("SKIP"));

    els.btnCopy?.addEventListener("click", copyLog);
    els.btnClear?.addEventListener("click", clearLog);

    els.btnRestart?.addEventListener("click", resetForNew);

    els.raceName?.addEventListener("keydown", (e) => { if (e.key === "Enter") setStep(2); });
    $("#btnExportCsv")?.addEventListener("click", exportLogsToCsv);
  }

  // ---------- Init ----------
  function init(){
    bindEvents();

    if (els.raceDate && !els.raceDate.value) els.raceDate.value = todayISO();
    if (els.raceNo && !els.raceNo.value) els.raceNo.value = "1";

    els.btnFinalBuy.disabled = true;

    updateStep1Note();
    updateStep2Note();
    setCond("dry");
    setFlow("mid");

    updateBadge();
    setStep(1);

    renderGrid(1);
    renderGrid(2);
    renderTag58Grid();
    renderDiscountAGrid();
    renderRestMidGrid();
    renderRestLongGrid();
    renderHistory();
  }

  window.addEventListener("DOMContentLoaded", init, { once: true });
})();
</script>
</body>
</html>
