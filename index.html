<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŠã˜.exeï¼ˆç«¶é¦¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2f;
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --muted2:rgba(234,240,255,.55);
      --good:#38d981;
      --warn:#ffb020;
      --bad:#ff5d73;
      --btn:#e9f0ff;
      --btnText:#0c1220;
      --radius:16px;
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans:-apple-system, system-ui, "Hiragino Sans", "Noto Sans JP", sans-serif;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(100,140,255,.18), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(255,120,170,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:820px; margin:0 auto; padding:24px 16px 40px; }
    .header{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:22px;
      padding:18px 18px 14px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
    }
    .title{ font-weight:900; font-size:22px; letter-spacing:.2px; }
    .sub{ margin-top:6px; color:var(--muted); line-height:1.55; }
    .chips{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .chip{
      border:1px solid var(--line);
      color:var(--muted);
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      font-size:13px;
      white-space:nowrap;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px;
      margin:14px 0;
    }
    .card h2{ margin:0 0 10px; font-size:18px; letter-spacing:.2px; }
    .note{ color:var(--muted); font-size:13px; line-height:1.55; }
    .small{ font-size:12px; color:var(--muted2); line-height:1.55; }
    .mono{ font-family:var(--mono); }
    .hr{ height:1px; background:var(--line); margin:14px 0; }

    label{ display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(8,12,24,.55);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(234,240,255,.35); }

    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .col{ flex:1; min-width:180px; }

    .btnRow{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:none;
      border-radius:16px;
      padding:14px 14px;
      font-weight:900;
      cursor:pointer;
    }
    button.primary{ background:var(--btn); color:var(--btnText); flex:1; min-width:210px; }
    button.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      flex:1; min-width:210px;
    }
    button.danger{
      background:rgba(255,93,115,.12);
      border:1px solid rgba(255,93,115,.35);
      color:#ffd3da;
      flex:1; min-width:210px;
    }
    button:disabled{ opacity:.45; cursor:not-allowed; filter:saturate(.6); }

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--line);
      border-radius:999px; background:rgba(255,255,255,.03);
      font-size:12px; color:var(--muted);
      margin-right:8px; margin-bottom:8px;
    }

    .qbox{
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      background: rgba(0,0,0,.15);
      margin-top:12px;
    }
    .qtitle{ font-weight:900; font-size:16px; margin:0 0 10px; }

    .choices{ display:flex; gap:10px; flex-wrap:wrap; }
    .choice{
      flex:1; min-width:140px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      font-weight:900;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .choice.on{
      background:rgba(233,240,255,.92);
      color:#0b1220;
      border-color:rgba(233,240,255,.92);
    }
    .choice.bad.on{
      background:rgba(255,93,115,.20);
      color:#ffd3da;
      border-color:rgba(255,93,115,.45);
    }

    /* STEP4 cards */
    .resultCard{
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      background: rgba(255,255,255,.05);
    }
    .resultCard.good{ border-color: rgba(56,217,129,.45); background: rgba(56,217,129,.10); }
    .resultCard.warn{ border-color: rgba(255,176,32,.45); background: rgba(255,176,32,.10); }
    .resultCard.bad{  border-color: rgba(255,93,115,.45); background: rgba(255,93,115,.10); }
    .big{ font-size:18px; font-weight:900; letter-spacing:.2px; }
    .ok{ color:var(--good); }
    .warnTxt{ color:var(--warn); }
    .ng{ color:var(--bad); }
    .pillRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }

    .footer{ margin-top:16px; color:var(--muted2); font-size:12px; line-height:1.55; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">ãŠã˜.exeï¼ˆç«¶é¦¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰</div>
      <div class="sub">
        ç›®çš„ï¼šè¿·ã‚ãªã„ï¼æ„Ÿæƒ…ã§è²·ã‚ãªã„ï¼æ±ºã‚ãŸæ‰‹é †é€šã‚Šã«å‹•ã<br>
        â€»ãƒ­ã‚°ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰ã«ã ã‘ä¿å­˜ã€‚å¤–ã«ã¯é€ã‚‰ã‚Œãªã„ã€‚
      </div>
      <div class="chips">
        <div class="chip">è¤‡å‹1ç‚¹</div>
        <div class="chip">1R 500å††</div>
        <div class="chip">æœ€å¤§3ãƒ¬ãƒ¼ã‚¹/æ—¥</div>
        <div class="chip">åˆè¨€è‘‰ï¼šå½“ã¦ã«ã„ããªã€å£Šã‚Œã‚‹ãª</div>
      </div>
    </div>
    <div style="margin-top:12px;">
  <a href="review.html" style="color:rgba(234,240,255,.92); font-weight:900; text-decoration:none;">
    ğŸ“˜ ä»Šæ—¥ã®é¦¬åˆ¸æŒ¯ã‚Šè¿”ã‚Šï¼ˆreviewï¼‰
  </a>
</div>

    <!-- å…¥å£ï¼šãƒ¬ãƒ¼ã‚¹å›ºå®š -->
    <div class="card" id="cardRace">
      <h2>å…¥å£ï½œãƒ¬ãƒ¼ã‚¹ã‚’å›ºå®šï¼ˆæˆ»ã‚‰ãªã„ï¼‰</h2>
      <div class="note">ã“ã“ã§ã€Œä»Šæ—¥ã©ã®ãƒ¬ãƒ¼ã‚¹ã‚’å¯¾è±¡ã«ã™ã‚‹ã‹ã€ã‚’å›ºå®šã—ã¾ã™ã€‚ã“ã®å…ˆã¯æˆ»ã£ã¦å¤‰æ›´ã—ã¾ã›ã‚“ã€‚</div>

      <div class="row">
        <div class="col">
          <label>æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰</label>
          <input id="date" type="date" />
        </div>
        <div class="col">
          <label>ç«¶é¦¬å ´</label>
          <select id="track">
            <option value="ä¸­å±±">ä¸­å±±</option>
            <option value="æ±äº¬">æ±äº¬</option>
            <option value="äº¬éƒ½">äº¬éƒ½</option>
            <option value="é˜ªç¥">é˜ªç¥</option>
            <option value="ä¸­äº¬">ä¸­äº¬</option>
            <option value="æœ­å¹Œ">æœ­å¹Œ</option>
            <option value="å‡½é¤¨">å‡½é¤¨</option>
            <option value="ç¦å³¶">ç¦å³¶</option>
            <option value="æ–°æ½Ÿ">æ–°æ½Ÿ</option>
            <option value="å°å€‰">å°å€‰</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="col">
          <label>ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
          <select id="raceNo">
            <option value="1R">1R</option><option value="2R">2R</option><option value="3R">3R</option><option value="4R">4R</option>
            <option value="5R">5R</option><option value="6R">6R</option><option value="7R">7R</option><option value="8R">8R</option>
            <option value="9R">9R</option><option value="10R">10R</option><option value="11R">11R</option><option value="12R">12R</option>
          </select>
          <div class="small">â€»æ‰‹å…¥åŠ›ä¸å¯ã€‚å¿…ãšé¸æŠã€‚</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>ã‚¯ãƒ©ã‚¹ï¼ˆé¸æŠè‚¢ï¼‰</label>
          <select id="raceClass">
            <option value="G1">G1</option>
            <option value="G2">G2</option>
            <option value="G3">G3</option>
            <option value="OP/L">OP/L</option>
            <option value="3å‹">3å‹ã‚¯ãƒ©ã‚¹</option>
            <option value="2å‹">2å‹ã‚¯ãƒ©ã‚¹</option>
            <option value="1å‹">1å‹ã‚¯ãƒ©ã‚¹</option>
            <option value="æœªå‹åˆ©">æœªå‹åˆ©</option>
            <option value="æ–°é¦¬">æ–°é¦¬</option>
          </select>
        </div>

        <div class="col">
          <label>å¾—æ„æ¡ä»¶ï¼ˆã‚³ãƒ¼ã‚¹ï¼‰</label>
          <select id="course">
            <option value="ä¸­å±±ãƒ€1800">ä¸­å±±ãƒ€1800</option>
            <option value="æ±äº¬ãƒ€1600">æ±äº¬ãƒ€1600</option>
            <option value="æ±äº¬èŠ1400ï¼ˆåœæ­¢ä¸­ï¼‰">æ±äº¬èŠ1400ï¼ˆåœæ­¢ä¸­ï¼‰</option>
            <option value="é‡è³">é‡è³ï¼ˆG1ã€œG3ï¼‰</option>
            <option value="ãã®ä»–">ãã®ä»–ï¼ˆåŸºæœ¬è¦‹é€ã‚Šï¼‰</option>
          </select>
          <div class="small">â€»ã€Œæ±äº¬èŠ1400ã€ã¯ã„ã¾åœæ­¢æ‰±ã„ã€‚</div>
        </div>
      </div>

      <div class="qbox">
        <div class="qtitle">ã“ã®ãƒ¬ãƒ¼ã‚¹ï¼ˆè‡ªå‹•è¡¨ç¤ºï¼‰</div>
        <div id="raceSummary" class="note"></div>
        <div class="hr"></div>
        <div id="todayCounter" class="note"></div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep0">æ¬¡ã¸ï¼ˆSTEP0ã¸ï¼‰</button>
        <button class="danger" id="btnSkipToday">ä»Šæ—¥ã¯è¦‹é€ã‚‹ï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰</button>
      </div>

      <div class="footer">ã€Œä»Šæ—¥ã¯è¦‹é€ã‚‹ã€ã¯æ­£è§£ãƒ«ãƒ¼ãƒˆã€‚ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚‹æ–¹ãŒå›åç‡ãŒä¸ŠãŒã‚‹ã€‚</div>
    </div>

    <!-- STEP0 -->
    <div class="card" id="cardStep0" style="display:none;">
      <h2>STEP0ï½œå‰æç¢ºèªï¼ˆ10ç§’ï¼‰</h2>
      <div class="note">No ãŒ1ã¤ã§ã‚‚å‡ºãŸã‚‰ã€ãã®æ™‚ç‚¹ã§çµ‚äº†ï¼ˆä»Šæ—¥ã¯è¦‹é€ã‚Šï¼‰ã€‚</div>

      <div class="qbox">
        <div class="qtitle">Q1ï¼šä»Šæ—¥ã¯æœ€å¤§3ãƒ¬ãƒ¼ã‚¹ã¾ã§ã€ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚Œã‚‹ï¼Ÿ</div>
        <div class="choices">
          <div class="choice" data-q="s0q1" data-v="yes">ã¯ã„</div>
          <div class="choice bad" data-q="s0q1" data-v="no">ã„ã„ãˆ</div>
        </div>
      </div>

      <div class="qbox">
        <div class="qtitle">Q2ï¼šã“ã®ãƒ¬ãƒ¼ã‚¹ã« 500å††ã ã‘ ä½¿ãˆã‚‹ï¼Ÿï¼ˆå¢—ã‚„ã•ãªã„ï¼‰</div>
        <div class="choices">
          <div class="choice" data-q="s0q2" data-v="yes">ã¯ã„</div>
          <div class="choice bad" data-q="s0q2" data-v="no">ã„ã„ãˆ</div>
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep1">æ¬¡ã¸ï¼ˆSTEP1ã¸ï¼‰</button>
        <button class="secondary" id="btnBackToRace">æˆ»ã‚‹ï¼ˆãƒ¬ãƒ¼ã‚¹å›ºå®šã¸ï¼‰</button>
        <button class="danger" id="btnSkipFrom0">ä»Šå›ã¯è¦‹é€ã‚‹ï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰</button>
      </div>
    </div>

    <!-- STEP1 -->
    <div class="card" id="cardStep1" style="display:none;">
      <h2>STEP1ï½œå¯¾è±¡ãƒ¬ãƒ¼ã‚¹åˆ¤å®šï¼ˆå³æ–­ï¼‰</h2>
      <div class="note">ã€Œé‡è³ï¼ˆG1ã€œG3ï¼‰ã€ã¾ãŸã¯ã€Œå¾—æ„æ¡ä»¶ã€ãªã‚‰é€²ã‚€ã€‚ãã‚Œä»¥å¤–ã¯è¦‹é€ã‚Šã€‚</div>

      <div class="qbox">
        <div class="qtitle">Qï¼šã“ã®ãƒ¬ãƒ¼ã‚¹ã¯å¯¾è±¡ï¼Ÿ</div>
        <div id="step1Auto" class="note"></div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep2">æ¬¡ã¸ï¼ˆSTEP2ã¸ï¼‰</button>
        <button class="danger" id="btnSkipFrom1">å¯¾è±¡å¤– â†’ è¦‹é€ã‚Šï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰</button>
        <button class="secondary" id="btnBackTo0">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- STEP2 -->
    <div class="card" id="cardStep2" style="display:none;">
      <h2>STEP2ï½œå€™è£œé¦¬ã‚’æœ€å¤§3é ­ã¾ã§å‡ºã™ï¼ˆé¸æŠå¼ï¼‰</h2>
      <div class="note">
        äººæ°—ãƒ»ã‚ªãƒƒã‚ºã¯ã¾ã è¦‹ãªã„ã€‚<br>
        ã€Œã“ã®æ¡ä»¶ã§å¤‰ãªè² ã‘æ–¹ã—ã«ããã†ã€ãªé¦¬ã ã‘æ‹¾ã†ã€‚<br>
        <b>3é ­å‡ºãªã‘ã‚Œã°ã€ã“ã®æ™‚ç‚¹ã§è¦‹é€ã‚Šã‚‚æ­£è§£</b>ã€‚
      </div>

      <div class="qbox">
        <div class="qtitle">å€™è£œï¼ˆæœ€å¤§3é ­ï¼‰</div>

        <div class="row">
          <div class="col">
            <label>å€™è£œâ‘ ï¼ˆé¦¬ç•ªï¼‰</label>
            <select id="cand1"></select>
            <label>ç†ç”±ï¼ˆä»»æ„ï¼‰</label>
            <input id="candMemo1" placeholder="ä¾‹ï¼šå‰å—ã‘ã§ãã‚‹" />
          </div>
          <div class="col">
            <label>å€™è£œâ‘¡ï¼ˆé¦¬ç•ªï¼‰</label>
            <select id="cand2"></select>
            <label>ç†ç”±ï¼ˆä»»æ„ï¼‰</label>
            <input id="candMemo2" placeholder="ä¾‹ï¼šå´©ã‚Œã«ãã„" />
          </div>
          <div class="col">
            <label>å€™è£œâ‘¢ï¼ˆé¦¬ç•ªï¼‰</label>
            <select id="cand3"></select>
            <label>ç†ç”±ï¼ˆä»»æ„ï¼‰</label>
            <input id="candMemo3" placeholder="ä¾‹ï¼š4è§’ã„ãã†" />
          </div>
        </div>

        <div class="hr"></div>
        <div id="step2Hint" class="note"></div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep3">æ¬¡ã¸ï¼ˆSTEP3ã¸ï¼‰</button>
        <button class="danger" id="btnSkipFrom2">å€™è£œä¸è¶³ â†’ è¦‹é€ã‚Šï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰</button>
        <button class="secondary" id="btnBackTo1">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- STEP3 -->
    <div class="card" id="cardStep3" style="display:none;">
      <h2>STEP3ï½œä¸‰æœ¬æŸ±ãƒã‚§ãƒƒã‚¯ï¼ˆçŠ¶æ…‹é¸æŠå¼ï¼‰</h2>
      <div class="note">
        Yes/Noã¯ä½¿ã‚ãªã„ã€‚<br>
        â‘ â‘¡ã¯ã€Œå¼·ã•ï¼ˆ2/1/0ï¼‰ã€ã€â‘¢ã¯ã€Œæ¸›ç‚¹ï¼ˆ0/-0.5/-1ï¼‰ã€ã§æ©Ÿæ¢°çš„ã«ç‚¹æ•°åŒ–ã™ã‚‹ã€‚
      </div>

      <div class="qbox">
        <div class="qtitle">å€™è£œé¦¬</div>
        <div id="horseTags" class="note"></div>
        <div class="small">å…¨é¦¬ã®â‘ â‘¡â‘¢ã‚’é¸æŠã—çµ‚ãˆã‚‹ã¾ã§æ¬¡ã¸é€²ã‚ãªã„ã€‚</div>
      </div>

      <div id="step3Forms"></div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep4">æ¬¡ã¸ï¼ˆSTEP4 ç‚¹æ•°åŒ–ã¸ï¼‰</button>
        <button class="secondary" id="btnBackTo2">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- STEP4 -->
    <div class="card" id="cardStep4" style="display:none;">
      <h2>STEP4ï½œç‚¹æ•°åŒ–ï¼ˆè©³ç´°ã‚«ãƒ¼ãƒ‰å‹ï¼‰</h2>
      <div class="note">
        åˆè¨ˆç‚¹ãŒãƒˆãƒƒãƒ—ï¼æœ¬å‘½ã€‚<br>
        åŒç‚¹ã¯ â‘ â†’â‘¡â†’â‘¢ ã®é †ã§æ±ºã‚ã‚‹ã€‚ãã‚Œã§ã‚‚åŒç‚¹ãªã‚‰è¦‹é€ã‚Šã€‚<br>
        ãƒˆãƒƒãƒ—ãŒ <b>1.0ç‚¹æœªæº€</b> ã¯è¦‹é€ã‚Šæ¨å¥¨ã€‚
      </div>

      <div class="qbox">
        <div class="qtitle">çµè«–</div>
        <div id="step4Top"></div>
        <div id="step4TieMsg" class="note" style="margin-top:10px;"></div>
      </div>

      <div class="qbox">
        <div class="qtitle">å€™è£œï¼ˆå†…è¨³ï¼‰</div>
        <div id="step4Cards"></div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep5">æ¬¡ã¸ï¼ˆSTEP5 0ç•ªãƒã‚§ãƒƒã‚¯ã¸ï¼‰</button>
        <button class="danger" id="btnSkipFrom4">ä»Šå›ã¯è¦‹é€ã‚‹ï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰</button>
        <button class="secondary" id="btnBackTo3">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- STEP5 -->
    <div class="card" id="cardStep5" style="display:none;">
      <h2>STEP5ï½œ0ç•ªãƒã‚§ãƒƒã‚¯ï¼ˆæœ€çµ‚ãƒ–ãƒ¬ãƒ¼ã‚­ï¼‰</h2>
      <div class="note">ãƒ‘ãƒ‰ãƒƒã‚¯ã¯â€œã‚„ã‚‰ãªã„å‰æâ€ã§OKã€‚ä»£ã‚ã‚Šã«2å•ã ã‘å¿…é ˆã€‚</div>

      <div class="qbox">
        <div class="qtitle">Q1ï¼šé¦¬ä½“é‡ å‰èµ°æ¯” Â±12kgä»¥ä¸Š ã§ã™ã‹ï¼Ÿ</div>
        <div class="choices">
          <div class="choice" data-q="s5w" data-v="yes">ã¯ã„ï¼ˆÂ±12kgä»¥ä¸Šï¼‰</div>
          <div class="choice bad" data-q="s5w" data-v="no">ã„ã„ãˆï¼ˆÂ±11kgä»¥å†…ï¼‰</div>
        </div>
      </div>

      <div class="qbox">
        <div class="qtitle">Q2ï¼šç›´å‰æƒ…å ±ï¼ˆå–æ¶ˆãƒ»å¤§å¹…é¦¬å ´æ‚ªåŒ–ãƒ»ä¸å®‰ææ–™ãªã©ï¼‰ãŒå‡ºãŸï¼Ÿ</div>
        <div class="choices">
          <div class="choice" data-q="s5info" data-v="yes">ã¯ã„ï¼ˆä¸å®‰ã‚ã‚Šï¼‰</div>
          <div class="choice bad" data-q="s5info" data-v="no">ã„ã„ãˆï¼ˆãªã—ï¼‰</div>
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep6">æ¬¡ã¸ï¼ˆSTEP6 çµè«–ã¸ï¼‰</button>
        <button class="secondary" id="btnBackTo4">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- STEP6 -->
    <div class="card" id="cardStep6" style="display:none;">
      <h2>STEP6ï½œçµè«–ï¼ˆå›ºå®šæ–‡ï¼‰</h2>
      <div class="note">ã€Œãƒªã‚¹ã‚¯ï¼ˆè² ã‘ç­‹ï¼‰ã€ã¯1ã¤ã ã‘ã€‚æ›¸ã‘ãªã„ãªã‚‰è¦‹é€ã‚Šã§OKã€‚</div>

      <div class="qbox">
        <div class="qtitle">çµè«–</div>
        <div id="finalSummary" class="note"></div>
      </div>

      <label>ãƒªã‚¹ã‚¯ï¼ˆè² ã‘ç­‹ï¼‰â€»1ã¤ã ã‘</label>
      <input id="riskOne" placeholder="ä¾‹ï¼šå‰ãŒæ­¢ã¾ã‚‰ãªã„ï¼å¤–ã€…ã‚’å›ã£ã¦å·®ã•ã‚Œã‚‹ ãªã©" />

      <label>è¦‹é€ã‚Šæ¡ä»¶ï¼ˆç¢ºèªç”¨ï¼‰</label>
      <textarea id="skipCond" readonly></textarea>

      <div class="btnRow">
        <button class="primary" id="btnSaveBuy">BUYã§ä¿å­˜ï¼ˆãƒ­ã‚°ï¼‰</button>
        <button class="danger" id="btnSaveSkip">è¦‹é€ã‚Šã§ä¿å­˜ï¼ˆãƒ­ã‚°ï¼‰</button>
        <button class="secondary" id="btnBackTo5">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- LOG -->
    <div class="card" id="cardLog">
      <h2>ãƒ­ã‚°ï¼ˆCSVï¼‰</h2>
      <div class="note">ä¿å­˜å…ˆï¼šã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã€‚æ©Ÿç¨®å¤‰æ›´ã‚„ãƒ–ãƒ©ã‚¦ã‚¶å¤‰æ›´ã§æ¶ˆãˆã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚</div>
      <div class="hr"></div>

      <div class="btnRow">
        <button class="secondary" id="btnCopyCSV">CSVã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="secondary" id="btnDownloadCSV">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button class="danger" id="btnClearLog">ãƒ­ã‚°å…¨æ¶ˆã—</button>
      </div>

      <div class="hr"></div>
      <div class="small mono" id="logPreview"></div>
    </div>

    <div class="footer">è¿·ã£ãŸã‚‰è¦‹é€ã‚Šï¼ˆNo bet is a betï¼‰ã€‚é€”ä¸­ã§æˆ»ã‚‰ãªã„ã€‚æ„Ÿæƒ…ã‚’æŒŸã¾ãªã„ã€‚</div>
  </div>

<script>
(() => {
  // ====== Storage ======
  const KEY = "oji_keiba_logs_v3";
  const loadLogs = () => {
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  };
  const saveLogs = (logs) => localStorage.setItem(KEY, JSON.stringify(logs));

  // ====== Utils ======
  const todayISO = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  };
  const nowStr = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${dd} ${hh}:${mm}`;
  };

  const el = (id) => document.getElementById(id);
  const show = (id) => el(id).style.display = "";
  const hide = (id) => el(id).style.display = "none";

  const go = (cardId) => {
    ["cardRace","cardStep0","cardStep1","cardStep2","cardStep3","cardStep4","cardStep5","cardStep6"].forEach(hide);
    show(cardId);
    window.scrollTo({top:0, behavior:"smooth"});
    refreshLogUI();
  };

  // ====== Rules ======
  const isG = (cls) => ["G1","G2","G3"].includes(cls);
  const isTokyo1400Paused = (course) => course.startsWith("æ±äº¬èŠ1400");

  const isTargetRace = ({course, raceClass}) => {
    if (isG(raceClass)) return true;
    if (course === "ä¸­å±±ãƒ€1800") return true;
    if (course === "æ±äº¬ãƒ€1600") return true;
    if (isTokyo1400Paused(course)) return false; // åœæ­¢ä¸­
    if (course === "é‡è³") return true; // å®Ÿè³ªG1-3æƒ³å®š
    return false;
  };

  // ====== State ======
  const state = {
    race: {
      date: todayISO(),
      track: "ä¸­å±±",
      raceNo: "12R",
      raceClass: "3å‹",
      course: "ä¸­å±±ãƒ€1800",
    },
    step0: { q1:null, q2:null },
    // step2
    candidates: [], // ["6","13","15"]
    candMemos: {},  // horse -> memo
    // step3 per horse
    perHorse: {},   // horse -> {p1,p2,p3}
    // step4
    pick: { main:null, rows:[], tieMsg:"", recommendSkip:false, reason:"" },
    // step5
    step5: { weight:null, info:null },
    // step6
    final: { risk:"" }
  };

  // ====== Init inputs ======
  el("date").value = state.race.date;
  el("track").value = state.race.track;
  el("raceNo").value = state.race.raceNo;
  el("raceClass").value = state.race.raceClass;
  el("course").value = state.race.course;

  const updateRaceSummary = () => {
    const r = state.race;
    el("raceSummary").innerHTML =
      `<div class="tag">ğŸ“… ${r.date}</div>` +
      `<div class="tag">ğŸŸï¸ ${r.track}</div>` +
      `<div class="tag">ğŸ¯ ${r.raceNo}</div>` +
      `<div class="tag">ğŸ·ï¸ ${r.raceClass}</div>` +
      `<div class="tag">â­ ${r.course}</div>` +
      `<div class="hr"></div>` +
      `<div class="mono">${r.date} ${r.track}${r.raceNo}ï¼ˆ${r.raceClass} / ${r.course}ï¼‰</div>`;

    const logs = loadLogs();
    const todays = logs.filter(x => x.date === r.date);
    const left = Math.max(0, 3 - todays.length);
    el("todayCounter").innerHTML =
      `æœ¬æ—¥ã®è¨˜éŒ²ï¼š<b>${todays.length}</b>ä»¶ï¼ˆæ®‹ã‚Š<b>${left}</b>ä»¶ï¼‰<br>` +
      `<span class="small">â€»3ä»¶ã«é”ã—ãŸã‚‰ã€ä»Šæ—¥ã¯â€œé€²ã‚ãªã„â€ã®ãŒæ­£è§£ï¼ˆæš´èµ°é˜²æ­¢ï¼‰ã€‚</span>`;
    el("btnGoStep0").disabled = (left <= 0);
  };

  ["date","track","raceNo","raceClass","course"].forEach(id => {
    el(id).addEventListener("change", () => {
      state.race.date = el("date").value || todayISO();
      state.race.track = el("track").value;
      state.race.raceNo = el("raceNo").value;
      state.race.raceClass = el("raceClass").value;
      state.race.course = el("course").value;
      updateRaceSummary();
    });
  });
  updateRaceSummary();

  // ====== STEP0 / STEP5 Choice buttons ======
  const setChoice = (q, v) => {
    document.querySelectorAll(`.choice[data-q="${q}"]`).forEach(x => x.classList.remove("on"));
    const target = document.querySelector(`.choice[data-q="${q}"][data-v="${v}"]`);
    if (target) target.classList.add("on");
  };

  document.addEventListener("click", (e) => {
    const t = e.target.closest(".choice[data-q]");
    if (!t) return;
    const q = t.dataset.q;
    const v = t.dataset.v;

    if (q === "s0q1") state.step0.q1 = v;
    if (q === "s0q2") state.step0.q2 = v;
    if (q === "s5w") state.step5.weight = v;
    if (q === "s5info") state.step5.info = v;

    setChoice(q, v);
  });

  // ====== STEP1 Auto ======
  const refreshStep1 = () => {
    const ok = isTargetRace(state.race);
    const r = state.race;
    let msg = "";
    if (isG(r.raceClass)) {
      msg = `ã‚¯ãƒ©ã‚¹ãŒ <b>${r.raceClass}</b> â†’ <b class="ok">é‡è³ãªã®ã§å¯¾è±¡</b>ï¼ˆSTEP2ã¸é€²ã‚ã‚‹ï¼‰`;
    } else if (r.course === "ä¸­å±±ãƒ€1800" || r.course === "æ±äº¬ãƒ€1600") {
      msg = `å¾—æ„æ¡ä»¶ãŒ <b>${r.course}</b> â†’ <b class="ok">å¯¾è±¡</b>ï¼ˆSTEP2ã¸é€²ã‚ã‚‹ï¼‰`;
    } else if (isTokyo1400Paused(r.course)) {
      msg = `å¾—æ„æ¡ä»¶ãŒ <b>${r.course}</b> â†’ <b class="ng">åœæ­¢ä¸­ãªã®ã§å¯¾è±¡å¤–ï¼ˆè¦‹é€ã‚Šï¼‰</b>`;
    } else if (r.course === "é‡è³") {
      msg = `å¾—æ„æ¡ä»¶ãŒ <b>é‡è³</b> â†’ ã‚¯ãƒ©ã‚¹ãŒG1ã€œG3ãªã‚‰<b class="ok">å¯¾è±¡</b>ã€‚ã„ã¾ã¯ <b>${r.raceClass}</b> ãªã®ã§ ${isG(r.raceClass) ? '<b class="ok">OK</b>' : '<b class="ng">å¯¾è±¡å¤–</b>'}ã€‚`;
    } else {
      msg = `ã‚³ãƒ¼ã‚¹ãŒ <b>${r.course}</b> ï¼ã‚¯ãƒ©ã‚¹ãŒ <b>${r.raceClass}</b> â†’ <b class="ng">å¯¾è±¡å¤–ï¼ˆè¦‹é€ã‚Šï¼‰</b>`;
    }
    el("step1Auto").innerHTML = msg + `<div class="hr"></div><div class="small">â€»å¯¾è±¡å¤–ãªã‚‰ã€Œè¦‹é€ã‚Šã€ã§ãƒ­ã‚°ä¿å­˜ãŒæ­£è§£ãƒ«ãƒ¼ãƒˆã€‚</div>`;
    el("btnGoStep2").disabled = !ok;
    el("btnSkipFrom1").disabled = ok; // èª¤ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
  };

  // ====== STEP2 Dropdown candidates ======
  const buildHorseSelectOptions = () => {
    const opts = ['<option value="">æœªé¸æŠ</option>'];
    for (let i=1; i<=18; i++){
      opts.push(`<option value="${i}">${i}</option>`);
    }
    return opts.join("");
  };

  const initStep2 = () => {
    const html = buildHorseSelectOptions();
    el("cand1").innerHTML = html;
    el("cand2").innerHTML = html;
    el("cand3").innerHTML = html;

    // clear
    el("cand1").value = "";
    el("cand2").value = "";
    el("cand3").value = "";
    el("candMemo1").value = "";
    el("candMemo2").value = "";
    el("candMemo3").value = "";

    updateStep2Hint();
    el("btnGoStep3").disabled = true;

    const onChange = () => {
      enforceUniqueCandidates();
      updateStep2Hint();
      el("btnGoStep3").disabled = (getCandidates().length === 0);
    };

    el("cand1").addEventListener("change", onChange);
    el("cand2").addEventListener("change", onChange);
    el("cand3").addEventListener("change", onChange);
    el("candMemo1").addEventListener("input", updateStep2Hint);
    el("candMemo2").addEventListener("input", updateStep2Hint);
    el("candMemo3").addEventListener("input", updateStep2Hint);
  };

  const getCandidates = () => {
    const a = [el("cand1").value, el("cand2").value, el("cand3").value].filter(Boolean);
    // unique (just in case)
    return [...new Set(a)];
  };

  const enforceUniqueCandidates = () => {
    // æ—¢ã«é¸ã°ã‚ŒãŸé¦¬ç•ªã‚’ã€ä»–ã®selectã‹ã‚‰é¸ã³ã«ããã™ã‚‹ï¼ˆé¸æŠæ¸ˆã¿ã¯ä¿æŒï¼‰
    const chosen = new Set(getCandidates());

    ["cand1","cand2","cand3"].forEach(id => {
      const s = el(id);
      const cur = s.value;
      [...s.options].forEach(opt => {
        if (!opt.value) return;
        if (opt.value === cur) { opt.disabled = false; return; }
        opt.disabled = chosen.has(opt.value);
      });
    });
  };

  const updateStep2Hint = () => {
    const c = getCandidates();
    const count = c.length;

    let msg = "";
    if (count === 0) msg = "å€™è£œã‚’1é ­ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„ã€‚";
    else if (count === 1) msg = "âš ï¸ å€™è£œãŒ1é ­ã ã‘ã€‚ç„¡ç†ã«é€²ã¾ãšã€Œè¦‹é€ã‚Šã€ã‚‚æ­£è§£ã€‚";
    else if (count === 2) msg = "âš ï¸ å€™è£œãŒ2é ­ã€‚3é ­å‡ºãªã„ãƒ¬ãƒ¼ã‚¹ã¯è¦‹é€ã‚Šã‚‚æ­£è§£ã€‚";
    else msg = "OKã€‚å€™è£œãŒ3é ­ãã‚ã£ãŸã€‚STEP3ã¸ã€‚";

    el("step2Hint").innerHTML = `<b>${msg}</b>`;
  };

  // ====== STEP3 (3-choice) ======
  const buildStep3 = () => {
    const horses = state.candidates;
    state.perHorse = {};
    el("horseTags").innerHTML = horses.map(h => `<span class="tag">ğŸ é¦¬${h}</span>`).join("");

    const wrap = document.createElement("div");

    horses.forEach(h => {
      state.perHorse[h] = { p1:null, p2:null, p3:null };

      const memo = state.candMemos[h] || "";

      const box = document.createElement("div");
      box.className = "qbox";
      box.style.marginTop = "14px";
      box.innerHTML = `
        <div class="qtitle">é¦¬${h}ï½œå…¥åŠ›</div>

        <label>â‘  ã‚³ãƒ¼ã‚¹Ã—è·é›¢</label>
        <select id="p1_${h}">
          <option value="">æœªé¸æŠ</option>
          <option value="2">ğŸŸ¢ å•é¡Œãªã—ï¼ˆ2ï¼‰</option>
          <option value="1">ğŸŸ¡ ã‚„ã‚„ä¸å®‰ï¼ˆ1ï¼‰</option>
          <option value="0">ğŸ”´ ä¸å®‰å¤§ï¼ˆ0ï¼‰</option>
        </select>

        <label>â‘¡ æµã‚ŒÃ—è„šè³ªï¼ˆè² ã‘ç­‹ã®æ•°ï¼‰</label>
        <select id="p2_${h}">
          <option value="">æœªé¸æŠ</option>
          <option value="2">ğŸŸ¢ è² ã‘ç­‹ãŒ1ã¤ï¼ˆ2ï¼‰</option>
          <option value="1">ğŸŸ¡ è² ã‘ç­‹ãŒ2ã¤ï¼ˆ1ï¼‰</option>
          <option value="0">ğŸ”´ èª­ã‚ãªã„ï¼ˆ0ï¼‰</option>
        </select>

        <label>â‘¢ é¨æ‰‹ï¼ˆæ¸›ç‚¹å°‚ç”¨ï¼‰</label>
        <select id="p3_${h}">
          <option value="">æœªé¸æŠ</option>
          <option value="0">ğŸŸ¢ å£Šã•ãªã„ï¼ˆ0ï¼‰</option>
          <option value="-0.5">ğŸŸ¡ å°‘ã—ä¸å®‰ï¼ˆ-0.5ï¼‰</option>
          <option value="-1">ğŸ”´ å£Šã—ãã†ï¼ˆ-1.0ï¼‰</option>
        </select>

        <div class="hr"></div>
        <div class="small">ï¼ˆSTEP2ãƒ¡ãƒ¢ï¼‰${escapeHTML(memo) || "â€”"}</div>
      `;
      wrap.appendChild(box);
    });

    el("step3Forms").innerHTML = "";
    el("step3Forms").appendChild(wrap);

    const validate = () => {
      const ok = horses.every(h => {
        const a = el(`p1_${h}`).value;
        const b = el(`p2_${h}`).value;
        const c = el(`p3_${h}`).value;
        state.perHorse[h].p1 = (a === "" ? null : parseFloat(a));
        state.perHorse[h].p2 = (b === "" ? null : parseFloat(b));
        state.perHorse[h].p3 = (c === "" ? null : parseFloat(c));
        return a !== "" && b !== "" && c !== "";
      });
      el("btnGoStep4").disabled = !ok;
    };

    horses.forEach(h => {
      el(`p1_${h}`).addEventListener("change", validate);
      el(`p2_${h}`).addEventListener("change", validate);
      el(`p3_${h}`).addEventListener("change", validate);
    });

    el("btnGoStep4").disabled = true;
  };

  const escapeHTML = (s) => String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");

  // ====== STEP4 Scoring + Cards ======
  const computePick = () => {
    const horses = state.candidates;

    // build rows
    const rows = horses.map(h => {
      const s = state.perHorse[h];
      const total = (s.p1 ?? 0) + (s.p2 ?? 0) + (s.p3 ?? 0);
      return { horse:h, p1:s.p1, p2:s.p2, p3:s.p3, total };
    });

    // sort by total desc, then p1 desc, p2 desc, p3 desc (since p3 is negative, higher is better)
    const sorted = [...rows].sort((a,b) => {
      if (b.total !== a.total) return b.total - a.total;
      if (b.p1 !== a.p1) return b.p1 - a.p1;
      if (b.p2 !== a.p2) return b.p2 - a.p2;
      return b.p3 - a.p3;
    });

    const top = sorted[0];
    const topTotal = top.total;

    // check true tie after tie-break keys
    const tied = sorted.filter(r =>
      r.total === top.total && r.p1 === top.p1 && r.p2 === top.p2 && r.p3 === top.p3
    );

    let main = top.horse;
    let tieMsg = "";
    let recommendSkip = false;
    let reason = "";

    if (tied.length >= 2) {
      // cannot break tie -> skip
      main = null;
      recommendSkip = true;
      reason = "åŒç‚¹ãŒè§£ã‘ãªã„";
      tieMsg = "âš ï¸ åŒç‚¹ â†’ â‘ â†’â‘¡â†’â‘¢ã§ã‚‚åŒç‚¹ â†’ ãƒ«ãƒ¼ãƒ«é€šã‚Šã€Œè¦‹é€ã‚Šã€æ¨å¥¨ã€‚";
    } else {
      // still could have same total but resolved by tie-break
      const sameTotal = sorted.filter(r => r.total === topTotal);
      if (sameTotal.length >= 2) {
        tieMsg = "åŒç‚¹ â†’ â‘ å„ªå…ˆ â†’ â‘¡ â†’ â‘¢ ã§æ±ºå®šã€‚";
      }
      if (topTotal < 1.0) {
        recommendSkip = true;
        reason = "ãƒˆãƒƒãƒ—ãŒå¼±ã„ï¼ˆ1.0ç‚¹æœªæº€ï¼‰";
        tieMsg = (tieMsg ? tieMsg + "<br>" : "") + "âš ï¸ ãƒˆãƒƒãƒ—ãŒ1.0ç‚¹æœªæº€ â†’ è¦‹é€ã‚Šæ¨å¥¨ã€‚";
      }
    }

    state.pick = { main, rows:sorted, tieMsg, recommendSkip, reason };
  };

  const labelP1 = (v) => v===2 ? "ğŸŸ¢ å•é¡Œãªã—ï¼ˆ2ï¼‰" : v===1 ? "ğŸŸ¡ ã‚„ã‚„ä¸å®‰ï¼ˆ1ï¼‰" : "ğŸ”´ ä¸å®‰å¤§ï¼ˆ0ï¼‰";
  const labelP2 = (v) => v===2 ? "ğŸŸ¢ è² ã‘ç­‹ãŒ1ã¤ï¼ˆ2ï¼‰" : v===1 ? "ğŸŸ¡ è² ã‘ç­‹ãŒ2ã¤ï¼ˆ1ï¼‰" : "ğŸ”´ èª­ã‚ãªã„ï¼ˆ0ï¼‰";
  const labelP3 = (v) => v===0 ? "ğŸŸ¢ å£Šã•ãªã„ï¼ˆ0ï¼‰" : v===-0.5 ? "ğŸŸ¡ å°‘ã—ä¸å®‰ï¼ˆ-0.5ï¼‰" : "ğŸ”´ å£Šã—ãã†ï¼ˆ-1.0ï¼‰";

  const computeAim = (row) => {
    const a = [];
    if (row.p1 === 2) a.push("â‘ ");
    if (row.p2 === 2) a.push("â‘¡");
    // â‘¢ã¯æ¸›ç‚¹ã—ãªã„å ´åˆã ã‘è¡¨ç¤º
    if (row.p3 === 0) a.push("â‘¢");
    return a.join("");
  };

  const renderStep4 = () => {
    const { main, rows, tieMsg, recommendSkip } = state.pick;

    // top card
    if (!main) {
      el("step4Top").innerHTML = `
        <div class="resultCard bad">
          <div class="big ng">âš ï¸ è¦‹é€ã‚Šï¼ˆåŒç‚¹ãŒè§£ã‘ãªã„ï¼‰</div>
          <div class="small">ãƒ«ãƒ¼ãƒ«ï¼šâ‘ â†’â‘¡â†’â‘¢ã§ã‚‚åŒç‚¹ â†’ è¦‹é€ã‚Š</div>
        </div>
      `;
      el("btnGoStep5").disabled = true;
    } else {
      const top = rows.find(r => r.horse === main);
      const aim = computeAim(top) || "â€”";
      const cls = recommendSkip ? "warn" : "good";
      const title = recommendSkip ? `âš ï¸ æœ¬å‘½ï¼šé¦¬${main}ï¼ˆåˆè¨ˆ ${top.total.toFixed(1)}ç‚¹ï¼‰` : `âœ… æœ¬å‘½ï¼šé¦¬${main}ï¼ˆåˆè¨ˆ ${top.total.toFixed(1)}ç‚¹ï¼‰`;
      const subtitle = recommendSkip ? "è¦‹é€ã‚Šæ¨å¥¨ï¼ˆå¼±ã„/å±é™ºï¼‰" : "è²·ã†å€™è£œ";

      el("step4Top").innerHTML = `
        <div class="resultCard ${cls}">
          <div class="big">${title}</div>
          <div class="pillRow">
            <div class="pill">ç‹™ã„ï¼š<b>${aim}</b></div>
            <div class="pill">åˆ¤å®šï¼š<b>${subtitle}</b></div>
          </div>
          <div class="hr"></div>
          <div class="small">æ¬¡ã¯STEP5ã§æœ€çµ‚ãƒ–ãƒ¬ãƒ¼ã‚­ï¼ˆé¦¬ä½“é‡Â±12ï¼ç›´å‰ãƒ•ãƒ©ã‚°ï¼‰</div>
        </div>
      `;
      el("btnGoStep5").disabled = false;
    }

    // tie msg
    el("step4TieMsg").innerHTML = tieMsg || "";

    // detail cards
    const cards = rows.map(r => {
      const isMain = (r.horse === main);
      const borderCls = isMain ? "good" : "";
      const mark = isMain ? " âœ…" : "";
      return `
        <div class="resultCard ${borderCls}" style="margin-top:12px;">
          <div class="big">é¦¬${r.horse}${mark}ï½œåˆè¨ˆ ${r.total.toFixed(1)}ç‚¹</div>
          <div class="hr"></div>
          <div>â‘  ã‚³ãƒ¼ã‚¹Ã—è·é›¢ï¼š<b>${labelP1(r.p1)}</b></div>
          <div>â‘¡ æµã‚ŒÃ—è„šè³ªï¼š<b>${labelP2(r.p2)}</b></div>
          <div>â‘¢ é¨æ‰‹ï¼š<b>${labelP3(r.p3)}</b></div>
        </div>
      `;
    }).join("");

    el("step4Cards").innerHTML = cards;

    // enable/disable skip button always OK; step5 button depends on main
  };

  // ====== STEP6 Summary ======
  const updateFinalSummary = () => {
    const r = state.race;
    const { main, rows } = state.pick;
    const top = main ? rows.find(x => x.horse === main) : null;
    const aim = top ? (computeAim(top) || "â€”") : "â€”";
    const w = state.step5.weight;
    const info = state.step5.info;

    const skipReasons = [];
    if (!main) skipReasons.push("æœ¬å‘½ãŒæ±ºã¾ã‚‰ãªã„");
    if (w === "yes") skipReasons.push("é¦¬ä½“é‡Â±12kgä»¥ä¸Š");
    if (info === "yes") skipReasons.push("ç›´å‰æƒ…å ±ãƒ•ãƒ©ã‚°ON");

    const willSkip = skipReasons.length > 0;
    const rec = willSkip ? "è¦‹é€ã‚Š" : "è²·ã†";
    const cls = willSkip ? "warnTxt" : "ok";

    el("finalSummary").innerHTML = `
      <div class="tag">ğŸ“… ${r.date}</div>
      <div class="tag">ğŸŸï¸ ${r.track}</div>
      <div class="tag">ğŸ¯ ${r.raceNo}</div>
      <div class="tag">ğŸ·ï¸ ${r.raceClass}</div>
      <div class="tag">â­ ${r.course}</div>
      <div class="hr"></div>
      <div class="big ${cls}">çµè«–ï¼š${rec}</div>
      <div class="hr"></div>
      <div><b>æœ¬å‘½ï¼š</b>${main ? `é¦¬${main}` : "â€”"}</div>
      <div><b>ç‹™ã„ï¼š</b>${aim}</div>
      <div><b>è²·ã„ç›®ï¼š</b>${main ? `é¦¬${main} è¤‡å‹1ç‚¹ 500å††` : "â€”"}</div>
      ${willSkip ? `<div class="hr"></div><div class="small">è¦‹é€ã‚Šç†ç”±ï¼š${skipReasons.join(" / ")}</div>` : ""}
    `;

    el("skipCond").value =
      `é¦¬ä½“é‡Â±12kgä»¥ä¸Š â†’ è¦‹é€ã‚Š\n` +
      `ç›´å‰æƒ…å ±ãƒ•ãƒ©ã‚°ON â†’ è¦‹é€ã‚Š\n` +
      `åŒç‚¹ãŒè§£ã‘ãªã„ï¼æœ¬å‘½ãŒæ±ºã¾ã‚‰ãªã„ â†’ è¦‹é€ã‚Š\n`;
  };

  // ====== Logs & CSV ======
  const toCSV = (logs) => {
    const headers = [
      "ts","date","track","raceNo","class","course",
      "cand1","cand2","cand3",
      "main","score","aim",
      "risk","weight12","lateInfo",
      "decision","memo"
    ];
    const esc = (s) => `"${String(s ?? "").replace(/"/g,'""')}"`;
    const lines = [headers.join(",")];

    logs.forEach(l => {
      lines.push([
        l.ts, l.date, l.track, l.raceNo, l.raceClass, l.course,
        l.cand1||"", l.cand2||"", l.cand3||"",
        l.main||"", l.score||"", l.aim||"",
        l.risk||"", l.weight12||"", l.lateInfo||"",
        l.decision||"", l.memo||""
      ].map(esc).join(","));
    });

    return lines.join("\n");
  };

  const refreshLogUI = () => {
    const logs = loadLogs();
    const csv = toCSV(logs);
    const lines = csv.split("\n");
    const preview = lines.slice(0,1).concat(lines.slice(Math.max(1, lines.length-11))).join("\n");
    el("logPreview").textContent = preview;
    updateRaceSummary();
  };

  const saveDecision = (decision) => {
    const logs = loadLogs();
    const r = state.race;

    const cand = state.candidates || [];
    const cand1 = cand[0] || "";
    const cand2 = cand[1] || "";
    const cand3 = cand[2] || "";

    const main = state.pick.main;
    const mainRow = main ? state.pick.rows.find(x => x.horse === main) : null;
    const score = mainRow ? mainRow.total.toFixed(1) : "";
    const aim = mainRow ? (computeAim(mainRow) || "") : "";

    // memo: step2 memos combined
    const memoParts = [];
    cand.forEach(h => {
      const m = (state.candMemos[h] || "").trim();
      if (m) memoParts.push(`${h}:${m}`);
    });

    logs.push({
      ts: nowStr(),
      date: r.date,
      track: r.track,
      raceNo: r.raceNo,
      raceClass: r.raceClass,
      course: r.course,
      cand1, cand2, cand3,
      main,
      score,
      aim,
      risk: (state.final.risk || "").trim(),
      weight12: state.step5.weight || "",
      lateInfo: state.step5.info || "",
      decision,
      memo: memoParts.join(" / ")
    });

    saveLogs(logs);
    refreshLogUI();
  };

  // ====== Buttons wiring ======
  el("btnGoStep0").addEventListener("click", () => {
    const logs = loadLogs();
    const todays = logs.filter(x => x.date === state.race.date);
    if (todays.length >= 3) return;
    go("cardStep0");
  });

  el("btnSkipToday").addEventListener("click", () => {
    // quick skip
    state.candidates = [];
    state.candMemos = {};
    state.pick = { main:null, rows:[], tieMsg:"", recommendSkip:false, reason:"" };
    state.step5.weight = "";
    state.step5.info = "";
    state.final.risk = "";
    saveDecision("SKIP");
    alert("è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
  });

  el("btnBackToRace").addEventListener("click", () => go("cardRace"));
  el("btnBackTo0").addEventListener("click", () => go("cardStep0"));
  el("btnBackTo1").addEventListener("click", () => go("cardStep1"));
  el("btnBackTo2").addEventListener("click", () => go("cardStep2"));
  el("btnBackTo3").addEventListener("click", () => go("cardStep3"));
  el("btnBackTo4").addEventListener("click", () => go("cardStep4"));
  el("btnBackTo5").addEventListener("click", () => go("cardStep5"));

  el("btnSkipFrom0").addEventListener("click", () => {
    saveDecision("SKIP");
    alert("è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  el("btnGoStep1").addEventListener("click", () => {
    if (!state.step0.q1 || !state.step0.q2) {
      alert("STEP0ã®Q1/Q2ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    if (state.step0.q1 === "no" || state.step0.q2 === "no") {
      alert("No ãŒå‡ºã¾ã—ãŸã€‚ä»Šå›ã¯è¦‹é€ã‚ŠãŒæ­£è§£ã§ã™ï¼ˆãƒ­ã‚°ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰ã€‚");
      return;
    }
    refreshStep1();
    go("cardStep1");
  });

  el("btnSkipFrom1").addEventListener("click", () => {
    saveDecision("SKIP");
    alert("å¯¾è±¡å¤–ã¨ã—ã¦è¦‹é€ã‚Šä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  el("btnGoStep2").addEventListener("click", () => {
    refreshStep1();
    if (!isTargetRace(state.race)) {
      alert("å¯¾è±¡å¤–ã§ã™ã€‚è¦‹é€ã‚ŠãŒæ­£è§£ã§ã™ã€‚");
      return;
    }
    initStep2();
    go("cardStep2");
  });

  el("btnSkipFrom2").addEventListener("click", () => {
    saveDecision("SKIP");
    alert("è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  el("btnGoStep3").addEventListener("click", () => {
    const cand = getCandidates();
    if (cand.length === 0) {
      alert("å€™è£œã‚’1é ­ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„ã€‚");
      return;
    }

    // save candidates + memos
    state.candidates = cand;
    state.candMemos = {};
    const m1 = (el("candMemo1").value || "").trim();
    const m2 = (el("candMemo2").value || "").trim();
    const m3 = (el("candMemo3").value || "").trim();
    const map = [
      {h: el("cand1").value, m: m1},
      {h: el("cand2").value, m: m2},
      {h: el("cand3").value, m: m3},
    ];
    map.forEach(x => { if (x.h) state.candMemos[x.h] = x.m; });

    buildStep3();
    go("cardStep3");
  });

  el("btnGoStep4").addEventListener("click", () => {
    computePick();
    renderStep4();
    go("cardStep4");
  });

  el("btnSkipFrom4").addEventListener("click", () => {
    saveDecision("SKIP");
    alert("è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  el("btnGoStep5").addEventListener("click", () => {
    if (!state.pick.main) {
      alert("æœ¬å‘½ãŒæ±ºã¾ã£ã¦ã„ã¾ã›ã‚“ã€‚åŒç‚¹ãŒè§£ã‘ãªã„å ´åˆã¯è¦‹é€ã‚Šã§ã™ã€‚");
      return;
    }
    go("cardStep5");
  });

  el("btnGoStep6").addEventListener("click", () => {
    if (!state.step5.weight || !state.step5.info) {
      alert("STEP5ã®Q1/Q2ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    updateFinalSummary();
    go("cardStep6");
  });

  el("btnSaveBuy").addEventListener("click", () => {
    state.final.risk = el("riskOne").value || "";
    saveDecision("BUY");
    alert("BUYã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  el("btnSaveSkip").addEventListener("click", () => {
    state.final.risk = el("riskOne").value || "";
    saveDecision("SKIP");
    alert("è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  // ====== LOG buttons ======
  el("btnCopyCSV").addEventListener("click", async () => {
    const logs = loadLogs();
    const csv = toCSV(logs);
    try {
      await navigator.clipboard.writeText(csv);
      alert("CSVã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
    } catch {
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚iOSã®è¨­å®šã§è¨±å¯ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚");
    }
  });

  el("btnDownloadCSV").addEventListener("click", () => {
    const logs = loadLogs();
    const csv = toCSV(logs);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `oji_keiba_log_${todayISO()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  el("btnClearLog").addEventListener("click", () => {
    if (!confirm("ãƒ­ã‚°ã‚’å…¨æ¶ˆã—ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(KEY);
    refreshLogUI();
    alert("ãƒ­ã‚°ã‚’å…¨æ¶ˆã—ã—ã¾ã—ãŸã€‚");
  });

  // ====== start ======
  refreshLogUI();
  go("cardRace");
})();
</script>
</body>
</html>
