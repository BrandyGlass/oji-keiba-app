<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŠã˜.exeï¼ˆç«¶é¦¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰</title>
  <style>
    :root { --pad: 16px; --line: rgba(255,255,255,.10); }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system, system-ui, "Hiragino Sans", "Noto Sans JP", sans-serif;
      background:#0b1220; color:#e9eefc;
    }
    .wrap{ max-width:860px; margin:0 auto; padding:var(--pad); }
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      margin-bottom:14px;
    }
    h1{ font-size:22px; margin:0 0 6px; }
    h2{ font-size:16px; margin:0 0 10px; color:#cfe0ff; }
    .sub{ font-size:13px; color:rgba(233,238,252,.75); line-height:1.55; margin:0 0 14px; }
    .pill{
      display:inline-block; font-size:12px; padding:6px 10px;
      border-radius:999px; border:1px solid var(--line);
      background:rgba(0,0,0,.18); color:rgba(233,238,252,.85);
      margin-right:6px; margin-bottom:6px;
    }
    .hr{ height:1px; background:var(--line); margin:14px 0; }
    .q{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      margin:12px 0;
    }
    .qTitle{ font-weight:1000; margin:0 0 10px; }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:#e9eefc;
      border-radius:16px;
      padding:14px 14px;
      font-size:16px;
      font-weight:1000;
      cursor:pointer;
      flex:1;
      min-width:160px;
    }
    button.primary{ background:#e9eefc; color:#0b1220; border-color:transparent; }
    button.danger{ background:rgba(255,80,80,.12); border-color:rgba(255,80,80,.22); color:#ffd7d7; }
    button.ghost{ background:transparent; }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .note{ font-size:12px; color:rgba(233,238,252,.65); line-height:1.5; margin-top:10px; }
    .hide{ display:none; }

    .row{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px; border:1px solid var(--line); border-radius:14px;
      background:rgba(0,0,0,.14); margin:10px 0;
    }
    .badge{
      font-weight:1000;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:999px;
      padding:6px 10px;
      font-size:14px;
      min-width:68px;
      text-align:center;
    }
    .seg{
      display:flex; gap:8px; flex-wrap:wrap; flex:1;
    }
    .seg button{
      min-width:72px; flex:0 0 auto; padding:10px 12px; font-size:14px;
      border-radius:999px;
    }
    .seg button.on{
      background:#e9eefc; color:#0b1220; border-color:transparent;
    }

    .inputs{ display:flex; gap:10px; flex-wrap:wrap; }
    .field{ flex:1; min-width:160px; }
    label{ display:block; font-size:12px; color:rgba(233,238,252,.7); margin-bottom:6px; }
    input, select{
      width:100%;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:#e9eefc;
      border-radius:14px;
      padding:14px 12px;
      font-size:16px;
      font-weight:1000;
      outline:none;
    }
    input::placeholder{ color:rgba(233,238,252,.35); font-weight:800; }
    select option{ color:#0b1220; }

    .bigMsg{
      font-size:16px; line-height:1.6;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      margin-top:12px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px; color:rgba(233,238,252,.82);
      white-space:pre-wrap;
    }
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      font-size:14px;
      text-align:left;
    }
    th{ color:#cfe0ff; font-weight:1000; }
    .right{ text-align:right; }

    .chk{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .chk label{
      display:flex; align-items:center; gap:8px;
      background:rgba(0,0,0,.14);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      color:rgba(233,238,252,.9);
      margin:0;
      cursor:pointer;
    }
    .chk input{ width:auto; padding:0; }

    a.dl{
      display:inline-block;
      margin-top:10px;
      color:#cfe0ff;
      text-decoration:none;
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.14);
      font-weight:900;
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.75); border:1px solid var(--line);
      color:#fff; padding:10px 12px; border-radius:14px;
      font-size:13px; opacity:0; pointer-events:none;
      transition:opacity .18s ease;
      max-width:92vw;
    }
    .toast.show{ opacity:1; }

    /* fixed header (race label) */
    .topbar{
      position:sticky;
      top:0;
      z-index:5;
      margin:0 0 14px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .topbar .left{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      font-weight:900; font-size:13px; color:rgba(233,238,252,.92);
    }
    .topbar .right{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .mini{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      font-size:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <h1>ãŠã˜.exeï¼ˆç«¶é¦¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰</h1>
      <p class="sub">
        ç›®çš„ï¼šè¿·ã‚ãªã„ï¼æ„Ÿæƒ…ã§è²·ã‚ãªã„ï¼æ±ºã‚ãŸæ‰‹é †é€šã‚Šã«å‹•ãã€‚<br>
        STEP-1ï¼ˆãƒ¬ãƒ¼ã‚¹å›ºå®šï¼‰â†’ STEP0ã€œ6ï¼ˆåˆ¤æ–­ï¼‰â†’ CSVãƒ­ã‚°ï¼ˆä¿å­˜ï¼‰ã€‚
      </p>
      <span class="pill">è¤‡å‹1ç‚¹</span>
      <span class="pill">1R 500å††</span>
      <span class="pill">æœ€å¤§3ãƒ¬ãƒ¼ã‚¹/æ—¥</span>
      <span class="pill">å¾—æ„æ¡ä»¶ï¼šä¸­å±±ãƒ€1800 / æ±äº¬ãƒ€1600</span>
      <span class="pill">æ±äº¬èŠ1400ï¼šä¸€æ™‚åœæ­¢</span>
    </div>

    <!-- Fixed race header -->
    <div id="topbar" class="topbar hide">
      <div class="left">
        <span class="mini" id="tb_date">ğŸ“… ----</span>
        <span class="mini" id="tb_track">ğŸŸ ----</span>
        <span class="mini" id="tb_race">ğŸ¯ --R</span>
        <span class="mini" id="tb_label">----</span>
      </div>
      <div class="right">
        <button class="ghost" id="tb_restart" style="min-width:120px; padding:10px 12px; font-size:14px;">æœ€åˆã‹ã‚‰</button>
      </div>
    </div>

    <!-- STEP-1 -->
    <section id="stepm1" class="card">
      <h2>STEP-1ï½œãƒ¬ãƒ¼ã‚¹æƒ…å ±ï¼ˆæœ€åˆã«å›ºå®šï¼‰</h2>
      <p class="sub">
        ã“ã®ç”»é¢ã§ã€Œä»Šæ—¥ã¯ä½•ã®ãƒ¬ãƒ¼ã‚¹ã‚’æ‰±ã†ã‹ã€ã‚’å›ºå®šã—ã¾ã™ã€‚<br>
        ã“ã“ã§è¿·ã‚ãªã„ã“ã¨ãŒã€å‹ã‚’å®ˆã‚‹ä¸€ç•ªã®è¿‘é“ã§ã™ã€‚
      </p>

      <div class="q">
        <p class="qTitle">å…¥åŠ›ï¼ˆå¿…é ˆï¼‰</p>
        <div class="inputs">
          <div class="field" style="min-width:240px;">
            <label>æ—¥ä»˜ï¼ˆç«¶é¦¬æ—¥ï¼‰</label>
            <input id="m1_date" type="date" />
            <div class="note">â€»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä»Šæ—¥ã€‚éå»ãƒ»æœªæ¥ã®æ—¥ä»˜ã‚‚é¸ã¹ã¾ã™ã€‚</div>
          </div>

          <div class="field">
            <label>ç«¶é¦¬å ´</label>
            <select id="m1_track">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="ä¸­å±±">ä¸­å±±</option>
              <option value="æ±äº¬">æ±äº¬</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <div class="note">â€»ã€Œãã®ä»–ã€ã¯å¾—æ„æ¡ä»¶ã«è©²å½“ã—ã¾ã›ã‚“ï¼ˆSTEP1ã§é€šå¸¸åˆ¤å®šï¼‰ã€‚</div>
          </div>

          <div class="field" style="min-width:180px;">
            <label>ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
            <select id="m1_raceNo">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="1">1R</option><option value="2">2R</option><option value="3">3R</option><option value="4">4R</option>
              <option value="5">5R</option><option value="6">6R</option><option value="7">7R</option><option value="8">8R</option>
              <option value="9">9R</option><option value="10">10R</option><option value="11">11R</option><option value="12">12R</option>
            </select>
            <div class="note">â€»æ‰‹å…¥åŠ›ä¸å¯ã€‚å¿…ãšé¸æŠã—ã¦ãã ã•ã„ã€‚</div>
          </div>
        </div>
      </div>

      <div class="q">
        <p class="qTitle">ã“ã®ãƒ¬ãƒ¼ã‚¹ï¼ˆè‡ªå‹•è¡¨ç¤ºï¼‰</p>
        <div class="mono" id="m1_preview">æœªå…¥åŠ›</div>
        <div class="hr"></div>
        <div class="mono" id="m1_limits">æœ¬æ—¥ã®è¨˜éŒ²ï¼š- ä»¶ï¼ˆæ®‹ã‚Š - ä»¶ï¼‰</div>
        <div class="mono" id="m1_dup"></div>
        <p class="note">â€»ã“ã®å…ˆã¯ã€æ±ºã‚ãŸãƒ¬ãƒ¼ã‚¹ã‚’å‰æã«é€²ã¿ã¾ã™ã€‚æˆ»ã£ã¦å¤‰æ›´ã¯ã—ã¾ã›ã‚“ã€‚</p>
      </div>

      <div class="btnRow">
        <button class="primary" id="m1_next" disabled>æ¬¡ã¸ï¼ˆSTEP0ã¸ï¼‰</button>
        <button class="danger" id="m1_skip">ä»Šæ—¥ã¯è¦‹é€ã‚‹</button>
      </div>
      <p class="note">è¦‹é€ã‚Šã¯æ­£è§£ãƒ«ãƒ¼ãƒˆã§ã™ã€‚</p>
    </section>

    <!-- STEP0 -->
    <section id="step0" class="card hide">
      <h2>STEP0ï½œå‰æç¢ºèªï¼ˆ10ç§’ï¼‰</h2>

      <div class="q">
        <p class="qTitle">Q1ï¼šä»Šæ—¥ã¯æœ€å¤§3ãƒ¬ãƒ¼ã‚¹ã¾ã§ã€ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚Œã‚‹ï¼Ÿ</p>
        <div class="btnRow">
          <button class="primary" data-next="step0_q2" data-set="step0_q1:yes">ã¯ã„</button>
          <button class="danger" data-skip="today_limit" data-set="step0_q1:no">ã„ã„ãˆ</button>
        </div>
        <p class="note">No ãŒå‡ºãŸã‚‰ã€ãã®æ™‚ç‚¹ã§çµ‚äº†ï¼ˆä»Šæ—¥ã¯è¦‹é€ã‚Šï¼‰ã€‚</p>
      </div>

      <div id="step0_q2" class="q hide">
        <p class="qTitle">Q2ï¼šã“ã®ãƒ¬ãƒ¼ã‚¹ã¯500å††ã ã‘ã§è²·ã†ï¼Ÿ</p>
        <div class="btnRow">
          <button class="primary" id="goStep1" data-set="step0_q2:yes">ã¯ã„</button>
          <button class="danger" data-skip="money_rule" data-set="step0_q2:no">ã„ã„ãˆ</button>
        </div>
        <p class="note">ã€Œ500å††ã ã‘ã€ãŒå®ˆã‚Œãªã„ãªã‚‰ã€ã“ã®ãƒ¬ãƒ¼ã‚¹ã¯è¦‹é€ã‚Šã€‚</p>
      </div>
    </section>

    <!-- STEP1 -->
    <section id="step1" class="card hide">
      <h2>STEP1ï½œå¯¾è±¡ãƒ¬ãƒ¼ã‚¹åˆ¤å®šï¼ˆå³æ–­ï¼‰</h2>

      <div class="q">
        <p class="qTitle">Q3ï¼šã“ã®ãƒ¬ãƒ¼ã‚¹ã¯é‡è³ï¼ˆG1ã€œG3ï¼‰ï¼Ÿ</p>
        <div class="btnRow">
          <button class="primary" id="isGradedYes" data-set="step1_q3:yes">ã¯ã„</button>
          <button id="isGradedNo" data-set="step1_q3:no">ã„ã„ãˆ</button>
        </div>
        <p class="note">é‡è³ã¯è²·ã†å¯¾è±¡ã«å«ã‚ã‚‹ï¼ˆãŸã ã—STEP0ã®è³‡é‡‘ãƒ«ãƒ¼ãƒ«ã¯çµ¶å¯¾ï¼‰ã€‚</p>
      </div>

      <div id="step1_q4" class="q hide">
        <p class="qTitle">Q4ï¼šå¾—æ„æ¡ä»¶ã«å½“ã¦ã¯ã¾ã‚‹ï¼Ÿ</p>
        <div class="btnRow">
          <button class="primary" data-pick="nakayama_d1800">ä¸­å±±ãƒ€1800</button>
          <button class="primary" data-pick="tokyo_d1600">æ±äº¬ãƒ€1600</button>
          <button class="danger" data-pick="none">ã©ã‚Œã§ã‚‚ãªã„</button>
        </div>
        <p class="note">æ±äº¬èŠ1400ã¯ä¸€æ™‚åœæ­¢ï¼ˆé¸æŠè‚¢ã«å­˜åœ¨ã—ãªã„ï¼‰ã€‚</p>
      </div>

      <div id="step1_pass" class="bigMsg hide">
        <div style="font-weight:1000; margin-bottom:6px;">âœ… å¯¾è±¡ãƒ¬ãƒ¼ã‚¹ï¼šOK</div>
        <div class="mono" id="passSummary"></div>
        <div class="btnRow" style="margin-top:12px;">
          <button class="primary" id="goStep2">STEP2ã¸é€²ã‚€</button>
          <button class="danger" id="skipHere">ä»Šå›ã¯è¦‹é€ã‚‹</button>
        </div>
        <p class="note">è¦‹é€ã‚Šã¯æ­£è§£ãƒ«ãƒ¼ãƒˆã€‚è¿·ã£ãŸã‚‰æ­¢ã‚ã‚‹ã€‚</p>
      </div>
    </section>

    <!-- STEP2 -->
    <section id="step2" class="card hide">
      <h2>STEP2ï½œå€™è£œæŠ½å‡ºï¼ˆç•ªå·ã§æœ€å¤§3é ­ï¼‰</h2>
      <p class="sub">
        æœ¬å‘½ã¯æ±ºã‚ãªã„ã€‚ã€Œå¤‰ãªè² ã‘æ–¹ã‚’ã—ã«ããã†ã€ãªé¦¬ã‚’ç•ªå·ã§æœ€å¤§3é ­ã€‚äººæ°—ãƒ»ã‚ªãƒƒã‚ºã¯è¦‹ãªã„ã€‚
      </p>

      <div class="q">
        <p class="qTitle">å€™è£œé¦¬ã®ç•ªå·ï¼ˆæœ€å¤§3é ­ï¼‰</p>

        <div class="inputs">
          <div class="field">
            <label>é¦¬â‘ ï¼ˆå¿…é ˆï¼‰</label>
            <input id="h1" inputmode="numeric" placeholder="ä¾‹ï¼š7" />
          </div>
          <div class="field">
            <label>é¦¬â‘¡ï¼ˆä»»æ„ï¼‰</label>
            <input id="h2" inputmode="numeric" placeholder="ä¾‹ï¼š12" />
          </div>
          <div class="field">
            <label>é¦¬â‘¢ï¼ˆä»»æ„ï¼‰</label>
            <input id="h3" inputmode="numeric" placeholder="ä¾‹ï¼š3" />
          </div>
        </div>

        <p class="note">
          ãƒ«ãƒ¼ãƒ«ï¼šæ•°å­—ã®ã¿ï¼åŒã˜ç•ªå·ã¯ä¸å¯ã€‚é¦¬â‘ ãŒæ›¸ã‘ãªã„ï¼è¦‹é€ã‚ŠãŒåˆç†çš„ã€‚
        </p>

        <div class="btnRow" style="margin-top:12px;">
          <button class="primary" id="toStep3_1">STEP3ã¸é€²ã‚€</button>
          <button class="danger" id="skipFromStep2">ä»Šå›ã¯è¦‹é€ã‚‹</button>
        </div>
      </div>
    </section>

    <!-- STEP3-â‘  -->
    <section id="step3_1" class="card hide">
      <h2>STEP3-â‘ ï½œã‚³ãƒ¼ã‚¹ Ã— è·é›¢ï¼ˆæœ€å„ªå…ˆï¼‰</h2>
      <p class="sub">è¿·ã£ãŸã‚‰ä¸‹ã’ã‚‹ã€‚â—2 / â—¯1 / â–³0 / Ã—-2</p>
      <div id="s31_list"></div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="primary" id="toStep3_2">æ¬¡ã¸ï¼ˆâ‘¡ã¸ï¼‰</button>
        <button class="danger" id="skipFromS3_1">ä»Šå›ã¯è¦‹é€ã‚‹</button>
      </div>
    </section>

    <!-- STEP3-â‘¡ -->
    <section id="step3_2" class="card hide">
      <h2>STEP3-â‘¡ï½œæµã‚Œ Ã— è„šè³ªï¼ˆè² ã‘ç­‹ã®å°‘ãªã•ï¼‰</h2>
      <p class="sub">è¿·ã£ãŸã‚‰ä¸‹ã’ã‚‹ã€‚â—2 / â—¯1 / â–³0 / Ã—-2</p>
      <div id="s32_list"></div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="primary" id="toStep3_3">æ¬¡ã¸ï¼ˆâ‘¢ã¸ï¼‰</button>
        <button class="danger" id="skipFromS3_2">ä»Šå›ã¯è¦‹é€ã‚‹</button>
      </div>
    </section>

    <!-- STEP3-â‘¢ -->
    <section id="step3_3" class="card hide">
      <h2>STEP3-â‘¢ï½œé¨æ‰‹ï¼ˆæ¸›ç‚¹å°‚ç”¨ï¼‰</h2>
      <p class="sub">åŠ ç‚¹ã—ãªã„ã€‚OK 0 / ä¸å®‰ -0.5 / NG -1</p>
      <div id="s33_list"></div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="primary" id="toStep4">STEP4ï¼ˆç‚¹æ•°åŒ–ï¼‰ã¸</button>
        <button class="danger" id="skipFromS3_3">ä»Šå›ã¯è¦‹é€ã‚‹</button>
      </div>
    </section>

    <!-- STEP4 -->
    <section id="step4" class="card hide">
      <h2>STEP4ï½œç‚¹æ•°åŒ–ï¼ˆæ©Ÿæ¢°çš„ã«æœ¬å‘½ã‚’æ±ºã‚ã‚‹ï¼‰</h2>
      <p class="sub">
        åˆè¨ˆç‚¹ = â‘  + â‘¡ + â‘¢ã€‚ãƒˆãƒƒãƒ—ãŒæœ¬å‘½ã€‚<br>
        åŒç‚¹ï¼šâ‘ â†’â‘¡â†’â‘¢â†’ãã‚Œã§ã‚‚åŒç‚¹ãªã‚‰è¦‹é€ã‚Šã€‚ãƒˆãƒƒãƒ—ãŒ1ç‚¹æœªæº€ãªã‚‰è¦‹é€ã‚Šæ¨å¥¨ã€‚
      </p>

      <div id="s4_out" class="bigMsg"></div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="primary" id="goStep5">STEP5ã¸é€²ã‚€</button>
        <button class="danger" id="skipFromStep4">ä»Šå›ã¯è¦‹é€ã‚‹</button>
        <button class="ghost" id="restart">æœ€åˆã‹ã‚‰</button>
      </div>
    </section>

    <!-- STEP5 -->
    <section id="step5" class="card hide">
      <h2>STEP5ï½œ0ç•ªãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ãƒ‰ãƒƒã‚¯ç„¡ã—ãƒ»äº‹å®Ÿã®ã¿ï¼‰</h2>
      <p class="sub">
        ã“ã“ã¯æœ€å¾Œã®ãƒ–ãƒ¬ãƒ¼ã‚­ã€‚é¦¬ä½“é‡Â±12kgä»¥ä¸Šã¯å¼·åˆ¶è¦‹é€ã‚Šã€‚ç›´å‰æƒ…å ±ã¯ãƒ•ãƒ©ã‚°ï¼ˆè¦‹é€ã‚Šæ¡ä»¶ã«è‡ªå‹•åæ˜ ï¼‰ã€‚
      </p>

      <div class="q">
        <p class="qTitle">Q5-1ï¼šé¦¬ä½“é‡ã¯å‰èµ°æ¯” Â±12kgä»¥ä¸Šï¼Ÿï¼ˆã‚ã‹ã‚‰ãªã‘ã‚Œã°ã€Œä¸æ˜ã€ï¼‰</p>
        <div class="btnRow" style="gap:8px;">
          <button class="ghost" id="w_yes" data-w="yes">ã¯ã„ï¼ˆÂ±12ä»¥ä¸Šï¼‰</button>
          <button class="ghost" id="w_no" data-w="no">ã„ã„ãˆï¼ˆÂ±11ä»¥å†…ï¼‰</button>
          <button class="ghost" id="w_unknown" data-w="unknown">ä¸æ˜</button>
        </div>
        <p class="note">ã€Œã¯ã„ã€ã¯å¼·åˆ¶è¦‹é€ã‚Šã€‚ãã‚Œä»¥å¤–ã¯ç¶šè¡Œã€‚</p>
      </div>

      <div class="q">
        <p class="qTitle">Q5-2ï¼šç›´å‰æƒ…å ±ï¼ˆäº‹å®Ÿãƒ•ãƒ©ã‚°ï¼‰</p>
        <div class="chk">
          <label><input type="checkbox" id="f_cancel" /> å‡ºèµ°å–æ¶ˆï¼æ¡ä»¶ã®å¤§ããªå¤‰æ›´</label>
          <label><input type="checkbox" id="f_jockey" /> é¨æ‰‹ã®æ€¥ãªä¹—ã‚Šæ›¿ã‚ã‚Š</label>
          <label><input type="checkbox" id="f_track" /> é¦¬å ´ãŒæƒ³å®šã¨ã‚ºãƒ¬ãŸï¼ˆé‡â†’ä¸è‰¯ãªã©ï¼‰</label>
        </div>
        <p class="note">ãƒ•ãƒ©ã‚°ãŒç«‹ã£ãŸã‚‰ã€Œè¦‹é€ã‚Šæ¡ä»¶ã€ã«è‡ªå‹•ã§å…¥ã‚‹ï¼ˆå³çµ‚äº†ã§ã¯ãªã„ï¼‰ã€‚</p>
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="primary" id="toStep6">STEP6ï¼ˆçµè«–ï¼‰ã¸</button>
        <button class="danger" id="skipFromStep5">ä»Šå›ã¯è¦‹é€ã‚‹</button>
      </div>
    </section>

    <!-- STEP6 -->
    <section id="step6" class="card hide">
      <h2>STEP6ï½œçµè«–ï¼ˆå›ºå®šæ–‡ï¼‰</h2>
      <p class="sub">
        ã“ã“ã§ã€Œè² ã‘ç­‹ï¼ˆ1ã¤ã ã‘ï¼‰ã€ã‚’ãƒœã‚¿ãƒ³ã§é¸ã¶ã€‚é¸ã¹ãªã„ãªã‚‰è¦‹é€ã‚Šã§OKã€‚
      </p>

      <div class="q">
        <p class="qTitle">è² ã‘ç­‹ï¼ˆ1ã¤ã ã‘ï¼‰</p>
        <div class="btnRow" style="gap:8px;">
          <button class="ghost risk" data-risk="å‰ãŒæ­¢ã¾ã‚‰ãªã„">å‰ãŒæ­¢ã¾ã‚‰ãªã„</button>
          <button class="ghost risk" data-risk="ä½ç½®å–ã‚Šå¾Œã‚ã™ã">ä½ç½®å–ã‚Šå¾Œã‚ã™ã</button>
          <button class="ghost risk" data-risk="å¤–ã€…ãƒ­ã‚¹">å¤–ã€…ãƒ­ã‚¹</button>
          <button class="ghost risk" data-risk="ã‚¹ãƒ”ãƒ¼ãƒ‰è² ã‘">ã‚¹ãƒ”ãƒ¼ãƒ‰è² ã‘</button>
          <button class="ghost risk" data-risk="æ²ã‚Šåˆæˆ¦ã«å·»ãè¾¼ã¾ã‚Œã‚‹">æ²ã‚Šåˆæˆ¦ã«å·»ãè¾¼ã¾ã‚Œã‚‹</button>
          <button class="ghost risk" data-risk="åŒ…ã¾ã‚Œã‚‹/é€²è·¯ãªã—">åŒ…ã¾ã‚Œã‚‹/é€²è·¯ãªã—</button>
          <button class="ghost risk" data-risk="å‡ºé…ã‚Œ">å‡ºé…ã‚Œ</button>
          <button class="ghost risk" data-risk="ç ‚ã‹ã¶ã‚Šï¼ˆãƒ€ãƒ¼ãƒˆï¼‰">ç ‚ã‹ã¶ã‚Šï¼ˆãƒ€ãƒ¼ãƒˆï¼‰</button>
        </div>
        <p class="note">â€»1ã¤ã ã‘ã€‚æŠ¼ã—ãŸã‚‰é¸æŠçŠ¶æ…‹ã«ãªã‚‹ã€‚</p>
      </div>

      <div id="s6_out" class="bigMsg"></div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="primary" id="finalizeBuy">BUYã§ä¿å­˜</button>
        <button class="danger" id="finalizeSkip">è¦‹é€ã‚Šã§ä¿å­˜</button>
        <button class="ghost" id="restart3">æœ€åˆã‹ã‚‰</button>
      </div>

      <div class="q" style="margin-top:14px;">
        <p class="qTitle">ãƒ­ã‚°ï¼ˆCSVï¼‰</p>
        <div class="mono" id="logArea"></div>
        <a class="dl" id="downloadCsv" href="#" download="oji-keiba-log.csv">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
        <p class="note">â€»ãƒ­ã‚°ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã‚‹ï¼ˆlocalStorageï¼‰ã€‚</p>
      </div>
    </section>

    <!-- SKIP -->
    <section id="skip" class="card hide">
      <h2>è¦‹é€ã‚Š</h2>
      <p class="sub">è¦‹é€ã‚Šã¯æ­£è§£ãƒ«ãƒ¼ãƒˆã€‚å‹ã«å¾“ã£ãŸåˆ¤æ–­ã§ã™ã€‚</p>
      <div class="bigMsg">
        <div style="font-weight:1000; margin-bottom:6px;">âœ… è¦‹é€ã‚Šã‚’é¸æŠã—ã¾ã—ãŸ</div>
        <div class="mono" id="skipReason"></div>
        <div style="margin-top:10px; font-size:12px; color:rgba(233,238,252,.7);">
          No bet is a bet.
        </div>
      </div>
      <div class="btnRow" style="margin-top:12px;">
        <button class="primary" id="restart2">æœ€åˆã‹ã‚‰</button>
      </div>
    </section>

  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const toast = $("toast");

  const LOG_KEY = "oji_keiba_log_csv_v2"; // bump version for new columns
  const SAVE_GUARD_MS = 1800;

  const state = {
    // STEP-1
    m1: { date: null, track: null, raceNo: null, label: null },

    step0_q1: null,
    step0_q2: null,
    step1_q3: null,
    step1_q4: null,
    candidates: [],
    eval: {},
    s4: null,

    step5: {
      weight12: null, // "yes"|"no"|"unknown"
      flags: { cancel:false, jockey:false, track:false }
    },

    risk: null,

    // save guard
    lastSaveAt: 0
  };

  // ===== UI helpers =====
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1100);
  }

  function showSection(id){
    ["stepm1","step0","step1","step2","step3_1","step3_2","step3_3","step4","step5","step6","skip"]
      .forEach(s => $(s).classList.add("hide"));
    $(id).classList.remove("hide");
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function showEl(id){ $(id).classList.remove("hide"); }

  function setFromData(setStr){
    if(!setStr) return;
    const [k,v] = setStr.split(":");
    state[k] = v;
  }

  function setTopbarVisible(on){
    const tb = $("topbar");
    if(on) tb.classList.remove("hide");
    else tb.classList.add("hide");
  }

  function updateTopbar(){
    $("tb_date").textContent  = `ğŸ“… ${state.m1.date || "----"}`;
    $("tb_track").textContent = `ğŸŸ ${state.m1.track || "----"}`;
    $("tb_race").textContent  = `ğŸ¯ ${state.m1.raceNo ? state.m1.raceNo + "R" : "--R"}`;
    $("tb_label").textContent = state.m1.label || "----";
  }

  // ===== Date helper =====
  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function nowJST(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  // ===== CSV helpers =====
  function getCsvOrHeader(){
    return localStorage.getItem(LOG_KEY) ||
      `"ts","date","track","raceNo","raceLabel","course","candidates","main","score","weight12","flags","risk","decision"`;
  }

  function setCsv(csv){
    localStorage.setItem(LOG_KEY, csv);
  }

  function appendCsvLine(line){
    const prev = localStorage.getItem(LOG_KEY);
    if(prev) setCsv(prev + "\n" + line);
    else setCsv(getCsvOrHeader() + "\n" + line);
  }

  function parseCsvLines(csv){
    return (csv || "").split(/\r?\n/).filter(x => x.trim().length > 0);
  }

  function countLogsByDate(dateISO){
    const lines = parseCsvLines(getCsvOrHeader());
    // header + rows
    let c = 0;
    for(let i=1;i<lines.length;i++){
      const line = lines[i];
      // naive parse: second field is "date"
      // format: "ts","date","track",...
      const m = line.match(/^"[^"]*","([^"]*)"/);
      if(m && m[1] === dateISO) c++;
    }
    return c;
  }

  function hasSameRaceRecorded(dateISO, track, raceNo){
    const lines = parseCsvLines(getCsvOrHeader());
    for(let i=1;i<lines.length;i++){
      const line = lines[i];
      // "ts","date","track","raceNo",...
      const parts = line.split('","').map(s => s.replace(/^"/,'').replace(/"$/,''));
      const d = parts[1], t = parts[2], r = parts[3];
      if(d === dateISO && t === track && r === String(raceNo)) return true;
    }
    return false;
  }

  // ===== SKIP =====
  function goSkip(reasonKey){
    const map = {
      today_limit: "STEP0ã§çµ‚äº†ï¼šæœ€å¤§3ãƒ¬ãƒ¼ã‚¹/æ—¥ãŒå®ˆã‚Œãªã„ â†’ ä»Šæ—¥ã¯è¦‹é€ã‚Šã€‚",
      money_rule:  "STEP0ã§çµ‚äº†ï¼š500å††å›ºå®šãŒå®ˆã‚Œãªã„ â†’ ã“ã®ãƒ¬ãƒ¼ã‚¹ã¯è¦‹é€ã‚Šã€‚",
      not_target:  "STEP1ã§çµ‚äº†ï¼šé‡è³ã§ã‚‚å¾—æ„æ¡ä»¶ã§ã‚‚ãªã„ â†’ è¦‹é€ã‚Šã€‚",
      user_skip:   "ãŠã˜åˆ¤æ–­ï¼šä»Šå›ã¯è¦‹é€ã‚‹ï¼ˆæ­£è§£ãƒ«ãƒ¼ãƒˆï¼‰ã€‚",
      step5_weight:"STEP5ã§çµ‚äº†ï¼šé¦¬ä½“é‡ å‰èµ°æ¯”Â±12kgä»¥ä¸Š â†’ å¼·åˆ¶è¦‹é€ã‚Šã€‚",
      day_full:    "STEP-1ã§çµ‚äº†ï¼šæœ¬æ—¥3ãƒ¬ãƒ¼ã‚¹ã«åˆ°é” â†’ ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚Šè¦‹é€ã‚Šã€‚",
      dup_race:    "STEP-1ã§çµ‚äº†ï¼šåŒä¸€ãƒ¬ãƒ¼ã‚¹ãŒæ—¢ã«è¨˜éŒ²æ¸ˆã¿ â†’ å¤‰æ›´ or è¦‹é€ã‚Šã€‚"
    };
    $("skipReason").textContent =
      (map[reasonKey] || "è¦‹é€ã‚Šã‚’é¸æŠã—ã¾ã—ãŸã€‚") +
      "\n\n-- çŠ¶æ…‹ --\n" + JSON.stringify(state, null, 2);
    setTopbarVisible(true);
    updateTopbar();
    showSection("skip");
  }

  // Global click handler for data attributes
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;

    setFromData(btn.dataset.set);

    if(btn.dataset.next){
      showEl(btn.dataset.next);
      showToast("æ¬¡ã¸");
    }
    if(btn.dataset.skip){
      goSkip(btn.dataset.skip);
    }
  });

  // ===== STEP-1 (entry) =====
  function buildRaceLabel(){
    if(!state.m1.date || !state.m1.track || !state.m1.raceNo) return null;
    return `${state.m1.date} ${state.m1.track}${state.m1.raceNo}R`;
  }

  function updateM1Preview(){
    const d = $("m1_date").value;
    const t = $("m1_track").value;
    const r = $("m1_raceNo").value;

    state.m1.date = d || null;
    state.m1.track = t || null;
    state.m1.raceNo = r ? parseInt(r, 10) : null;
    state.m1.label = buildRaceLabel();

    const label = state.m1.label || "æœªå…¥åŠ›";
    $("m1_preview").textContent = state.m1.label
      ? `ğŸ“… ${state.m1.date}\nğŸŸ ${state.m1.track}\nğŸ¯ ${state.m1.raceNo}R\n\n${label}`
      : "æœªå…¥åŠ›";

    const dateISO = state.m1.date;
    let dayCount = 0;
    if(dateISO) dayCount = countLogsByDate(dateISO);
    const remain = dateISO ? Math.max(0, 3 - dayCount) : "-";
    $("m1_limits").textContent = dateISO
      ? `æœ¬æ—¥ã®è¨˜éŒ²ï¼š${dayCount}ä»¶ï¼ˆæ®‹ã‚Š${remain}ä»¶ï¼‰`
      : `æœ¬æ—¥ã®è¨˜éŒ²ï¼š- ä»¶ï¼ˆæ®‹ã‚Š - ä»¶ï¼‰`;

    let dupMsg = "";
    if(state.m1.date && state.m1.track && state.m1.raceNo){
      const dup = hasSameRaceRecorded(state.m1.date, state.m1.track, state.m1.raceNo);
      dupMsg = dup ? `âš  ã“ã®ãƒ¬ãƒ¼ã‚¹ã¯æ—¢ã«è¨˜éŒ²æ¸ˆã¿ã§ã™ï¼ˆ${label}ï¼‰` : "";
    }
    $("m1_dup").textContent = dupMsg;

    // enable/disable next
    let canNext = !!(state.m1.date && state.m1.track && state.m1.raceNo);

    // rule: day limit
    if(state.m1.date){
      const dayCountNow = countLogsByDate(state.m1.date);
      if(dayCountNow >= 3){
        canNext = false;
      }
    }

    // rule: duplicate race
    if(state.m1.date && state.m1.track && state.m1.raceNo){
      if(hasSameRaceRecorded(state.m1.date, state.m1.track, state.m1.raceNo)){
        canNext = false;
      }
    }

    $("m1_next").disabled = !canNext;

    // update topbar when filled
    setTopbarVisible(!!(state.m1.date || state.m1.track || state.m1.raceNo));
    updateTopbar();
  }

  $("m1_date").value = todayISO();
  updateM1Preview();

  ["m1_date","m1_track","m1_raceNo"].forEach(id => {
    $(id).addEventListener("change", updateM1Preview);
  });

  $("m1_skip").addEventListener("click", () => goSkip("user_skip"));

  $("m1_next").addEventListener("click", () => {
    if(!state.m1.date || !state.m1.track || !state.m1.raceNo){
      showToast("å…¨éƒ¨é¸ã‚“ã§");
      return;
    }
    // enforce rules again
    const dayCount = countLogsByDate(state.m1.date);
    if(dayCount >= 3){ goSkip("day_full"); return; }
    if(hasSameRaceRecorded(state.m1.date, state.m1.track, state.m1.raceNo)){ goSkip("dup_race"); return; }

    // lock in and proceed
    showSection("step0");
  });

  // ===== STEP0 -> STEP1 =====
  $("goStep1").addEventListener("click", () => {
    if(state.step0_q1 !== "yes"){ return; }
    state.step0_q2 = "yes";
    showSection("step1");
  });

  // ===== STEP1 =====
  function passTarget(summaryLines){
    $("passSummary").textContent = summaryLines.join("\n");
    showEl("step1_pass");
    showToast("å¯¾è±¡OK");
  }

  $("isGradedYes").addEventListener("click", () => {
    state.step1_q3 = "yes";
    state.step1_q4 = "graded";
    passTarget([
      "å¯¾è±¡ï¼šé‡è³ï¼ˆG1ã€œG3ï¼‰",
      "æ³¨æ„ï¼š500å††å›ºå®šï¼æœ€å¤§3ãƒ¬ãƒ¼ã‚¹/æ—¥ã¯çµ¶å¯¾",
      "æ¬¡ï¼šSTEP2ï¼ˆå€™è£œç•ªå·ï¼‰ã¸"
    ]);
  });

  $("isGradedNo").addEventListener("click", () => {
    state.step1_q3 = "no";

    // if track is ãã®ä»– => it is not a preferred condition; still allow normal flow (STEP1_q4 shows)
    showEl("step1_q4");
    showToast("å¾—æ„æ¡ä»¶ã‚’é¸ã¶");
  });

  $("step1_q4").addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn || !btn.dataset.pick) return;

    const pick = btn.dataset.pick;
    state.step1_q4 = pick;

    if(pick === "none"){
      goSkip("not_target");
      return;
    }

    const label = (pick === "nakayama_d1800") ? "ä¸­å±±ãƒ€1800" : "æ±äº¬ãƒ€1600";
    passTarget([
      `å¯¾è±¡ï¼šå¾—æ„æ¡ä»¶ï¼ˆ${label}ï¼‰`,
      "æ³¨æ„ï¼š500å††å›ºå®šï¼æœ€å¤§3ãƒ¬ãƒ¼ã‚¹/æ—¥ã¯çµ¶å¯¾",
      "æ¬¡ï¼šSTEP2ï¼ˆå€™è£œç•ªå·ï¼‰ã¸"
    ]);
  });

  $("goStep2").addEventListener("click", () => showSection("step2"));
  $("skipHere").addEventListener("click", () => goSkip("user_skip"));

  // ===== STEP2 =====
  function parseHorseInput(val){
    const s = (val || "").trim();
    if(s === "") return null;
    if(!/^\d+$/.test(s)) return NaN;
    return parseInt(s, 10);
  }

  function validateCandidates(){
    const n1 = parseHorseInput($("h1").value);
    const n2 = parseHorseInput($("h2").value);
    const n3 = parseHorseInput($("h3").value);

    if(n1 === null){ showToast("é¦¬â‘ ã¯å¿…é ˆ"); return {ok:false}; }
    if(Number.isNaN(n1) || Number.isNaN(n2) || Number.isNaN(n3)){ showToast("æ•°å­—ã®ã¿"); return {ok:false}; }

    const arr = [n1, n2, n3].filter(v => v !== null);
    for(const n of arr){
      if(n < 1 || n > 18){ showToast("ç•ªå·ã¯1ã€œ18"); return {ok:false}; }
    }
    const set = new Set(arr);
    if(set.size !== arr.length){ showToast("åŒã˜ç•ªå·ã¯ä¸å¯"); return {ok:false}; }

    return {ok:true, candidates:arr};
  }

  function initEval(){
    state.eval = {};
    for(const h of state.candidates){
      state.eval[h] = { s1:null, s2:null, s3:null };
    }
  }

  function renderRatings(containerId, key, options){
    const el = $(containerId);
    el.innerHTML = "";
    for(const h of state.candidates){
      const row = document.createElement("div");
      row.className = "row";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = `é¦¬${h}`;
      row.appendChild(badge);

      const seg = document.createElement("div");
      seg.className = "seg";

      for(const opt of options){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "ghost";
        b.textContent = opt;
        b.addEventListener("click", () => {
          state.eval[h][key] = opt;
          [...seg.querySelectorAll("button")].forEach(x => x.classList.remove("on"));
          b.classList.add("on");
          showToast(`é¦¬${h}ï¼š${opt}`);
        });
        seg.appendChild(b);
      }

      row.appendChild(seg);
      el.appendChild(row);
    }
  }

  function allPicked(key){
    return state.candidates.every(h => state.eval[h][key]);
  }

  $("toStep3_1").addEventListener("click", () => {
    const v = validateCandidates();
    if(!v.ok) return;

    state.candidates = v.candidates;
    initEval();
    renderRatings("s31_list","s1",["â—","â—¯","â–³","Ã—"]);
    renderRatings("s32_list","s2",["â—","â—¯","â–³","Ã—"]);
    renderRatings("s33_list","s3",["OK","ä¸å®‰","NG"]);

    showSection("step3_1");
  });

  $("skipFromStep2").addEventListener("click", () => goSkip("user_skip"));

  // ===== STEP3 =====
  $("toStep3_2").addEventListener("click", () => {
    if(!allPicked("s1")){ showToast("â‘ ã‚’å…¨é¦¬é¸æŠ"); return; }
    showSection("step3_2");
  });
  $("skipFromS3_1").addEventListener("click", () => goSkip("user_skip"));

  $("toStep3_3").addEventListener("click", () => {
    if(!allPicked("s2")){ showToast("â‘¡ã‚’å…¨é¦¬é¸æŠ"); return; }
    showSection("step3_3");
  });
  $("skipFromS3_2").addEventListener("click", () => goSkip("user_skip"));

  // ===== STEP4 =====
  const scoreMap12 = { "â—":2, "â—¯":1, "â–³":0, "Ã—":-2 };
  const scoreMap3  = { "OK":0, "ä¸å®‰":-0.5, "NG":-1 };

  function computeStep4(){
    const rows = state.candidates.map(h => {
      const e = state.eval[h];
      const s1 = scoreMap12[e.s1];
      const s2 = scoreMap12[e.s2];
      const s3 = scoreMap3[e.s3];
      const total = s1 + s2 + s3;
      return { h, e, s1, s2, s3, total };
    });

    const sorted = [...rows].sort((a,b) => {
      if(b.total !== a.total) return b.total - a.total;
      if(b.s1 !== a.s1) return b.s1 - a.s1;
      if(b.s2 !== a.s2) return b.s2 - a.s2;
      if(b.s3 !== a.s3) return b.s3 - a.s3;
      return 0;
    });

    const top = sorted[0];
    const sameTotal = sorted.filter(r => r.total === top.total);
    let decided = top;
    let tieUnresolved = false;

    if(sameTotal.length > 1){
      const best = sameTotal.filter(r => r.s1 === Math.max(...sameTotal.map(x=>x.s1)));
      const best2 = best.filter(r => r.s2 === Math.max(...best.map(x=>x.s2)));
      const best3 = best2.filter(r => r.s3 === Math.max(...best2.map(x=>x.s3)));
      if(best3.length === 1) decided = best3[0];
      else tieUnresolved = true;
    }

    const recommendSkip = tieUnresolved || decided.total < 1;
    return { rows, sorted, decided, tieUnresolved, recommendSkip };
  }

  function renderStep4(res){
    const out = $("s4_out");
    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr><th>é¦¬ç•ª</th><th>â‘ </th><th>â‘¡</th><th>â‘¢</th><th class="right">åˆè¨ˆ</th></tr>
      </thead>
      <tbody></tbody>
    `;
    const tb = table.querySelector("tbody");
    for(const r of res.sorted){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="font-weight:1000;">${r.h}</td>
        <td>${r.e.s1}</td>
        <td>${r.e.s2}</td>
        <td>${r.e.s3}</td>
        <td class="right" style="font-weight:1000;">${r.total.toFixed(1)}</td>
      `;
      tb.appendChild(tr);
    }

    const header = document.createElement("div");
    header.style.fontWeight = "1000";
    header.style.marginBottom = "8px";

    const msg = document.createElement("div");
    msg.className = "mono";

    if(res.tieUnresolved){
      header.textContent = "âš ï¸ åŒç‚¹ãŒè§£æ¶ˆã§ããªã„ â†’ è¦‹é€ã‚Šæ¨å¥¨";
      msg.textContent = "åŒç‚¹ãƒ«ãƒ¼ãƒ«ï¼ˆâ‘ â†’â‘¡â†’â‘¢ï¼‰ã§ã‚‚æ±ºã‚ãã‚Œãªã„ã€‚ã“ã“ã§æ­¢ã‚ã‚‹ã®ãŒå‹ã€‚";
    }else{
      header.textContent = `âœ… æœ¬å‘½ï¼šé¦¬${res.decided.h}ï¼ˆåˆè¨ˆ ${res.decided.total.toFixed(1)} ç‚¹ï¼‰`;
      msg.textContent = `å†…è¨³ï¼šâ‘ ${res.decided.e.s1} / â‘¡${res.decided.e.s2} / â‘¢${res.decided.e.s3}\n` +
        (res.decided.total < 1 ? "â€»ãƒˆãƒƒãƒ—ãŒ1ç‚¹æœªæº€ â†’ è¦‹é€ã‚Šæ¨å¥¨" : "");
    }

    out.innerHTML = "";
    out.appendChild(header);
    out.appendChild(table);
    out.appendChild(document.createElement("div")).className = "hr";
    out.appendChild(msg);
  }

  $("toStep4").addEventListener("click", () => {
    if(!allPicked("s3")){ showToast("â‘¢ã‚’å…¨é¦¬é¸æŠ"); return; }
    const res = computeStep4();
    state.s4 = res;
    renderStep4(res);
    showSection("step4");
  });
  $("skipFromS3_3").addEventListener("click", () => goSkip("user_skip"));

  $("skipFromStep4").addEventListener("click", () => goSkip("user_skip"));

  $("goStep5").addEventListener("click", () => {
    // reset step5
    state.step5.weight12 = null;
    state.step5.flags = { cancel:false, jockey:false, track:false };
    $("f_cancel").checked = false;
    $("f_jockey").checked = false;
    $("f_track").checked = false;

    // reset weight buttons UI
    ["w_yes","w_no","w_unknown"].forEach(id => $(id).classList.remove("on"));

    // reset risk
    state.risk = null;
    document.querySelectorAll("button.risk").forEach(b => b.classList.remove("on"));

    showSection("step5");
  });

  // weight button behavior
  function setWeightChoice(v){
    state.step5.weight12 = v;
    ["w_yes","w_no","w_unknown"].forEach(id => $(id).classList.remove("on"));
    if(v === "yes") $("w_yes").classList.add("on");
    if(v === "no") $("w_no").classList.add("on");
    if(v === "unknown") $("w_unknown").classList.add("on");
    showToast(`é¦¬ä½“é‡ï¼š${v === "yes" ? "ã¯ã„" : v === "no" ? "ã„ã„ãˆ" : "ä¸æ˜"}`);
  }
  $("w_yes").addEventListener("click", () => setWeightChoice("yes"));
  $("w_no").addEventListener("click", () => setWeightChoice("no"));
  $("w_unknown").addEventListener("click", () => setWeightChoice("unknown"));

  // ===== STEP5 -> STEP6 =====
  function flagsText(flags){
    const arr = [];
    if(flags.cancel) arr.push("å‡ºèµ°å–æ¶ˆ/æ¡ä»¶å¤‰æ›´");
    if(flags.jockey) arr.push("æ€¥ãªä¹—ã‚Šæ›¿ã‚ã‚Š");
    if(flags.track)  arr.push("é¦¬å ´ã‚ºãƒ¬");
    return arr.length ? arr.join("ãƒ»") : "ãªã—";
  }

  function explainAim(decided){
    const e = decided.e;
    if(e.s1 === "â—" && e.s2 === "â—") return "â‘ â‘¡ãŒæƒã£ã¦ã„ã¦å´©ã‚Œã«ãã„";
    if(e.s1 === "â—" && e.s2 === "â—¯") return "â‘ ã‚’è»¸ã«ã€â‘¡ã¯è¨±å®¹";
    if(e.s1 === "â—¯" && e.s2 === "â—") return "â‘¡ã®å™›ã¿åˆã„ã§å‹è² ";
    if((e.s1 === "Ã—") || (e.s2 === "Ã—")) return "Ã—ãŒæ··ã˜ã‚‹ãŸã‚æ ¹æ‹ ãŒè–„ã„ï¼ˆè¦‹é€ã‚Šå¯„ã‚Šï¼‰";
    return "æ ¹æ‹ ã¯è–„ã‚ã€‚ç„¡ç†ã—ãªã„";
  }

  function buildConclusion(decision){
    const s4 = state.s4;
    const dec = s4?.decided;
    if(!dec) return "ï¼ˆæœ¬å‘½ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";

    const aim = explainAim(dec);
    const condFlags = flagsText(state.step5.flags);
    const w = state.step5.weight12;
    const wText = (w === "yes") ? "ã¯ã„ï¼ˆÂ±12ä»¥ä¸Šï¼‰" : (w === "no") ? "ã„ã„ãˆï¼ˆÂ±11ä»¥å†…ï¼‰" : "ä¸æ˜";

    const lines = [];
    lines.push(`çµè«–ï¼š${decision}`);
    lines.push(`ãƒ¬ãƒ¼ã‚¹ï¼š${state.m1.label || "----"}`);
    lines.push(`æœ¬å‘½ï¼šé¦¬${dec.h}ï¼ˆåˆè¨ˆ ${dec.total.toFixed(1)}ç‚¹ï¼‰`);
    lines.push(`ç‹™ã„ï¼š${aim}`);
    lines.push(`ãƒªã‚¹ã‚¯ï¼š${state.risk || "ï¼ˆæœªé¸æŠï¼‰"}`);
    lines.push(`è²·ã„ç›®ï¼šé¦¬${dec.h} è¤‡å‹1ç‚¹ 500å††`);
    lines.push(`è¦‹é€ã‚Šæ¡ä»¶ï¼šé¦¬ä½“é‡Â±12kgä»¥ä¸Šï¼ç›´å‰æƒ…å ±ãƒ•ãƒ©ã‚°ONï¼ˆ${condFlags}ï¼‰`);
    lines.push(`é¦¬ä½“é‡ãƒã‚§ãƒƒã‚¯ï¼š${wText}`);
    return lines.join("\n");
  }

  function renderStep6(){
    const out = $("s6_out");
    const s4 = state.s4;
    const dec = s4.decided;

    const warn = [];
    if(s4.recommendSkip) warn.push("STEP4ã®åˆ¤å®šï¼šè¦‹é€ã‚Šæ¨å¥¨");
    if(state.step5.flags.cancel || state.step5.flags.jockey || state.step5.flags.track){
      warn.push("STEP5ï¼šç›´å‰æƒ…å ±ãƒ•ãƒ©ã‚°ONï¼ˆè¦‹é€ã‚Šæ¡ä»¶ã«è©²å½“ï¼‰");
    }

    out.innerHTML = "";
    if(warn.length){
      const w = document.createElement("div");
      w.className = "mono";
      w.textContent = "âš ï¸ " + warn.join(" / ");
      out.appendChild(w);
      out.appendChild(document.createElement("div")).className = "hr";
    }

    const autoDecision = (s4.recommendSkip ? "è¦‹é€ã‚Šï¼ˆæ¨å¥¨ï¼‰" : "è²·ã†");
    const pre = document.createElement("div");
    pre.className = "mono";
    pre.textContent = buildConclusion(autoDecision);
    out.appendChild(pre);
  }

  $("toStep6").addEventListener("click", () => {
    // collect flags
    state.step5.flags = {
      cancel: $("f_cancel").checked,
      jockey: $("f_jockey").checked,
      track:  $("f_track").checked
    };

    // enforce weight choice
    if(!state.step5.weight12){
      showToast("é¦¬ä½“é‡ï¼ˆã¯ã„/ã„ã„ãˆ/ä¸æ˜ï¼‰ã‚’é¸ã‚“ã§");
      return;
    }

    // force skip if weight yes
    if(state.step5.weight12 === "yes"){
      goSkip("step5_weight");
      return;
    }

    showSection("step6");
    renderStep6();
    loadLogUI();
  });

  $("skipFromStep5").addEventListener("click", () => goSkip("user_skip"));

  // risk buttons
  document.querySelectorAll("button.risk").forEach(b => {
    b.addEventListener("click", () => {
      document.querySelectorAll("button.risk").forEach(x => x.classList.remove("on"));
      b.classList.add("on");
      state.risk = b.dataset.risk;
      showToast(`è² ã‘ç­‹ï¼š${state.risk}`);
      renderStep6();
    });
  });

  // ===== LOG UI =====
  function loadLogUI(){
    const csv = getCsvOrHeader();
    $("logArea").textContent = csv;
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    $("downloadCsv").href = url;
  }

  function getCourseLabel(){
    // "course" = decision basis category (for your own analysis)
    // We keep it simple.
    if(state.step1_q4 === "graded") return "é‡è³";
    if(state.step1_q4 === "nakayama_d1800") return "ä¸­å±±ãƒ€1800";
    if(state.step1_q4 === "tokyo_d1600") return "æ±äº¬ãƒ€1600";
    return "ä¸æ˜";
  }

  function getCandidatesStr(){
    return state.candidates.join("-");
  }

  function getTop(){
    return state.s4?.decided;
  }

  function isDuplicateLastRow(date, track, raceNo, decision){
    const lines = parseCsvLines(getCsvOrHeader());
    if(lines.length < 2) return false;
    const last = lines[lines.length - 1];
    const parts = last.split('","').map(s => s.replace(/^"/,'').replace(/"$/,''));
    // header: ts(0), date(1), track(2), raceNo(3), ... decision(last)
    return (parts[1] === date && parts[2] === track && parts[3] === String(raceNo) && parts[parts.length-1] === decision);
  }

  function appendLog(decision){
    const top = getTop();
    const flags = flagsText(state.step5.flags);

    const row = [
      nowJST(),
      state.m1.date ?? "",
      state.m1.track ?? "",
      state.m1.raceNo ?? "",
      state.m1.label ?? "",
      getCourseLabel(),
      getCandidatesStr(),
      top ? String(top.h) : "",
      top ? top.total.toFixed(1) : "",
      state.step5.weight12 ?? "",
      flags,
      state.risk ?? "",
      decision
    ].map(x => String(x).replaceAll('"','""'));

    const line = `"${row.join('","')}"`;
    appendCsvLine(line);
  }

  function guardSaveButtons(disabled){
    $("finalizeBuy").disabled = disabled;
    $("finalizeSkip").disabled = disabled;
  }

  function saveWithGuard(decision){
    const now = Date.now();
    if(now - state.lastSaveAt < SAVE_GUARD_MS){
      showToast("é€£æ‰“é˜²æ­¢ï¼šå°‘ã—å¾…ã£ã¦");
      return;
    }

    // simple duplicate check on last row
    if(state.m1.date && state.m1.track && state.m1.raceNo){
      if(isDuplicateLastRow(state.m1.date, state.m1.track, state.m1.raceNo, decision)){
        showToast("åŒã˜å†…å®¹ã¯ä¿å­˜ã—ãªã„");
        return;
      }
    }

    state.lastSaveAt = now;

    guardSaveButtons(true);
    try{
      appendLog(decision);
      showToast("ä¿å­˜ã—ãŸ");
      loadLogUI();
    }finally{
      // re-enable after short delay
      setTimeout(() => guardSaveButtons(false), SAVE_GUARD_MS);
    }
  }

  $("finalizeBuy").addEventListener("click", () => {
    if(!state.risk){
      showToast("è² ã‘ç­‹ã‚’1ã¤é¸ã‚“ã§");
      return;
    }
    saveWithGuard("BUY");
  });

  $("finalizeSkip").addEventListener("click", () => {
    saveWithGuard("SKIP");
  });

  // ===== Restart =====
  function resetAll(){
    // keep log
    state.step0_q1 = null;
    state.step0_q2 = null;
    state.step1_q3 = null;
    state.step1_q4 = null;
    state.candidates = [];
    state.eval = {};
    state.s4 = null;
    state.step5 = { weight12:null, flags:{cancel:false,jockey:false,track:false} };
    state.risk = null;
    state.lastSaveAt = 0;

    // reset UI bits
    $("step0_q2").classList.add("hide");
    $("step1_q4").classList.add("hide");
    $("step1_pass").classList.add("hide");

    $("h1").value = ""; $("h2").value = ""; $("h3").value = "";
    $("s31_list").innerHTML = ""; $("s32_list").innerHTML = ""; $("s33_list").innerHTML = "";
    $("s4_out").innerHTML = "";

    $("f_cancel").checked = false; $("f_jockey").checked = false; $("f_track").checked = false;
    ["w_yes","w_no","w_unknown"].forEach(id => $(id).classList.remove("on"));
    document.querySelectorAll("button.risk").forEach(b => b.classList.remove("on"));
    $("s6_out").innerHTML = "";

    // return to entry step
    showSection("stepm1");
    showToast("ãƒªã‚»ãƒƒãƒˆ");
    updateM1Preview();
    loadLogUI();
  }

  $("restart").addEventListener("click", resetAll);
  $("restart2").addEventListener("click", resetAll);
  $("restart3").addEventListener("click", resetAll);
  $("tb_restart").addEventListener("click", resetAll);

  // ===== small: topbar always on after step-1 =====
  function afterEntryTopbarOn(){
    setTopbarVisible(true);
    updateTopbar();
  }

  // whenever leaving entry step, show topbar
  const origShowSection = showSection;
  showSection = function(id){
    origShowSection(id);
    if(id !== "stepm1") afterEntryTopbarOn();
    if(id === "stepm1") setTopbarVisible(!!(state.m1.date || state.m1.track || state.m1.raceNo));
  };

  // Init
  loadLogUI();
  showSection("stepm1");
})();
</script>
</body>
</html>
