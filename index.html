<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŠã˜.exeï¼ˆç«¶é¦¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2f;
      --card2:#0e1730;
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --muted2:rgba(234,240,255,.55);
      --good:#38d981;
      --warn:#ffb020;
      --bad:#ff5d73;
      --btn:#e9f0ff;
      --btnText:#0c1220;
      --btn2:#192748;
      --btn2Text:#eaf0ff;
      --radius:16px;
      --pad:16px;
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans:-apple-system, system-ui, "Hiragino Sans", "Noto Sans JP", sans-serif;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(100,140,255,.18), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(255,120,170,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:820px; margin:0 auto; padding:24px 16px 40px; }
    .header{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:22px;
      padding:18px 18px 14px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
    }
    .title{ font-weight:800; font-size:22px; letter-spacing:.2px; }
    .sub{ margin-top:6px; color:var(--muted); line-height:1.55; }
    .chips{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .chip{
      border:1px solid var(--line);
      color:var(--muted);
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      font-size:13px;
      white-space:nowrap;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px;
      margin:14px 0;
    }
    .card h2{
      margin:0 0 10px;
      font-size:18px;
      letter-spacing:.2px;
    }
    .note{ color:var(--muted); font-size:13px; line-height:1.55; }
    .hr{ height:1px; background:var(--line); margin:14px 0; }

    label{ display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(8,12,24,.55);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(234,240,255,.35); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .col{ flex:1; min-width:180px; }
    .btnRow{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:none;
      border-radius:16px;
      padding:14px 14px;
      font-weight:800;
      cursor:pointer;
    }
    button.primary{
      background:var(--btn);
      color:var(--btnText);
      flex:1;
      min-width:210px;
    }
    button.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--btn2Text);
      flex:1;
      min-width:210px;
    }
    button.danger{
      background:rgba(255,93,115,.12);
      border:1px solid rgba(255,93,115,.35);
      color:#ffd3da;
      flex:1;
      min-width:210px;
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter:saturate(.6);
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.03);
      font-size:12px;
      color:var(--muted);
      margin-right:8px;
      margin-bottom:8px;
    }
    .big{
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .ok{ color:var(--good); }
    .ng{ color:var(--bad); }
    .warn{ color:var(--warn); }

    .qbox{
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      background: rgba(0,0,0,.15);
      margin-top:12px;
    }
    .qtitle{ font-weight:900; font-size:16px; margin:0 0 10px; }
    .choices{ display:flex; gap:10px; flex-wrap:wrap; }
    .choice{
      flex:1;
      min-width:140px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      font-weight:800;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .choice.on{
      background:rgba(233,240,255,.92);
      color:#0b1220;
      border-color:rgba(233,240,255,.92);
    }
    .choice.bad.on{
      background:rgba(255,93,115,.20);
      color:#ffd3da;
      border-color:rgba(255,93,115,.45);
    }

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.16);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      text-align:left;
    }
    th{ color:var(--muted); font-weight:800; }
    tr:last-child td{ border-bottom:none; }
    .mono{ font-family:var(--mono); }
    .small{ font-size:12px; color:var(--muted2); line-height:1.5; }

    .footer{
      margin-top:16px;
      color:var(--muted2);
      font-size:12px;
      line-height:1.55;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">ãŠã˜.exeï¼ˆç«¶é¦¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰</div>
      <div class="sub">
        ç›®çš„ï¼šè¿·ã‚ãªã„ï¼æ„Ÿæƒ…ã§è²·ã‚ãªã„ï¼æ±ºã‚ãŸæ‰‹é †é€šã‚Šã«å‹•ã<br>
        â€»ãƒ­ã‚°ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰ã«ã ã‘ä¿å­˜ã€‚å¤–ã«ã¯é€ã‚‰ã‚Œãªã„ã€‚
      </div>
      <div class="chips">
        <div class="chip">è¤‡å‹1ç‚¹</div>
        <div class="chip">1R 500å††</div>
        <div class="chip">æœ€å¤§3ãƒ¬ãƒ¼ã‚¹/æ—¥</div>
        <div class="chip">åˆè¨€è‘‰ï¼šå½“ã¦ã«ã„ããªã€å£Šã‚Œã‚‹ãª</div>
      </div>
    </div>

    <!-- STEP-1: ãƒ¬ãƒ¼ã‚¹æƒ…å ± -->
    <div class="card" id="cardRace">
      <h2>å…¥å£ï½œãƒ¬ãƒ¼ã‚¹ã‚’å›ºå®šï¼ˆæˆ»ã‚‰ãªã„ï¼‰</h2>
      <div class="note">ã“ã“ã§ã€Œä»Šæ—¥ã©ã®ãƒ¬ãƒ¼ã‚¹ã‚’å¯¾è±¡ã«ã™ã‚‹ã‹ã€ã‚’å›ºå®šã—ã¾ã™ã€‚ã“ã®å…ˆã¯æˆ»ã£ã¦å¤‰æ›´ã—ã¾ã›ã‚“ã€‚</div>

      <div class="row">
        <div class="col">
          <label>æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰</label>
          <input id="date" type="date" />
        </div>
        <div class="col">
          <label>ç«¶é¦¬å ´</label>
          <select id="track">
            <option value="ä¸­å±±">ä¸­å±±</option>
            <option value="æ±äº¬">æ±äº¬</option>
            <option value="äº¬éƒ½">äº¬éƒ½</option>
            <option value="é˜ªç¥">é˜ªç¥</option>
            <option value="ä¸­äº¬">ä¸­äº¬</option>
            <option value="æœ­å¹Œ">æœ­å¹Œ</option>
            <option value="å‡½é¤¨">å‡½é¤¨</option>
            <option value="ç¦å³¶">ç¦å³¶</option>
            <option value="æ–°æ½Ÿ">æ–°æ½Ÿ</option>
            <option value="å°å€‰">å°å€‰</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="col">
          <label>ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
          <select id="raceNo">
            <option value="1R">1R</option><option value="2R">2R</option><option value="3R">3R</option><option value="4R">4R</option>
            <option value="5R">5R</option><option value="6R">6R</option><option value="7R">7R</option><option value="8R">8R</option>
            <option value="9R">9R</option><option value="10R">10R</option><option value="11R">11R</option><option value="12R">12R</option>
          </select>
          <div class="small">â€»æ‰‹å…¥åŠ›ä¸å¯ã€‚å¿…ãšé¸æŠã€‚</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>ã‚¯ãƒ©ã‚¹ï¼ˆé¸æŠè‚¢ï¼‰</label>
          <select id="raceClass">
            <option value="G1">G1</option>
            <option value="G2">G2</option>
            <option value="G3">G3</option>
            <option value="OP/L">OP/L</option>
            <option value="3å‹">3å‹ã‚¯ãƒ©ã‚¹</option>
            <option value="2å‹">2å‹ã‚¯ãƒ©ã‚¹</option>
            <option value="1å‹">1å‹ã‚¯ãƒ©ã‚¹</option>
            <option value="æœªå‹åˆ©">æœªå‹åˆ©</option>
            <option value="æ–°é¦¬">æ–°é¦¬</option>
          </select>
        </div>

        <div class="col">
          <label>å¾—æ„æ¡ä»¶ï¼ˆã‚³ãƒ¼ã‚¹ï¼‰</label>
          <select id="course">
            <option value="ä¸­å±±ãƒ€1800">ä¸­å±±ãƒ€1800</option>
            <option value="æ±äº¬ãƒ€1600">æ±äº¬ãƒ€1600</option>
            <option value="æ±äº¬èŠ1400">æ±äº¬èŠ1400ï¼ˆåœæ­¢ä¸­ï¼‰</option>
            <option value="é‡è³">é‡è³ï¼ˆG1ã€œG3ï¼‰</option>
            <option value="ãã®ä»–">ãã®ä»–ï¼ˆåŸºæœ¬è¦‹é€ã‚Šï¼‰</option>
          </select>
          <div class="small">â€»ã€Œæ±äº¬èŠ1400ã€ã¯ã„ã¾åœæ­¢æ‰±ã„ã€‚ã‚„ã‚ŠãŸããªã£ãŸã‚‰å¾Œã§è§£é™¤ã§ãã¾ã™ã€‚</div>
        </div>
      </div>

      <div class="qbox">
        <div class="qtitle">ã“ã®ãƒ¬ãƒ¼ã‚¹ï¼ˆè‡ªå‹•è¡¨ç¤ºï¼‰</div>
        <div id="raceSummary" class="note"></div>
        <div class="hr"></div>
        <div id="todayCounter" class="note"></div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep0">æ¬¡ã¸ï¼ˆSTEP0ã¸ï¼‰</button>
        <button class="danger" id="btnSkipToday">ä»Šæ—¥ã¯è¦‹é€ã‚‹ï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰</button>
      </div>

      <div class="footer">
        ã€Œä»Šæ—¥ã¯è¦‹é€ã‚‹ã€ã¯æ­£è§£ãƒ«ãƒ¼ãƒˆã€‚ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚‹æ–¹ãŒå›åç‡ãŒä¸ŠãŒã‚‹ã€‚
      </div>
    </div>

    <!-- STEP0 -->
    <div class="card" id="cardStep0" style="display:none;">
      <h2>STEP0ï½œå‰æç¢ºèªï¼ˆ10ç§’ï¼‰</h2>
      <div class="note">No ãŒ1ã¤ã§ã‚‚å‡ºãŸã‚‰ã€ãã®æ™‚ç‚¹ã§çµ‚äº†ï¼ˆä»Šæ—¥ã¯è¦‹é€ã‚Šï¼‰ã€‚</div>

      <div class="qbox">
        <div class="qtitle">Q1ï¼šä»Šæ—¥ã¯æœ€å¤§3ãƒ¬ãƒ¼ã‚¹ã¾ã§ã€ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚Œã‚‹ï¼Ÿ</div>
        <div class="choices">
          <div class="choice" data-q="s0q1" data-v="yes">ã¯ã„</div>
          <div class="choice bad" data-q="s0q1" data-v="no">ã„ã„ãˆ</div>
        </div>
      </div>

      <div class="qbox">
        <div class="qtitle">Q2ï¼šã“ã®ãƒ¬ãƒ¼ã‚¹ã« 500å††ã ã‘ ä½¿ãˆã‚‹ï¼Ÿï¼ˆå¢—ã‚„ã•ãªã„ï¼‰</div>
        <div class="choices">
          <div class="choice" data-q="s0q2" data-v="yes">ã¯ã„</div>
          <div class="choice bad" data-q="s0q2" data-v="no">ã„ã„ãˆ</div>
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep1">æ¬¡ã¸ï¼ˆSTEP1ã¸ï¼‰</button>
        <button class="secondary" id="btnBackToRace">æˆ»ã‚‹ï¼ˆãƒ¬ãƒ¼ã‚¹å›ºå®šã¸ï¼‰</button>
        <button class="danger" id="btnSkipFrom0">ä»Šå›ã¯è¦‹é€ã‚‹ï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰</button>
      </div>
    </div>

    <!-- STEP1 -->
    <div class="card" id="cardStep1" style="display:none;">
      <h2>STEP1ï½œå¯¾è±¡ãƒ¬ãƒ¼ã‚¹åˆ¤å®šï¼ˆå³æ–­ï¼‰</h2>
      <div class="note">
        ã€Œé‡è³ï¼ˆG1ã€œG3ï¼‰ã€ã¾ãŸã¯ã€Œå¾—æ„æ¡ä»¶ã€ãªã‚‰é€²ã‚€ã€‚ãã‚Œä»¥å¤–ã¯è¦‹é€ã‚Šã€‚
      </div>

      <div class="qbox">
        <div class="qtitle">Qï¼šã“ã®ãƒ¬ãƒ¼ã‚¹ã¯å¯¾è±¡ï¼Ÿ</div>
        <div id="step1Auto" class="note"></div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep2">æ¬¡ã¸ï¼ˆSTEP2ã¸ï¼‰</button>
        <button class="danger" id="btnSkipFrom1">å¯¾è±¡å¤– â†’ è¦‹é€ã‚Šï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰</button>
        <button class="secondary" id="btnBackTo0">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- STEP2 -->
    <div class="card" id="cardStep2" style="display:none;">
      <h2>STEP2ï½œå€™è£œé¦¬ã‚’æœ€å¤§3é ­ã¾ã§å‡ºã™</h2>
      <div class="note">
        äººæ°—ãƒ»ã‚ªãƒƒã‚ºãƒ»è©•ä¾¡ã¯ã¾ã è¦‹ãªã„ã€‚<br>
        ã€Œã“ã®æ¡ä»¶ã§å¤‰ãªè² ã‘æ–¹ã—ã«ããã†ã€ãªé¦¬ã ã‘æ‹¾ã†ã€‚3é ­å‡ºãªã‘ã‚Œã°è¦‹é€ã‚Šå¯ã€‚
      </div>

      <label>å€™è£œï¼ˆé¦¬ç•ªï¼‰ ä¾‹ï¼š6,13,15</label>
      <input id="candidates" placeholder="ä¾‹ï¼š6,13,15ï¼ˆæœ€å¤§3é ­ï¼‰" inputmode="numeric" />

      <label>è£œè¶³ï¼ˆä»»æ„ï¼‰</label>
      <input id="candMemo" placeholder="ä¾‹ï¼š6=å‰å—ã‘ã§ãã‚‹ã€13=å®‰å®šã€15=å´©ã‚Œã«ãã„" />

      <div class="btnRow">
        <button class="primary" id="btnGoStep3">æ¬¡ã¸ï¼ˆSTEP3ã¸ï¼‰</button>
        <button class="danger" id="btnSkipFrom2">å€™è£œãŒå‡ºãªã„ â†’ è¦‹é€ã‚Šï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰</button>
        <button class="secondary" id="btnBackTo1">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- STEP3 -->
    <div class="card" id="cardStep3" style="display:none;">
      <h2>STEP3ï½œä¸‰æœ¬æŸ±ãƒã‚§ãƒƒã‚¯ï¼ˆYes / No ã‚’â€œé¸æŠè‚¢â€ã§ï¼‰</h2>
      <div class="note">
        â‘ ã‚³ãƒ¼ã‚¹Ã—è·é›¢ï¼ˆæœ€å„ªå…ˆï¼‰ï¼â‘¡æµã‚ŒÃ—è„šè³ªï¼ˆè² ã‘ç­‹1ã¤ï¼‰ï¼â‘¢é¨æ‰‹ï¼ˆæ¸›ç‚¹å°‚ç”¨ï¼‰ã€‚<br>
        å„é¦¬ã”ã¨ã«å…¥åŠ›ã—ã¦ã„ãã€‚
      </div>

      <div class="qbox">
        <div class="qtitle">å¯¾è±¡é¦¬</div>
        <div id="horseTabs" class="note"></div>
        <div class="small">ã‚¿ãƒ–ã§é¦¬ã‚’åˆ‡ã‚Šæ›¿ãˆã¦å…¥åŠ›ã€‚å…¨éƒ¨åŸ‹ã‚ãªã„ã¨æ¬¡ã¸é€²ã‚ãªã„ã€‚</div>
      </div>

      <div id="horseForms"></div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep4">æ¬¡ã¸ï¼ˆSTEP4 ç‚¹æ•°åŒ–ã¸ï¼‰</button>
        <button class="secondary" id="btnBackTo2">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- STEP4 -->
    <div class="card" id="cardStep4" style="display:none;">
      <h2>STEP4ï½œç‚¹æ•°åŒ–ï¼ˆæ©Ÿæ¢°çš„ã«æœ¬å‘½ã‚’æ±ºã‚ã‚‹ï¼‰</h2>
      <div class="note">
        åˆè¨ˆç‚¹ = â‘  + â‘¡ + â‘¢ï¼ˆâ‘¢ã¯æ¸›ç‚¹/æ¶ˆã—ï¼‰ã€‚ãƒˆãƒƒãƒ—ãŒæœ¬å‘½ã€‚<br>
        åŒç‚¹ãªã‚‰ â‘  â†’ â‘¡ â†’ â‘¢ â†’ ãã‚Œã§ã‚‚åŒç‚¹ãªã‚‰è¦‹é€ã‚Šã€‚ã•ã‚‰ã«ãƒˆãƒƒãƒ—ãŒ1ç‚¹æœªæº€ãªã‚‰è¦‹é€ã‚Šæ¨å¥¨ã€‚
      </div>

      <div class="qbox">
        <div class="qtitle" id="mainPickTitle">çµæœ</div>
        <div id="scoreTable"></div>
        <div id="step4Msg" class="note" style="margin-top:10px;"></div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep5">æ¬¡ã¸ï¼ˆSTEP5 0ç•ªãƒã‚§ãƒƒã‚¯ã¸ï¼‰</button>
        <button class="danger" id="btnSkipFrom4">ä»Šå›ã¯è¦‹é€ã‚‹ï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰</button>
        <button class="secondary" id="btnBackTo3">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- STEP5 -->
    <div class="card" id="cardStep5" style="display:none;">
      <h2>STEP5ï½œ0ç•ªãƒã‚§ãƒƒã‚¯ï¼ˆæœ€çµ‚ãƒ–ãƒ¬ãƒ¼ã‚­ï¼‰</h2>
      <div class="note">
        ãƒ‘ãƒ‰ãƒƒã‚¯ã¯â€œã‚„ã‚‰ãªã„å‰æâ€ã§OKã€‚ä»£ã‚ã‚Šã«ã€Œé¦¬ä½“é‡Â±12kgã€ã¨ã€Œç›´å‰æƒ…å ±ãƒ•ãƒ©ã‚°ã€ã ã‘å¿…é ˆã«ã™ã‚‹ã€‚
      </div>

      <div class="qbox">
        <div class="qtitle">Q1ï¼šé¦¬ä½“é‡ å‰èµ°æ¯” Â±12kgä»¥ä¸Š ã§ã™ã‹ï¼Ÿ</div>
        <div class="choices">
          <div class="choice" data-q="s5w" data-v="yes">ã¯ã„ï¼ˆÂ±12kgä»¥ä¸Šï¼‰</div>
          <div class="choice bad" data-q="s5w" data-v="no">ã„ã„ãˆï¼ˆÂ±11kgä»¥å†…ï¼‰</div>
        </div>
      </div>

      <div class="qbox">
        <div class="qtitle">Q2ï¼šç›´å‰æƒ…å ±ï¼ˆå–æ¶ˆãƒ»å¤§å¹…é¦¬å ´æ‚ªåŒ–ãƒ»ä¸å®‰ææ–™ãªã©ï¼‰ãŒå‡ºãŸï¼Ÿ</div>
        <div class="choices">
          <div class="choice" data-q="s5info" data-v="yes">ã¯ã„ï¼ˆä¸å®‰ã‚ã‚Šï¼‰</div>
          <div class="choice bad" data-q="s5info" data-v="no">ã„ã„ãˆï¼ˆãªã—ï¼‰</div>
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnGoStep6">æ¬¡ã¸ï¼ˆSTEP6 çµè«–ã¸ï¼‰</button>
        <button class="secondary" id="btnBackTo4">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- STEP6 -->
    <div class="card" id="cardStep6" style="display:none;">
      <h2>STEP6ï½œçµè«–ï¼ˆå›ºå®šæ–‡ï¼‰</h2>
      <div class="note">
        ã€Œç‹™ã„ã€ã€Œãƒªã‚¹ã‚¯ï¼ˆè² ã‘ç­‹1ã¤ï¼‰ã€ã¯ã€æœ€å¾Œã«1è¡Œã§è¨€èªåŒ–ã€‚æ›¸ã‘ãªã„ãªã‚‰è¦‹é€ã‚Šã§OKã€‚
      </div>

      <div class="qbox">
        <div class="qtitle">çµè«–</div>
        <div id="finalSummary" class="note"></div>
      </div>

      <label>ãƒªã‚¹ã‚¯ï¼ˆè² ã‘ç­‹ï¼‰â€»1ã¤ã ã‘</label>
      <input id="riskOne" placeholder="ä¾‹ï¼šå¤–ã€…ã‚’å›ã£ã¦å·®ã•ã‚Œã‚‹ï¼å‰ãŒæ­¢ã¾ã‚‰ãªã„ ãªã©" />

      <label>è¦‹é€ã‚Šæ¡ä»¶ï¼ˆç¢ºèªç”¨ï¼‰</label>
      <textarea id="skipCond" readonly></textarea>

      <div class="btnRow">
        <button class="primary" id="btnSaveBuy">BUYã§ä¿å­˜ï¼ˆãƒ­ã‚°ï¼‰</button>
        <button class="danger" id="btnSaveSkip">è¦‹é€ã‚Šã§ä¿å­˜ï¼ˆãƒ­ã‚°ï¼‰</button>
        <button class="secondary" id="btnBackTo5">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- LOG -->
    <div class="card" id="cardLog">
      <h2>ãƒ­ã‚°ï¼ˆCSVï¼‰</h2>
      <div class="note">ä¿å­˜å…ˆï¼šã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã€‚æ©Ÿç¨®å¤‰æ›´ã‚„ãƒ–ãƒ©ã‚¦ã‚¶å¤‰æ›´ã§æ¶ˆãˆã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚</div>
      <div class="hr"></div>

      <div class="btnRow">
        <button class="secondary" id="btnCopyCSV">CSVã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="secondary" id="btnDownloadCSV">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button class="danger" id="btnClearLog">ãƒ­ã‚°å…¨æ¶ˆã—</button>
      </div>

      <div class="hr"></div>
      <div class="small mono" id="logPreview"></div>
    </div>

    <div class="footer">
      è¿·ã£ãŸã‚‰è¦‹é€ã‚Šï¼ˆNo bet is a betï¼‰ã€‚é€”ä¸­ã§æˆ»ã‚‰ãªã„ã€‚æ„Ÿæƒ…ã‚’æŒŸã¾ãªã„ã€‚
    </div>
  </div>

<script>
(() => {
  // ====== storage ======
  const KEY = "oji_keiba_logs_v2";
  const loadLogs = () => {
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  };
  const saveLogs = (logs) => localStorage.setItem(KEY, JSON.stringify(logs));

  // ====== utils ======
  const todayISO = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  };
  const nowStr = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${dd} ${hh}:${mm}`;
  };
  const clamp3 = (arr) => arr.slice(0,3);

  const normalizeCandidates = (s) => {
    const nums = (s || "")
      .split(/[,\sã€]+/)
      .map(x => x.trim())
      .filter(Boolean)
      .map(x => x.replace(/[^\d]/g,""))
      .filter(Boolean)
      .map(x => String(parseInt(x,10)))
      .filter(x => x !== "NaN");
    const uniq = [...new Set(nums)];
    return clamp3(uniq);
  };

  const el = (id) => document.getElementById(id);
  const show = (id) => el(id).style.display = "";
  const hide = (id) => el(id).style.display = "none";

  // ====== rules ======
  // course value => allowed? based on step1 logic
  const isG = (cls) => ["G1","G2","G3"].includes(cls);
  const isTokyo1400Paused = (course) => course.startsWith("æ±äº¬èŠ1400");

  const isTargetRace = ({course, raceClass}) => {
    if (isG(raceClass)) return true;
    if (course === "ä¸­å±±ãƒ€1800") return true;
    if (course === "æ±äº¬ãƒ€1600") return true;
    if (course.startsWith("æ±äº¬èŠ1400")) return false; // åœæ­¢ä¸­
    if (course === "é‡è³") return true; // ãŸã ã—ã‚¯ãƒ©ã‚¹ã¯G1-3æƒ³å®š
    return false;
  };

  // ====== state ======
  const state = {
    race: {
      date: todayISO(),
      track: "ä¸­å±±",
      raceNo: "12R",
      raceClass: "3å‹",
      course: "ä¸­å±±ãƒ€1800",
    },
    step0: { q1:null, q2:null },
    candidates: [],
    candMemo: "",
    perHorse: {},  // horseNo -> answers
    step5: { weight:null, info:null },
    pick: { main:null, scores:[], msg:"" },
    final: { risk:"" }
  };

  // ====== init inputs ======
  el("date").value = state.race.date;
  el("track").value = state.race.track;
  el("raceNo").value = state.race.raceNo;
  el("raceClass").value = state.race.raceClass;
  el("course").value = state.race.course;

  const updateRaceSummary = () => {
    const r = state.race;
    el("raceSummary").innerHTML =
      `<div class="tag">ğŸ“… ${r.date}</div>` +
      `<div class="tag">ğŸŸï¸ ${r.track}</div>` +
      `<div class="tag">ğŸ¯ ${r.raceNo}</div>` +
      `<div class="tag">ğŸ·ï¸ ${r.raceClass}</div>` +
      `<div class="tag">â­ ${r.course}</div>` +
      `<div class="hr"></div>` +
      `<div class="mono">${r.date} ${r.track}${r.raceNo}ï¼ˆ${r.raceClass} / ${r.course}ï¼‰</div>`;

    // daily counter
    const logs = loadLogs();
    const todays = logs.filter(x => x.date === r.date);
    const left = Math.max(0, 3 - todays.length);
    el("todayCounter").innerHTML =
      `æœ¬æ—¥ã®è¨˜éŒ²ï¼š<b>${todays.length}</b>ä»¶ï¼ˆæ®‹ã‚Š<b>${left}</b>ä»¶ï¼‰<br>` +
      `<span class="small">â€»3ä»¶ã«é”ã—ãŸã‚‰ã€ä»Šæ—¥ã¯â€œé€²ã‚ãªã„â€ã®ãŒæ­£è§£ï¼ˆæš´èµ°é˜²æ­¢ï¼‰ã€‚</span>`;

    // enable/disable go
    el("btnGoStep0").disabled = (left <= 0);
    el("btnSkipToday").disabled = false;
  };

  ["date","track","raceNo","raceClass","course"].forEach(id => {
    el(id).addEventListener("change", () => {
      state.race.date = el("date").value || todayISO();
      state.race.track = el("track").value;
      state.race.raceNo = el("raceNo").value;
      state.race.raceClass = el("raceClass").value;
      state.race.course = el("course").value;
      updateRaceSummary();
    });
  });
  updateRaceSummary();

  // ====== navigation helpers ======
  const go = (cardId) => {
    ["cardRace","cardStep0","cardStep1","cardStep2","cardStep3","cardStep4","cardStep5","cardStep6"].forEach(hide);
    show(cardId);
    window.scrollTo({top:0, behavior:"smooth"});
    refreshLogUI();
  };

  // ====== choice buttons ======
  const setChoice = (q, v) => {
    document.querySelectorAll(`.choice[data-q="${q}"]`).forEach(x => x.classList.remove("on"));
    const target = document.querySelector(`.choice[data-q="${q}"][data-v="${v}"]`);
    if (target) target.classList.add("on");
  };
  document.addEventListener("click", (e) => {
    const t = e.target.closest(".choice");
    if (!t) return;
    const q = t.dataset.q;
    const v = t.dataset.v;

    if (q === "s0q1") state.step0.q1 = v;
    if (q === "s0q2") state.step0.q2 = v;
    if (q === "s5w") state.step5.weight = v;
    if (q === "s5info") state.step5.info = v;

    setChoice(q, v);

    // auto-stop on STEP0 No
    if ((q === "s0q1" || q === "s0q2") && v === "no") {
      // nothing forced, but user can choose skip button
    }
  });

  // ====== step1 auto message ======
  const refreshStep1 = () => {
    const ok = isTargetRace(state.race);
    const r = state.race;
    let msg = "";
    if (isG(r.raceClass)) {
      msg = `ã‚¯ãƒ©ã‚¹ãŒ <b>${r.raceClass}</b> â†’ <b class="ok">é‡è³ãªã®ã§å¯¾è±¡</b>ï¼ˆSTEP2ã¸é€²ã‚ã‚‹ï¼‰`;
    } else if (r.course === "ä¸­å±±ãƒ€1800" || r.course === "æ±äº¬ãƒ€1600") {
      msg = `å¾—æ„æ¡ä»¶ãŒ <b>${r.course}</b> â†’ <b class="ok">å¯¾è±¡</b>ï¼ˆSTEP2ã¸é€²ã‚ã‚‹ï¼‰`;
    } else if (isTokyo1400Paused(r.course)) {
      msg = `å¾—æ„æ¡ä»¶ãŒ <b>${r.course}</b> â†’ <b class="ng">åœæ­¢ä¸­ãªã®ã§å¯¾è±¡å¤–ï¼ˆè¦‹é€ã‚Šï¼‰</b>`;
    } else if (r.course === "é‡è³") {
      msg = `å¾—æ„æ¡ä»¶ãŒ <b>é‡è³</b> â†’ ã‚¯ãƒ©ã‚¹ãŒG1ã€œG3ãªã‚‰<b class="ok">å¯¾è±¡</b>ã€‚ã„ã¾ã¯ <b>${r.raceClass}</b> ãªã®ã§ ${isG(r.raceClass) ? '<b class="ok">OK</b>' : '<b class="ng">å¯¾è±¡å¤–</b>'}ã€‚`;
    } else {
      msg = `ã‚³ãƒ¼ã‚¹ãŒ <b>${r.course}</b> ï¼ã‚¯ãƒ©ã‚¹ãŒ <b>${r.raceClass}</b> â†’ <b class="ng">å¯¾è±¡å¤–ï¼ˆè¦‹é€ã‚Šï¼‰</b>`;
    }
    el("step1Auto").innerHTML = msg + `<div class="hr"></div><div class="small">â€»å¯¾è±¡å¤–ãªã‚‰ã€Œè¦‹é€ã‚Šã€ã§ãƒ­ã‚°ä¿å­˜ãŒæ­£è§£ãƒ«ãƒ¼ãƒˆã€‚</div>`;
    el("btnGoStep2").disabled = !ok;
    el("btnSkipFrom1").disabled = ok; // å¯¾è±¡ãªã‚‰èª¤ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
  };

  // ====== step3 forms ======
  const scorePillar = (yesCount) => {
    // 3å•ä¸­ yesCount
    // 2ä»¥ä¸Šâ†’2ç‚¹ã€1â†’1ç‚¹ã€0â†’0ç‚¹
    if (yesCount >= 2) return 2;
    if (yesCount === 1) return 1;
    return 0;
  };

  const buildHorseForms = () => {
    const horses = state.candidates;
    state.perHorse = state.perHorse || {};

    // tabs
    el("horseTabs").innerHTML = horses.map((h,i)=>`<span class="tag">ğŸ é¦¬${h}</span>`).join("");

    // forms
    const wrap = document.createElement("div");
    horses.forEach((h) => {
      if (!state.perHorse[h]) {
        state.perHorse[h] = {
          p1a:null, p1b:null, p1c:null,
          p2a:null, p2b:null, p2c:null,
          j:null, j2:null,
          pace:"æ™®",
          style:"å…ˆè¡Œ",
          jockeyMemo:""
        };
      }

      const box = document.createElement("div");
      box.className = "qbox";
      box.style.marginTop = "14px";
      box.innerHTML = `
        <div class="qtitle">é¦¬${h}ï½œâ‘ ã‚³ãƒ¼ã‚¹Ã—è·é›¢ï¼ˆæœ€å„ªå…ˆï¼‰</div>
        ${qYN(`p1a_${h}`, `é¡ä¼¼æ¡ä»¶ã§å¥½èµ° or å´©ã‚Œã¦ã„ãªã„ï¼Ÿ`)}
        ${qYN(`p1b_${h}`, `æ ãŒè„šè³ªçš„ã«è‡´å‘½çš„ã§ãªã„ï¼Ÿ`)}
        ${qYN(`p1c_${h}`, `4è§’ã§å‹è² åœã«ã„ã‚‰ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå³å‡ºã‚‹ï¼Ÿ`)}

        <div class="hr"></div>
        <div class="qtitle">é¦¬${h}ï½œâ‘¡æµã‚ŒÃ—è„šè³ªï¼ˆè² ã‘ã«ãã•ï¼‰</div>
        <label>æƒ³å®šãƒšãƒ¼ã‚¹ï¼ˆ1ã¤ã«æ±ºã‚ã‚‹ï¼‰</label>
        <select id="pace_${h}">
          <option value="é…">é…</option>
          <option value="æ™®">æ™®</option>
          <option value="é€Ÿ">é€Ÿ</option>
        </select>
        <label>è„šè³ªï¼ˆã–ã£ãã‚Šï¼‰</label>
        <select id="style_${h}">
          <option value="é€ƒã’">é€ƒã’</option>
          <option value="å…ˆè¡Œ">å…ˆè¡Œ</option>
          <option value="å·®ã—">å·®ã—</option>
          <option value="è¿½è¾¼">è¿½è¾¼</option>
        </select>

        ${qYN(`p2a_${h}`, `æƒ³å®šãƒšãƒ¼ã‚¹ï¼ˆé…/æ™®/é€Ÿï¼‰ã‚’1ã¤ã«æ±ºã‚ã‚‰ã‚Œã‚‹ï¼Ÿ`)}
        ${qYN(`p2b_${h}`, `4è§’ä½ç½®ã‚’1ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¨€ãˆã‚‹ï¼Ÿ`)}
        ${qYN(`p2c_${h}`, `è² ã‘ç­‹ãŒ1ã¤ã«é™å®šã§ãã‚‹ï¼Ÿï¼ˆ2ã¤ä»¥ä¸Šãªã‚‰å±é™ºï¼‰`)}

        <div class="hr"></div>
        <div class="qtitle">é¦¬${h}ï½œâ‘¢é¨æ‰‹ï¼ˆæ¸›ç‚¹å°‚ç”¨ï¼‰</div>
        <label>é¨æ‰‹ãŒâ‘¡ã®å½¢ã‚’å£Šã—ã«ãã„ï¼Ÿ</label>
        <select id="j_${h}">
          <option value="OK">OKï¼ˆæ¸›ç‚¹ãªã—ï¼‰</option>
          <option value="ä¸å®‰">ä¸å®‰ï¼ˆ-0.5ï¼‰</option>
          <option value="æ¶ˆã—">æ¶ˆã—ï¼ˆé™¤å¤–ï¼‰</option>
        </select>
        <label>ä½ç½®å–ã‚Šã®ãƒ–ãƒ¬ï¼ˆä»»æ„ãƒ¡ãƒ¢ï¼‰</label>
        <input id="jm_${h}" placeholder="ä¾‹ï¼šä½ç½®å–ã‚Šãƒ–ãƒ¬å°ï¼å‡ºé…ã‚Œå¤šã„ ãªã©" />
      `;
      wrap.appendChild(box);
    });

    el("horseForms").innerHTML = "";
    el("horseForms").appendChild(wrap);

    // wire up values + restore
    horses.forEach(h => {
      const s = state.perHorse[h];

      // restore selects
      el(`pace_${h}`).value = s.pace || "æ™®";
      el(`style_${h}`).value = s.style || "å…ˆè¡Œ";
      el(`j_${h}`).value = s.j || "OK";
      el(`jm_${h}`).value = s.jockeyMemo || "";

      // restore yn
      ["p1a","p1b","p1c","p2a","p2b","p2c"].forEach(k=>{
        if (s[k] === "yes") ynSet(`${k}_${h}`, true);
        if (s[k] === "no") ynSet(`${k}_${h}`, false);
      });

      // listeners
      el(`pace_${h}`).addEventListener("change", ()=> s.pace = el(`pace_${h}`).value);
      el(`style_${h}`).addEventListener("change", ()=> s.style = el(`style_${h}`).value);
      el(`j_${h}`).addEventListener("change", ()=> s.j = el(`j_${h}`).value);
      el(`jm_${h}`).addEventListener("input", ()=> s.jockeyMemo = el(`jm_${h}`).value);
    });

    // validate button
    el("btnGoStep4").disabled = !canGoStep4();
  };

  function qYN(id, text){
    return `
      <div style="margin-top:10px;">
        <div class="note"><b>${text}</b></div>
        <div class="choices" style="margin-top:8px;">
          <div class="choice" data-yn="${id}" data-v="yes">ã¯ã„</div>
          <div class="choice bad" data-yn="${id}" data-v="no">ã„ã„ãˆ</div>
        </div>
      </div>
    `;
  }

  function ynSet(id, yes){
    document.querySelectorAll(`.choice[data-yn="${id}"]`).forEach(x=>x.classList.remove("on"));
    const v = yes ? "yes" : "no";
    const t = document.querySelector(`.choice[data-yn="${id}"][data-v="${v}"]`);
    if (t) t.classList.add("on");
  }

  document.addEventListener("click", (e) => {
    const t = e.target.closest(".choice[data-yn]");
    if (!t) return;
    const id = t.dataset.yn;
    const v = t.dataset.v; // yes/no
    const [key, horse] = id.split("_");
    if (!state.perHorse[horse]) return;
    state.perHorse[horse][key] = v;
    ynSet(id, v === "yes");
    el("btnGoStep4").disabled = !canGoStep4();
  });

  const canGoStep4 = () => {
    const horses = state.candidates;
    if (!horses.length) return false;
    for (const h of horses) {
      const s = state.perHorse[h];
      if (!s) return false;
      // required: p1a/b/c p2a/b/c and jockey select exists (always)
      const req = ["p1a","p1b","p1c","p2a","p2b","p2c"];
      if (req.some(k => !s[k])) return false;
      if (!s.j) return false;
    }
    return true;
  };

  // ====== scoring ======
  const computeScores = () => {
    const horses = state.candidates;
    const rows = [];
    for (const h of horses) {
      const s = state.perHorse[h];

      // pillar1
      const p1Yes = ["p1a","p1b","p1c"].filter(k => s[k] === "yes").length;
      const p1 = scorePillar(p1Yes);

      // pillar2
      // p2c is "è² ã‘ç­‹1ã¤ã«é™å®šã§ãã‚‹ï¼Ÿ" yes=>good, no=>danger
      const p2Yes = ["p2a","p2b","p2c"].filter(k => s[k] === "yes").length;
      const p2 = scorePillar(p2Yes);

      // jockey
      let jAdj = 0;
      let jLabel = "OK";
      if (s.j === "ä¸å®‰") { jAdj = -0.5; jLabel = "ä¸å®‰"; }
      if (s.j === "æ¶ˆã—") { jAdj = -999; jLabel = "æ¶ˆã—"; }

      const total = (jAdj <= -900) ? -999 : (p1 + p2 + jAdj);

      rows.push({
        horse:h,
        p1, p2,
        j: jLabel,
        total
      });
    }

    // pick main: highest total (ignoring -999)
    const valid = rows.filter(r => r.total > -900);
    let msg = "";
    let main = null;

    if (!valid.length) {
      msg = `<b class="ng">å…¨é ­ãŒã€Œæ¶ˆã—ã€æ‰±ã„ã€‚è¦‹é€ã‚Šæ¨å¥¨ã€‚</b>`;
      state.pick = { main:null, scores:rows, msg };
      return;
    }

    // sort by total desc
    valid.sort((a,b)=> b.total - a.total);

    // tie-break: if total same
    const topTotal = valid[0].total;
    const tied = valid.filter(x => x.total === topTotal);

    if (tied.length === 1) {
      main = tied[0].horse;
    } else {
      // tie-break by p1 desc then p2 desc then jockey OK over ä¸å®‰
      tied.sort((a,b)=>{
        if (b.p1 !== a.p1) return b.p1 - a.p1;
        if (b.p2 !== a.p2) return b.p2 - a.p2;
        // OK better than ä¸å®‰
        const rank = (x)=> x.j==="OK"?2 : x.j==="ä¸å®‰"?1 : 0;
        return rank(b) - rank(a);
      });
      // if still tie fully, recommend skip
      const best = tied[0];
      const isStillTie = tied.slice(1).some(x => x.p1===best.p1 && x.p2===best.p2 && x.j===best.j);
      if (isStillTie) {
        msg = `<b class="warn">åŒç‚¹ãŒè§£ã‘ãªã„ï¼ˆâ‘ â‘¡â‘¢ã¾ã§åŒã˜ï¼‰â†’ ãƒ«ãƒ¼ãƒ«é€šã‚Š <b>è¦‹é€ã‚Š</b> æ¨å¥¨ã€‚</b>`;
        main = best.horse; // show, but recommend skip
      } else {
        main = best.horse;
      }
    }

    // top < 1 => recommend skip
    if (topTotal < 1) {
      msg += `<div class="hr"></div><b class="warn">ãƒˆãƒƒãƒ—ãŒ1ç‚¹æœªæº€ â†’ è¦‹é€ã‚Šæ¨å¥¨ã€‚</b>`;
    }

    state.pick = { main, scores:rows, msg };
  };

  const renderScoreTable = () => {
    const rows = state.pick.scores;
    const main = state.pick.main;
    const val = (x)=> (x <= -900 ? "Ã—" : x.toFixed(1));
    const html = `
      <table>
        <thead>
          <tr>
            <th>é¦¬ç•ª</th><th>â‘ </th><th>â‘¡</th><th>â‘¢</th><th>åˆè¨ˆ</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td><b>${r.horse}${(main===r.horse) ? ' <span class="ok">âœ…</span>' : ''}</b></td>
              <td>${r.p1}</td>
              <td>${r.p2}</td>
              <td>${r.j}</td>
              <td><b>${val(r.total)}</b></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
      <div class="small" style="margin-top:10px;">
        å†…è¨³ï¼šâ‘ =ã‚³ãƒ¼ã‚¹è·é›¢ï¼ˆ2ä»¥ä¸Šã§2ç‚¹ï¼‰ï¼â‘¡=æµã‚Œè„šè³ªï¼ˆ2ä»¥ä¸Šã§2ç‚¹ï¼‰ï¼â‘¢=é¨æ‰‹ï¼ˆä¸å®‰-0.5ã€æ¶ˆã—=é™¤å¤–ï¼‰
      </div>
    `;
    el("scoreTable").innerHTML = html;

    const topRow = rows.filter(x=>x.total>-900).sort((a,b)=>b.total-a.total)[0];
    if (!topRow) {
      el("mainPickTitle").innerHTML = `çµæœ`;
    } else {
      el("mainPickTitle").innerHTML = `âœ… æœ¬å‘½ï¼šé¦¬${state.pick.main || "â€”"}ï¼ˆåˆè¨ˆ ${topRow.total.toFixed(1)} ç‚¹ï¼‰`;
    }

    el("step4Msg").innerHTML = state.pick.msg || "";
  };

  const autoAim = () => {
    // aim: which pillars are strong for the main horse
    const main = state.pick.main;
    if (!main) return "ãªã—";
    const r = state.pick.scores.find(x=>x.horse===main);
    if (!r) return "ãªã—";
    const a = [];
    if (r.p1 >= 2) a.push("â‘ ");
    if (r.p2 >= 2) a.push("â‘¡");
    if (r.j === "OK") a.push("â‘¢");
    if (!a.length) return "ãªã—";
    return a.join("");
  };

  // ====== final summary ======
  const updateFinalSummary = () => {
    const r = state.race;
    const main = state.pick.main;
    const aim = autoAim();
    const w = state.step5.weight;
    const info = state.step5.info;

    const skipReasons = [];
    if (!main) skipReasons.push("æœ¬å‘½ãŒæ±ºã¾ã‚‰ãªã„");
    if (w === "yes") skipReasons.push("é¦¬ä½“é‡Â±12kgä»¥ä¸Š");
    if (info === "yes") skipReasons.push("ç›´å‰æƒ…å ±ãƒ•ãƒ©ã‚°ON");

    const rec = (skipReasons.length ? "è¦‹é€ã‚Šæ¨å¥¨" : "è²·ã†å€™è£œ");
    const recClass = (skipReasons.length ? "warn" : "ok");

    el("finalSummary").innerHTML = `
      <div class="tag">ğŸ“… ${r.date}</div>
      <div class="tag">ğŸŸï¸ ${r.track}</div>
      <div class="tag">ğŸ¯ ${r.raceNo}</div>
      <div class="tag">ğŸ·ï¸ ${r.raceClass}</div>
      <div class="tag">â­ ${r.course}</div>
      <div class="hr"></div>
      <div class="big ${recClass}">${rec}</div>
      <div class="hr"></div>
      <div><b>çµè«–ï¼š</b>${skipReasons.length ? "<b class='warn'>è¦‹é€ã‚Š</b>" : "<b class='ok'>è²·ã†</b>"}</div>
      <div><b>æœ¬å‘½ï¼š</b>${main ? `é¦¬${main}` : "â€”"}</div>
      <div><b>ç‹™ã„ï¼š</b>${aim} ãŒæƒã£ã¦ã„ã¦å´©ã‚Œã«ãã„</div>
      <div><b>è²·ã„ç›®ï¼š</b>${main ? `é¦¬${main} è¤‡å‹1ç‚¹ 500å††` : "â€”"}</div>
    `;

    el("skipCond").value =
      `é¦¬ä½“é‡Â±12kgä»¥ä¸Š â†’ è¦‹é€ã‚Š\n` +
      `ç›´å‰æƒ…å ±ãƒ•ãƒ©ã‚°ON â†’ è¦‹é€ã‚Š\n` +
      `åŒç‚¹ãŒè§£ã‘ãªã„ï¼æœ¬å‘½ãŒæ±ºã¾ã‚‰ãªã„ â†’ è¦‹é€ã‚Š\n`;

    // if recommended skip, default to disable BUY?ï¼ˆãŸã ã—é‡è³ã¯è²·ã„ãŸããªã‚‹ã®ã§â€œå®Œå…¨ç¦æ­¢â€ã«ã¯ã—ãªã„ï¼‰
    // ã“ã“ã¯ã€ŒBUYä¿å­˜ã€ã‚‚å¯èƒ½ã«ã™ã‚‹ï¼ˆè‡ªå·±è²¬ä»»ã§ãƒ­ã‚°ãŒæ®‹ã‚‹æ–¹ãŒå¤§äº‹ï¼‰
  };

  // ====== log & csv ======
  const toCSV = (logs) => {
    const headers = [
      "ts","date","track","raceNo","class","course",
      "candidates","main","score","aim","risk","weight12","lateInfo","decision","memo"
    ];
    const esc = (s) => {
      const x = String(s ?? "");
      return `"${x.replace(/"/g,'""')}"`;
    };
    const lines = [headers.join(",")];
    logs.forEach(l => {
      lines.push([
        l.ts, l.date, l.track, l.raceNo, l.raceClass, l.course,
        (l.candidates || []).join("-"),
        l.main || "",
        (l.score ?? ""),
        l.aim || "",
        l.risk || "",
        l.weight12 || "",
        l.lateInfo || "",
        l.decision || "",
        l.memo || ""
      ].map(esc).join(","));
    });
    return lines.join("\n");
  };

  const refreshLogUI = () => {
    const logs = loadLogs();
    const csv = toCSV(logs);
    // preview last 10 lines
    const lines = csv.split("\n");
    const preview = lines.slice(0,1).concat(lines.slice(Math.max(1, lines.length-11))).join("\n");
    el("logPreview").textContent = preview;
    updateRaceSummary();
  };

  const saveDecision = (decision) => {
    const logs = loadLogs();
    const r = state.race;
    const aim = autoAim();
    const mainRow = state.pick.scores.find(x => x.horse === state.pick.main);
    const score = mainRow ? (mainRow.total <= -900 ? "" : mainRow.total.toFixed(1)) : "";
    const memo = state.candMemo || "";

    logs.push({
      ts: nowStr(),
      date: r.date,
      track: r.track,
      raceNo: r.raceNo,
      raceClass: r.raceClass,
      course: r.course,
      candidates: state.candidates,
      main: state.pick.main,
      score,
      aim,
      risk: (state.final.risk || "").trim(),
      weight12: state.step5.weight || "",
      lateInfo: state.step5.info || "",
      decision,
      memo,
    });

    saveLogs(logs);
    refreshLogUI();
  };

  // ====== buttons ======
  el("btnGoStep0").addEventListener("click", () => {
    // daily limit
    const logs = loadLogs();
    const todays = logs.filter(x => x.date === state.race.date);
    if (todays.length >= 3) return; // should be disabled already
    go("cardStep0");
  });

  el("btnSkipToday").addEventListener("click", () => {
    // Save a SKIP log immediately (å…¥å£ã‚¹ã‚­ãƒƒãƒ—)
    state.final.risk = "";
    state.candidates = [];
    state.pick.main = null;
    state.step5.weight = "";
    state.step5.info = "";
    saveDecision("SKIP");
    alert("è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
  });

  el("btnBackToRace").addEventListener("click", () => go("cardRace"));
  el("btnBackTo0").addEventListener("click", () => go("cardStep0"));
  el("btnBackTo1").addEventListener("click", () => go("cardStep1"));
  el("btnBackTo2").addEventListener("click", () => go("cardStep2"));
  el("btnBackTo3").addEventListener("click", () => go("cardStep3"));
  el("btnBackTo4").addEventListener("click", () => go("cardStep4"));
  el("btnBackTo5").addEventListener("click", () => go("cardStep5"));

  el("btnSkipFrom0").addEventListener("click", () => {
    saveDecision("SKIP");
    alert("è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  el("btnGoStep1").addEventListener("click", () => {
    // Must answer both
    if (!state.step0.q1 || !state.step0.q2) {
      alert("STEP0ã®Q1/Q2ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    if (state.step0.q1 === "no" || state.step0.q2 === "no") {
      // stop early
      alert("No ãŒå‡ºã¾ã—ãŸã€‚ä»Šå›ã¯è¦‹é€ã‚ŠãŒæ­£è§£ã§ã™ï¼ˆãƒ­ã‚°ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰ã€‚");
      return;
    }
    refreshStep1();
    go("cardStep1");
  });

  el("btnSkipFrom1").addEventListener("click", () => {
    saveDecision("SKIP");
    alert("å¯¾è±¡å¤–ã¨ã—ã¦è¦‹é€ã‚Šä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  el("btnGoStep2").addEventListener("click", () => {
    refreshStep1();
    if (!isTargetRace(state.race)) {
      alert("å¯¾è±¡å¤–ã§ã™ã€‚è¦‹é€ã‚ŠãŒæ­£è§£ã§ã™ã€‚");
      return;
    }
    go("cardStep2");
  });

  el("btnGoStep3").addEventListener("click", () => {
    const c = normalizeCandidates(el("candidates").value);
    const memo = el("candMemo").value || "";
    if (c.length === 0) {
      alert("å€™è£œé¦¬ï¼ˆé¦¬ç•ªï¼‰ã‚’1ã€œ3é ­å…¥ã‚Œã¦ãã ã•ã„ã€‚");
      return;
    }
    state.candidates = c;
    state.candMemo = memo;
    buildHorseForms();
    go("cardStep3");
  });

  el("btnSkipFrom2").addEventListener("click", () => {
    saveDecision("SKIP");
    alert("å€™è£œãŒå‡ºãªã„ãŸã‚è¦‹é€ã‚Šä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  el("btnGoStep4").addEventListener("click", () => {
    if (!canGoStep4()) {
      alert("å„é¦¬ã®å…¥åŠ›ãŒæœªå®Œã§ã™ï¼ˆâ‘ â‘¡ã®Yes/Noã‚’å…¨éƒ¨åŸ‹ã‚ã¦ãã ã•ã„ï¼‰ã€‚");
      return;
    }
    computeScores();
    renderScoreTable();
    go("cardStep4");
  });

  el("btnSkipFrom4").addEventListener("click", () => {
    saveDecision("SKIP");
    alert("è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  el("btnGoStep5").addEventListener("click", () => {
    // allow, even if recommended skip
    go("cardStep5");
  });

  el("btnGoStep6").addEventListener("click", () => {
    if (!state.step5.weight || !state.step5.info) {
      alert("STEP5ã®Q1/Q2ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    updateFinalSummary();
    go("cardStep6");
  });

  el("btnSaveBuy").addEventListener("click", () => {
    state.final.risk = el("riskOne").value || "";
    saveDecision("BUY");
    alert("BUYã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  el("btnSaveSkip").addEventListener("click", () => {
    state.final.risk = el("riskOne").value || "";
    saveDecision("SKIP");
    alert("è¦‹é€ã‚Šã§ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ï¼‰ã€‚");
    go("cardRace");
  });

  // ====== log buttons ======
  el("btnCopyCSV").addEventListener("click", async () => {
    const logs = loadLogs();
    const csv = toCSV(logs);
    try {
      await navigator.clipboard.writeText(csv);
      alert("CSVã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
    } catch {
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚iOSã®è¨­å®šã§è¨±å¯ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚");
    }
  });

  el("btnDownloadCSV").addEventListener("click", () => {
    const logs = loadLogs();
    const csv = toCSV(logs);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `oji_keiba_log_${todayISO()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  el("btnClearLog").addEventListener("click", () => {
    if (!confirm("ãƒ­ã‚°ã‚’å…¨æ¶ˆã—ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(KEY);
    refreshLogUI();
    alert("ãƒ­ã‚°ã‚’å…¨æ¶ˆã—ã—ã¾ã—ãŸã€‚");
  });

  // ====== daily reset note ======
  // This app counts "today" by filtering logs by selected date.
  // So when date changes to tomorrow, remaining count becomes 3 again.
  // (No extra reset needed)

  // initial log view
  refreshLogUI();

  // start card
  go("cardRace");

})();
</script>
</body>
</html>
