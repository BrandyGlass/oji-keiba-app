<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŠã˜.exe v5.1 | 18é ­è¶³åˆ‡ã‚Šver</title>
  <style>
    :root{
      --bg:#0f172a; --card:#1e293b; --accent:#38bdf8; --text:#f8fafc;
      --muted:#94a3b8; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:16px;
      --tap:44px;
      --focus: 0 0 0 3px rgba(56,189,248,.35);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    /* iOS: input zoomå›é¿ï¼ˆ16pxä»¥ä¸Šï¼‰ */
    input, select, button { font: inherit; }

    /* è¦‹å‡ºã—ã®ãƒ‡ãƒ•ã‚©ä½™ç™½ã‚’æƒãˆã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãƒ–ãƒ¬ã‚’æ¸›ã‚‰ã™ */
    h2, h3{ margin: 0 0 12px; font-size: 18px; }
    h3{ font-size: 14px; }

    .stepper{
      display:flex; gap:4px; padding:12px 16px;
      background: rgba(0,0,0,0.2);
      position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(8px);
    }
    .step-dot{ flex:1; height:4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
    .step-dot.active{ background: var(--accent); box-shadow: 0 0 8px var(--accent); }

    .wrap{ max-width:600px; margin:0 auto; padding:16px; }
    .header{ margin-bottom: 24px; text-align:center; }
    .title{ font-weight:900; font-size:24px; color: var(--accent); }
    .sub{ color: var(--muted); font-size: 13px; margin-top: 6px; }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      display: none;
    }
    .card[aria-hidden="false"]{ display:block; }

    .note{
      background: rgba(0,0,0,0.2);
      padding: 12px;
      border-radius: 12px;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    /* 18é ­ã‚°ãƒªãƒƒãƒ‰ */
    .horse-grid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    .horse-btn{
      min-height: var(--tap);
      aspect-ratio: 1/1;
      background: #334155;
      border: none;
      color: white;
      border-radius: 10px;
      font-weight: 800;
      font-size: 16px;
      cursor: pointer;
      touch-action: manipulation;
      user-select: none;
    }
    .horse-btn:focus-visible{ outline: none; box-shadow: var(--focus); }
    .horse-btn.eliminated{
      background: #1e293b;
      color: #475569;
      text-decoration: line-through;
      opacity: 0.55;
      border: 1px solid #0f172a;
    }

    label{
      display:block;
      font-size: 12px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 6px;
    }
    select, input{
      width: 100%;
      background: #0f172a;
      border: 1px solid #334155;
      color: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 16px;
      font-size: 16px; /* iOS zoomå›é¿ */
    }
    input:focus-visible, select:focus-visible{ outline:none; box-shadow: var(--focus); border-color: rgba(56,189,248,.6); }

    .btn-group{ display:flex; gap: 4px; margin-bottom: 16px; }
    .tgl-btn{
      flex:1;
      min-height: var(--tap);
      background: #334155;
      border: none;
      color: var(--muted);
      padding: 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 900;
      cursor: pointer;
      touch-action: manipulation;
    }
    .tgl-btn.active{ background: var(--accent); color: #0f172a; }
    .tgl-btn:focus-visible{ outline:none; box-shadow: var(--focus); }

    button.main{
      width: 100%;
      min-height: var(--tap);
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
      touch-action: manipulation;
    }
    button.main:disabled{ opacity: 0.3; cursor: not-allowed; }
    button.main:focus-visible{ outline:none; box-shadow: var(--focus); }

    button.danger{
      width: 100%;
      min-height: var(--tap);
      background: rgba(239, 68, 68, 0.1);
      color: var(--bad);
      border: 1px solid var(--bad);
      padding: 12px;
      border-radius: 12px;
      margin-top: 10px;
      cursor: pointer;
      touch-action: manipulation;
    }
    button.danger:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(239,68,68,.25); }

    .res-box{
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .res-score{ font-size: 32px; font-weight: 900; color: var(--good); text-align:center; }

    .btn-row{ display:flex; gap:8px; }
    .sub-btn{
      flex:1;
      min-height: var(--tap);
      border:none;
      padding:10px;
      border-radius:10px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
      touch-action: manipulation;
    }
    .sub-btn:focus-visible{ outline:none; box-shadow: var(--focus); }

    /* å°ã•ã‚ç«¯æœ«ã®ã¨ãã¯ã‚°ãƒªãƒƒãƒ‰ã‚’è©°ã‚ã‚‹ */
    @media (max-width: 360px){
      .horse-grid{ grid-template-columns: repeat(5, 1fr); }
      .title{ font-size: 22px; }
    }
  </style>
</head>
<body>

  <div class="stepper" id="stepper" aria-label="é€²è¡ŒçŠ¶æ³">
    <div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div>
    <div class="step-dot"></div><div class="step-dot"></div>
  </div>

  <div class="wrap">
    <div class="header">
      <div class="title">ãŠã˜.exe v5.1</div>
      <div class="sub">18â†’2ã®å·¥ç¨‹è¡¨</div>
    </div>

    <div class="card" id="p1" aria-hidden="false">
      <h2>ğŸ‡ ãƒ¬ãƒ¼ã‚¹è¨­å®š</h2>
      <label for="raceName">ãƒ¬ãƒ¼ã‚¹åï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="raceName" placeholder="ä¾‹ï¼šæ ¹å²¸S" autocomplete="off" inputmode="text" />

      <div class="btn-row">
        <button class="main" id="btnStart" type="button">åˆ†æé–‹å§‹</button>
      </div>
    </div>

    <div class="card" id="p2" aria-hidden="true">
      <h2>âœ‚ï¸ STEP1: æ¡ä»¶ä¸é©åˆã‚’æ¶ˆã™</h2>
      <div class="note">ã€Œè·é›¢å®Ÿç¸¾ãªã—ã€ã€Œãƒ€ãƒ¼ãƒˆåˆæŒ‘æˆ¦ã€ã€Œæ˜ç¢ºãªè‹¦æ‰‹ã‚³ãƒ¼ã‚¹ã€ã®é¦¬ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ¶ˆã›ã€‚</div>
      <div class="horse-grid" id="grid1" aria-label="STEP1 è¶³åˆ‡ã‚Š"></div>
      <div class="note" id="count1">ç”Ÿå­˜æ•°: 18é ­</div>
      <button class="main" id="btnToStep2" type="button">STEP2ï¼ˆè„šè³ªï¼‰ã¸</button>
    </div>

    <div class="card" id="p3" aria-hidden="true">
      <h2>âœ‚ï¸ STEP2: 4è§’ä½ç½®ã§æ¶ˆã™</h2>
      <div class="note">ã€Œ4è§’10ç•ªæ‰‹ä»¥é™ãŒãƒ‡ãƒ•ã‚©ã€ã€Œå‡ºé…ã‚Œç™–ã€ã€Œæ¥µç«¯ãªè¿½è¾¼ã€ã‚’æ¶ˆã›ã€‚4è§’5ç•ªæ‰‹ä»¥å†…ãŒç†æƒ³ã€‚</div>
      <div class="horse-grid" id="grid2" aria-label="STEP2 è¶³åˆ‡ã‚Š"></div>
      <div class="note" id="count2">ç”Ÿå­˜æ•°: -</div>
      <button class="main" id="btnToScore" type="button">ä¸‰æœ¬æŸ±æŸ»å®šã¸</button>
      <button class="danger" id="btnSkipAll" type="button">å…¨æ»…ãƒ»è¦‹é€ã‚Š</button>
    </div>

    <div class="card" id="p4" aria-hidden="true">
      <h2>ğŸ“Š ç²¾å¯†æŸ»å®šï¼ˆç”Ÿå­˜é¦¬ã®ã¿ï¼‰</h2>
      <div class="note">
        ç”Ÿå­˜é¦¬ã®ã€Œå®‰å®šæ„Ÿã€ã‚’ä»˜ã‘ã‚‹ã€‚<br />
        ä¸ŠãŒã‚Šå›æ•°ï¼ˆè¿‘3èµ°ï¼‰ã¯ã€Œä¸ŠãŒã‚Šé †ä½3ä½ä»¥å†…ã€ã®å›æ•°ï¼ˆ0ã€œ3ï¼‰ã€‚â€»åŒç‚¹ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚¯å°‚ç”¨ã€‚å›æ•°ã‚‚åŒã˜ãªã‚‰3æŠï¼ˆé¦¬A/é¦¬B/è¦‹é€ã‚Šï¼‰ã€‚
      </div>
      <div id="scoringArea"></div>
      <button class="main" id="btnCalc" type="button">çµè«–ã‚’å‡ºã™</button>
    </div>

    <div class="card" id="p5" aria-hidden="true">
      <h2>ğŸ æœ€çµ‚ã‚¸ãƒ£ãƒƒã‚¸</h2>
      <div id="resultDisplay"></div>

      <label for="risk" style="margin-top:12px;">è² ã‘ç­‹ï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="risk" placeholder="ä¾‹ï¼šå†…æ ã©ã‚“è©°ã¾ã‚Š" autocomplete="off" inputmode="text" />

      <button class="main" id="btnFinalBuy" type="button">BUYä¿å­˜</button>
      <button class="danger" id="btnFinalSkip" type="button">è¦‹é€ã‚Šä¿å­˜</button>

      <div style="margin-top: 32px; border-top: 1px dashed var(--muted); padding-top: 16px;">
        <h3 style="font-size: 14px; color: var(--muted); margin:0 0 10px;">ğŸ“œ ç›´è¿‘ã®æˆ¦ç¸¾</h3>
        <div id="historyList"></div>
        <div class="btn-row">
          <button class="sub-btn" id="btnCopy" style="background:#334155; color:white;" type="button">CSVã‚³ãƒ”ãƒ¼</button>
          <button class="sub-btn" id="btnClear" style="background:transparent; color:var(--bad); border:1px solid var(--bad);" type="button">å…¨æ¶ˆå»</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const STORAGE_KEY = "oji_exe_v51_logs";
  const MAX_HORSES = 18;
  const STEP_COUNT = 5;

  const state = {
    step: 1,
    horses: Array.from({length: MAX_HORSES}, (_, i) => i + 1),
    step1Out: [],
    step2Out: [],
    scores: {},
    best: null,
    scoringBound: false
  };

  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  const els = {
    cards: $$(".card"),
    dots: $$(".step-dot"),
    raceName: $("#raceName"),
    risk: $("#risk"),
    grid1: $("#grid1"),
    grid2: $("#grid2"),
    count1: $("#count1"),
    count2: $("#count2"),
    scoringArea: $("#scoringArea"),
    resultDisplay: $("#resultDisplay"),
    historyList: $("#historyList"),

    btnStart: $("#btnStart"),
    btnToStep2: $("#btnToStep2"),
    btnToScore: $("#btnToScore"),
    btnSkipAll: $("#btnSkipAll"),
    btnCalc: $("#btnCalc"),
    btnFinalBuy: $("#btnFinalBuy"),
    btnFinalSkip: $("#btnFinalSkip"),
    btnCopy: $("#btnCopy"),
    btnClear: $("#btnClear"),
  };

  // ---------- Storage ----------
  function safeParseJSON(str, fallback){
    try { return JSON.parse(str); } catch { return fallback; }
  }
  function getLogs(){
    return safeParseJSON(localStorage.getItem(STORAGE_KEY) || "[]", []);
  }
  function setLogs(logs){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
  }
  function pushLog(entry){
    const logs = getLogs();
    logs.push(entry);
    setLogs(logs);
  }

  // ---------- Utils ----------
  function toggleArray(arr, val){
    return arr.includes(val) ? arr.filter(x => x !== val) : [...arr, val];
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function survivors(){
    return state.horses.filter(h => !state.step1Out.includes(h) && !state.step2Out.includes(h));
  }
  function scrollTopInstant(){
    // Safari iOS ã§ã¯ behavior: "instant" ãŒæœªå¯¾å¿œãªã®ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    try {
      window.scrollTo({ top: 0, left: 0, behavior: "smooth" });
      window.scrollTo({ top: 0, left: 0 });
    } catch {
      window.scrollTo(0, 0);
    }
  }
  function setAriaBusy(el, busy){
    if (!el) return;
    el.setAttribute("aria-busy", busy ? "true" : "false");
  }

  // ---------- UI ----------
  function setStep(nextStep){
    const step = Math.min(Math.max(1, Number(nextStep) || 1), STEP_COUNT);
    state.step = step;

    els.cards.forEach(card => {
      const isTarget = card.id === `p${step}`;
      card.setAttribute("aria-hidden", String(!isTarget));
    });

    els.dots.forEach((d, i) => d.classList.toggle("active", i < step));
    scrollTopInstant();

    if (step === 2) {
      renderGrid(1);
      updateCount(1);
    }
    if (step === 3) {
      renderGrid(2);
      updateCount(2);
    }
    if (step === 5) {
      renderHistory();
    }
  }

  function renderGrid(stepNum){
    const grid = stepNum === 1 ? els.grid1 : els.grid2;
    if (!grid) return;

    setAriaBusy(grid, true);
    grid.innerHTML = "";

    const list = (stepNum === 1)
      ? state.horses
      : state.horses.filter(h => !state.step1Out.includes(h));

    const frag = document.createDocumentFragment();

    list.forEach(num => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "horse-btn";
      btn.textContent = String(num);

      const isOut = (stepNum === 1)
        ? state.step1Out.includes(num)
        : state.step2Out.includes(num);

      btn.classList.toggle("eliminated", isOut);
      btn.setAttribute("aria-pressed", String(isOut));
      btn.setAttribute("aria-label", `é¦¬ç•ª${num}${isOut ? "ï¼ˆé™¤å¤–ï¼‰" : ""}`);

      btn.addEventListener("click", () => {
        if (stepNum === 1) {
          state.step1Out = toggleArray(state.step1Out, num);
          // Step1ã§æ¶ˆã—ãŸé¦¬ãŒStep2ã«æ®‹ã‚‹çŸ›ç›¾ã‚’é™¤å»
          if (state.step1Out.includes(num)) {
            state.step2Out = state.step2Out.filter(x => x !== num);
          }
        } else {
          state.step2Out = toggleArray(state.step2Out, num);
        }
        renderGrid(stepNum);
        updateCount(stepNum);
      });

      frag.appendChild(btn);
    });

    grid.appendChild(frag);
    setAriaBusy(grid, false);
  }

  function updateCount(stepNum){
    const after1 = MAX_HORSES - state.step1Out.length;
    const after2 = after1 - state.step2Out.length;

    if (stepNum === 1) {
      if (els.count1) els.count1.textContent = `ç”Ÿå­˜æ•°: ${after1}é ­`;
    } else {
      if (els.count2) els.count2.textContent = `ç”Ÿå­˜æ•°: ${after2}é ­`;
      // ç”Ÿå­˜1ã€œ5é ­ã ã‘æ¬¡ã¸ï¼ˆå¥½ã¿ï¼‰
      if (els.btnToScore) els.btnToScore.disabled = (after2 === 0 || after2 > 5);
    }
  }

  function setupScoring(){
    const list = survivors();
    if (list.length === 0) {
      alert("ç”Ÿå­˜é¦¬ãŒ0é ­ã§ã™ã€‚è¦‹é€ã‚Šã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    state.scores = {};
    if (els.scoringArea) els.scoringArea.innerHTML = "";

    const frag = document.createDocumentFragment();

    list.forEach(num => {
      // p1: å®‰å®šæ„Ÿï¼ˆ2/1ï¼‰ã€p2: ä¸ŠãŒã‚Šå›æ•°ï¼ˆ0-3ï¼‰â€»åŒç‚¹å°‚ç”¨
      state.scores[num] = { p1: 1, p2: 0 };

      const box = document.createElement("div");
      box.className = "res-box";
      box.dataset.horse = String(num);

      box.innerHTML = `
        <div style="font-weight:bold; color:var(--accent);">é¦¬ç•ª: ${num}</div>

        <label>å®‰å®šæ„Ÿï¼ˆ0.5ç§’å·®å†…ã‚’ç¶™ç¶šï¼Ÿï¼‰</label>
        <div class="btn-group" data-p="p1">
          <button class="tgl-btn" type="button" data-v="2" aria-pressed="false">â— å …å®Ÿ</button>
          <button class="tgl-btn active" type="button" data-v="1" aria-pressed="true">â—‹ ä¸¦</button>
        </div>

        <label>ä¸ŠãŒã‚Šï¼ˆè¿‘3èµ°ï¼šä¸ŠãŒã‚Šé †ä½3ä½ä»¥å†…ã®å›æ•°ï¼‰â€»åŒç‚¹å°‚ç”¨</label>
        <div class="btn-group" data-p="p2">
          <button class="tgl-btn active" type="button" data-v="0" aria-pressed="true">0å›</button>
          <button class="tgl-btn" type="button" data-v="1" aria-pressed="false">1å›</button>
          <button class="tgl-btn" type="button" data-v="2" aria-pressed="false">2å›</button>
          <button class="tgl-btn" type="button" data-v="3" aria-pressed="false">3å›</button>
        </div>
      `;

      frag.appendChild(box);
    });

    if (els.scoringArea) els.scoringArea.appendChild(frag);

    // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼ˆè¤‡æ•°å›ãƒã‚¤ãƒ³ãƒ‰é˜²æ­¢ï¼‰
    if (!state.scoringBound && els.scoringArea) {
      els.scoringArea.addEventListener("click", onScoringClick, { passive: true });
      state.scoringBound = true;
    }

    // çµè«–ãŒå‡ºã‚‹ã¾ã§BUYã¯ç„¡åŠ¹
    if (els.btnFinalBuy) els.btnFinalBuy.disabled = true;

    setStep(4);
  }

  function onScoringClick(e){
    const btn = e.target.closest(".tgl-btn");
    if (!btn) return;

    const group = btn.closest(".btn-group");
    const box = btn.closest(".res-box");
    if (!group || !box) return;

    const horse = Number(box.dataset.horse);
    const p = group.dataset.p;
    const v = Number(btn.dataset.v);

    if (!state.scores[horse]) return;

    state.scores[horse][p] = v;

    group.querySelectorAll(".tgl-btn").forEach(x => {
      x.classList.remove("active");
      x.setAttribute("aria-pressed", "false");
    });
    btn.classList.add("active");
    btn.setAttribute("aria-pressed", "true");
  }

  function calcResult(){
    const keys = Object.keys(state.scores);
    if (keys.length === 0) {
      alert("æŸ»å®šå¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    // â˜… totalã¯p1ã®ã¿ï¼ˆä¸ŠãŒã‚Šp2ã¯åŒç‚¹ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚¯å°‚ç”¨ï¼‰
    const res = keys.map(n => ({
      num: Number(n),
      p1: (state.scores[n].p1 ?? 0),
      p2: (state.scores[n].p2 ?? 0),  // 0-3
      total: (state.scores[n].p1 ?? 0)
    })).sort((a,b) =>
      (b.total - a.total) || // å®‰å®šæ„Ÿ
      (b.p2 - a.p2)          // åŒç‚¹ãªã‚‰ä¸ŠãŒã‚Šå›æ•°
    );

    const top = res[0];
    const second = res[1] || null;

    // â˜… å®Œå…¨åŒç‚¹ï¼ˆå®‰å®šæ„Ÿã‚‚ä¸ŠãŒã‚Šå›æ•°ã‚‚åŒã˜ï¼‰ãªã‚‰ã€Œ3æŠã€
    if (second && top.total === second.total && top.p2 === second.p2) {
      state.best = null;

      if (els.resultDisplay) {
        els.resultDisplay.innerHTML = `
          <div class="res-box">
            <div class="res-score" style="color:var(--warn);">åŒç‚¹</div>
            <div style="text-align:center; margin-bottom:10px;">
              é¦¬ç•ª ${top.num} ã¨ é¦¬ç•ª ${second.num} ãŒå®Œå…¨åŒç‚¹ã€‚<br>
              ï¼ˆå®‰å®šæ„ŸScore: ${top.total} / ä¸ŠãŒã‚Š3ä½å†…å›æ•°: ${top.p2}å›ï¼‰<br>
              ã“ã“ã¯ã€Œé¦¬${top.num} / é¦¬${second.num} / è¦‹é€ã‚Šã€ã§æ±ºã‚ã‚‹ã€‚
            </div>

            <div class="btn-row" style="margin-top:8px;">
              <button class="sub-btn" type="button" id="btnPickA" style="background:#334155; color:white;">
                é¦¬${top.num}ã«ã™ã‚‹
              </button>
              <button class="sub-btn" type="button" id="btnPickB" style="background:#334155; color:white;">
                é¦¬${second.num}ã«ã™ã‚‹
              </button>
            </div>

            <button class="sub-btn" type="button"
              id="btnPickSkip"
              style="width:100%; margin-top:8px; background:transparent; color:var(--bad); border:1px solid var(--bad);">
              è¦‹é€ã‚Šã«ã™ã‚‹
            </button>

            <div id="pickStatus" class="note" style="margin-top:10px;">
              ã¾ã æœªé¸æŠï¼ˆBUYä¿å­˜ã¯ã§ããªã„ï¼‰
            </div>
          </div>
        `;
      }

      if (els.btnFinalBuy) els.btnFinalBuy.disabled = true;

      const btnA = $("#btnPickA");
      const btnB = $("#btnPickB");
      const btnS = $("#btnPickSkip");
      const status = $("#pickStatus");

      if (btnA) btnA.addEventListener("click", () => {
        state.best = { num: top.num, total: top.total, p2: top.p2 };
        if (status) status.textContent = `é¸æŠï¼šé¦¬ç•ª ${top.num}ï¼ˆåŒç‚¹ãƒ»æ‰‹å‹•æ±ºå®šï¼‰`;
        if (els.btnFinalBuy) els.btnFinalBuy.disabled = false;
      });

      if (btnB) btnB.addEventListener("click", () => {
        state.best = { num: second.num, total: second.total, p2: second.p2 };
        if (status) status.textContent = `é¸æŠï¼šé¦¬ç•ª ${second.num}ï¼ˆåŒç‚¹ãƒ»æ‰‹å‹•æ±ºå®šï¼‰`;
        if (els.btnFinalBuy) els.btnFinalBuy.disabled = false;
      });

      if (btnS) btnS.addEventListener("click", () => {
        saveFinal("SKIP");
      });

      setStep(5);
      return;
    }

    // é€šå¸¸ï¼šå‹è€…ç¢ºå®šï¼ˆåŒç‚¹ãªã‚‰ä¸ŠãŒã‚Šå›æ•°ã§æ±ºç€æ¸ˆã¿ï¼‰
    state.best = { num: top.num, total: top.total, p2: top.p2 };

    const usedTiebreak = !!(second && top.total === second.total && top.p2 !== second.p2);

    if (els.resultDisplay) {
      els.resultDisplay.innerHTML = `
        <div class="res-box">
          <div class="res-score">é¦¬ç•ª ${top.num}</div>
          <div style="text-align:center">
            å®‰å®šæ„ŸScore: ${top.total}<br>
            ä¸ŠãŒã‚Š3ä½å†…ï¼ˆè¿‘3èµ°ï¼‰: ${top.p2}å›
            ${usedTiebreak ? `<div class="note" style="margin-top:8px;">åŒç‚¹ â†’ ä¸ŠãŒã‚Šå›æ•°ã§æ±ºç€</div>` : ""}
          </div>
        </div>
      `;
    }

    if (els.btnFinalBuy) els.btnFinalBuy.disabled = false;
    setStep(5);
  }

  function saveFinal(dec){
    const race = (els.raceName?.value || "").trim();
    const risk = (els.risk?.value || "").trim();
    const now = new Date().toISOString();

    if (dec === "BUY") {
      if (!state.best) {
        alert("ã¾ã çµè«–ãŒå‡ºã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
      pushLog({
        race,
        horse: state.best.num,
        score: state.best.total,   // äº’æ›æ€§ç¶­æŒï¼ˆå®‰å®šæ„ŸScoreï¼‰
        dec: "BUY",
        risk,
        at: now
      });
    } else {
      pushLog({
        race,
        horse: "-",
        score: null,
        dec: "SKIP",
        risk: risk || "USER_SKIP",
        at: now
      });
    }

    alert("ä¿å­˜ã—ã¾ã—ãŸ");
    location.reload();
  }

  function saveSkip(reason){
    const race = (els.raceName?.value || "").trim();
    pushLog({
      race,
      horse: "-",
      score: null,
      dec: "SKIP",
      risk: reason,
      at: new Date().toISOString()
    });
    location.reload();
  }

  function renderHistory(){
    const all = getLogs();
    const list = els.historyList;
    if (!list) return;

    if (all.length === 0) {
      list.innerHTML = "<div class='note'>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>";
      return;
    }

    list.innerHTML = [...all].reverse().slice(0, 10).map(l => `
      <div style="background:#1e293b; padding:10px; border-radius:8px; margin-bottom:8px; font-size:12px; border-left:4px solid ${l.dec === 'BUY' ? 'var(--good)' : 'var(--muted)'}">
        <b>${escapeHtml(l.race || "ä¸æ˜")}</b> [${escapeHtml(l.dec)}] é¦¬${escapeHtml(l.horse)}
        ${l.score != null ? ` (å®‰å®šæ„Ÿ: ${escapeHtml(l.score)})` : ""}<br>
        <span style="color:var(--muted)">ãƒªã‚¹ã‚¯: ${escapeHtml(l.risk || "è¨˜è¼‰ãªã—")}</span>
      </div>
    `).join("");
  }

  async function copyLog(){
    const raw = localStorage.getItem(STORAGE_KEY) || "[]";
    try {
      await navigator.clipboard.writeText(raw);
      alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆExcelç­‰ã«è²¼ã‚Šä»˜ã‘å¯èƒ½ï¼‰");
    } catch {
      // iOSã§æ¨©é™ã‚„ç’°å¢ƒã«ã‚ˆã‚Šå¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      const ta = document.createElement("textarea");
      ta.value = raw;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      document.execCommand("copy");
      ta.remove();
      alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆäº’æ›ãƒ¢ãƒ¼ãƒ‰ï¼‰");
    }
  }

  function clearLog(){
    if (confirm("å…¨ã¦ã®å±¥æ­´ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  }

  // ---------- Events ----------
  function bindEvents(){
    els.btnStart?.addEventListener("click", () => setStep(2));
    els.btnToStep2?.addEventListener("click", () => setStep(3));

    els.btnToScore?.addEventListener("click", setupScoring);
    els.btnSkipAll?.addEventListener("click", () => saveSkip("NO_SURVIVORS"));

    els.btnCalc?.addEventListener("click", calcResult);

    els.btnFinalBuy?.addEventListener("click", () => saveFinal("BUY"));
    els.btnFinalSkip?.addEventListener("click", () => saveFinal("SKIP"));

    els.btnCopy?.addEventListener("click", copyLog);
    els.btnClear?.addEventListener("click", clearLog);

    // Enterã§é€²ã‚ã‚‹ï¼ˆinputå†…ã®ã¿ï¼‰
    els.raceName?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") setStep(2);
    });
  }

  // ---------- Init ----------
  function init(){
    bindEvents();

    // åˆæœŸï¼šçµè«–ãŒå‡ºã‚‹ã¾ã§BUYç„¡åŠ¹ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
    if (els.btnFinalBuy) els.btnFinalBuy.disabled = true;

    // åˆæœŸï¼šã‚¹ãƒ†ãƒƒãƒ—1è¡¨ç¤º
    setStep(1);
    renderHistory();
  }

  window.addEventListener("DOMContentLoaded", init, { once: true });
})();
</script>
</body>
</html>
