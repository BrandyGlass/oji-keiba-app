<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä»Šæ—¥ã®é¦¬åˆ¸æŒ¯ã‚Šè¿”ã‚Š</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 16px;
      line-height: 1.4;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 12px;
    }
    section {
      background: #fff;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
    }
    label {
      display: block;
      font-size: 14px;
      margin-top: 8px;
    }
    select, input, textarea {
      width: 100%;
      margin-top: 4px;
      padding: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea { resize: none; }
    .radio-group { margin-top: 8px; }
    .radio-group label { display: block; font-size: 14px; }
    .note { font-size: 12px; color: #666; margin-top: 4px; }

    /* header */
    .header { margin-bottom: 12px; }
    .title { font-weight: 800; font-size: 18px; margin-bottom: 4px; }
    .sub { color: #666; font-size: 12px; margin-bottom: 8px; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      color: #111;
      font-size: 13px;
    }

    /* buttons */
    .btnRow { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    button {
      border: 1px solid #ddd;
      background: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }
    button.primary {
      background: #111;
      color: #fff;
      border-color: #111;
      flex: 1;
      min-width: 160px;
    }
    button.secondary {
      flex: 1;
      min-width: 160px;
    }
    button.danger {
      border-color: #ff5d73;
      color: #b00020;
      flex: 1;
      min-width: 160px;
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hr { height: 1px; background: #eee; margin: 12px 0; }
  </style>
</head>

<body>
  <div class="header">
    <div class="title">ä»Šæ—¥ã®é¦¬åˆ¸æŒ¯ã‚Šè¿”ã‚Š</div>
    <div class="sub">çµæœã¨åˆ¤æ–­ã‚’åˆ‡ã‚Šé›¢ã—ã¦è¨˜éŒ²ã™ã‚‹ï¼ˆä¿å­˜ã¯ç«¯æœ«å†… / localStorageï¼‰</div>

    <div class="chips">
      <a href="index.html" class="chip" style="text-decoration:none;">â† äºˆæƒ³ã«æˆ»ã‚‹</a>
    </div>
  </div>

  <h1>ğŸ ä»Šæ—¥ã®é¦¬åˆ¸æŒ¯ã‚Šè¿”ã‚Š</h1>

  <section>
    <strong>STEP 1ï½œãƒ¬ãƒ¼ã‚¹</strong>
    <label>æ—¥ä»˜
      <input id="date" type="date" />
    </label>

    <label>ç«¶é¦¬å ´
      <select id="track">
        <option>ä¸­å±±</option>
        <option>æ±äº¬</option>
        <option>é˜ªç¥</option>
        <option>äº¬éƒ½</option>
        <option>ä¸­äº¬</option>
        <option>æœ­å¹Œ</option>
        <option>å‡½é¤¨</option>
        <option>ç¦å³¶</option>
        <option>æ–°æ½Ÿ</option>
        <option>å°å€‰</option>
        <option>ãã®ä»–</option>
      </select>
    </label>

    <label>ãƒ¬ãƒ¼ã‚¹ç•ªå·
      <select id="raceNo">
        <option>1R</option><option>2R</option><option>3R</option>
        <option>4R</option><option>5R</option><option>6R</option>
        <option>7R</option><option>8R</option><option>9R</option>
        <option>10R</option><option>11R</option><option>12R</option>
      </select>
    </label>
  </section>

  <section>
    <strong>STEP 2ï½œåˆ¤æ–­ã®ç½®ãå ´æ‰€ï¼ˆzoneï¼‰</strong>
    <div class="radio-group" id="zoneGroup">
      <label><input type="radio" name="zone" value="A" /> ğŸ  Aï¼šä¸»æˆ¦å ´ï¼ˆä¸­å±±ãƒ€1800ãƒ»è‡ªåˆ†ï¼‰</label>
      <label><input type="radio" name="zone" value="B" /> ğŸ“° Bï¼šå§”ä»»ï¼ˆè¨˜è€…ï¼‰</label>
      <label><input type="radio" name="zone" value="C" /> ğŸŒŠ Cï¼šæµã‚Œè²·ã„</label>
      <label><input type="radio" name="zone" value="D" /> ğŸ›‘ Dï¼šã‚„ã‚Šéã”ã—</label>
    </div>
  </section>

  <section>
    <strong>STEP 3ï½œèª°ã®åˆ¤æ–­ã‹ï¼ˆactorï¼‰</strong>

    <label>åˆ¤æ–­ä¸»ä½“
      <select id="actor">
        <option>è‡ªåˆ†</option>
        <option>è¨˜è€…</option>
        <option>ãã®ä»–</option>
      </select>
    </label>

    <label id="writerWrap" style="display:none;">è¨˜è€…åï¼ˆä»»æ„ï¼‰
      <input id="writerName" placeholder="ä¾‹ï¼šã‚µãƒ³ã‚¹ãƒç¶¿è¶Š" />
    </label>

    <label>ç†ç”±ï¼ˆ1è¡Œï¼‰
      <textarea id="reason" rows="2" placeholder="èª¿æ•™ã¨å‰èµ°ãŒè‰¯ã„ / ã‚ªãƒƒã‚ºãŒå®‰ã„ ãªã©"></textarea>
    </label>
    <div class="note">â€» æ›¸ã‹ãªãã¦ã‚‚OK</div>
  </section>

  <section>
    <strong>STEP 4ï½œçµæœ</strong>

    <label>è²·ã£ãŸï¼Ÿ
      <select id="bought">
        <option>è²·ã£ãŸ</option>
        <option>è²·ã‚ãªã‹ã£ãŸ</option>
      </select>
    </label>

    <label>çµæœ
      <select id="result">
        <option>çš„ä¸­</option>
        <option>ä¸çš„ä¸­</option>
        <option>è²·ã‚ãšã«çš„ä¸­</option>
      </select>
    </label>

    <label>è³­ã‘é‡‘ï¼ˆå††ï¼‰
      <input id="stake" type="number" value="500" step="100" />
    </label>

    <label>æ‰•æˆ»ï¼ˆå††ï¼‰
      <input id="payout" type="number" placeholder="ä¾‹ï¼š1400" />
    </label>
    <div class="note">â€» çš„ä¸­æ™‚ã®ã¿å…¥åŠ›ã€‚å¤–ã‚Œãƒ»è²·ã‚ãšã¯ç©ºæ¬„ã§OK</div>

    <label>ä¸€è¨€ãƒ¡ãƒ¢
      <textarea id="memo" rows="2" placeholder="å·®åˆ†ã¯é¨æ‰‹ / å®‰ãã¦ã‚¹ãƒ«ãƒ¼ã§æ­£è§£"></textarea>
    </label>

    <div class="btnRow">
      <button class="primary" id="btnSave">ä¿å­˜</button>
      <button class="secondary" id="btnReset">å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </section>

  <section>
    <strong>LOGï¼ˆCSVï¼‰</strong>
    <div class="note">ä¿å­˜å…ˆï¼šã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã€‚æ©Ÿç¨®å¤‰æ›´ã‚„ãƒ–ãƒ©ã‚¦ã‚¶å¤‰æ›´ã§æ¶ˆãˆã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚</div>
    <div class="hr"></div>

    <div class="btnRow">
      <button class="secondary" id="btnCopyCSV">CSVã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="secondary" id="btnDownloadCSV">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button class="danger" id="btnClear">ãƒ­ã‚°å…¨æ¶ˆã—</button>
    </div>

    <div class="hr"></div>
    <div class="note">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ«å°¾10ä»¶ï¼‰</div>
    <pre class="mono" id="logPreview" style="white-space:pre-wrap;"></pre>
  </section>

<script>
(() => {
  const KEY = "oji_review_logs_v1";

  // ===== Utils =====
  const el = (id) => document.getElementById(id);

  const todayISO = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  };

  const nowStr = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${dd} ${hh}:${mm}`;
  };

  const loadLogs = () => {
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  };

  const saveLogs = (logs) => localStorage.setItem(KEY, JSON.stringify(logs));

  const esc = (s) => `"${String(s ?? "").replace(/"/g,'""')}"`;
  const csvVal = (v) => {
    if (v === null || v === undefined) return "";
    if (typeof v === "number") return v;          // æ•°å€¤ã¯ãã®ã¾ã¾
    if (!isNaN(v) && v !== "") return v;          // æ•°å€¤ã£ã½ã„æ–‡å­—åˆ—ã‚‚æ•°å€¤
    return `"${String(v).replace(/"/g, '""')}"`;  // æ–‡å­—åˆ—ã¯ã‚¯ã‚©ãƒ¼ãƒˆ
  };
  
  const toCSV = (logs) => {
    const headers = [
      "ts","date","track","raceNo",
      "zone","actor","writerName","reason",
      "bought","result",
      "stake","payout","profit","roi",
      "memo"
    ];
    const lines = [headers.join(",")];

    logs.forEach(l => {
      lines.push([
        l.ts, l.date, l.track, l.raceNo,
        l.zone, l.actor, l.writerName, l.reason,
        l.bought, l.result,
        l.stake, l.payout, l.profit, l.roi,
        l.memo
      ].map(csvVal).join(","));
    });

    return lines.join("\n");
  };

  const refreshPreview = () => {
    const logs = loadLogs();
    const csv = toCSV(logs);
    const lines = csv.split("\n");
    const preview = lines.slice(0,1).concat(lines.slice(Math.max(1, lines.length-11))).join("\n");
    el("logPreview").textContent = preview;
  };

  // ===== Init =====
  el("date").value = todayISO();
  // zone default: Dï¼ˆã‚„ã‚Šéã”ã—ï¼‰ã«ã—ã¦ã‚‚ã„ã„ã€‚ã„ã¾ã¯æœªé¸æŠã€‚
  const setZone = (v) => {
    const radio = document.querySelector(`input[name="zone"][value="${v}"]`);
    if (radio) radio.checked = true;
  };

  const actorChanged = () => {
    const a = el("actor").value;
    el("writerWrap").style.display = (a === "è¨˜è€…") ? "" : "none";
    if (a !== "è¨˜è€…") el("writerName").value = "";
  };
  el("actor").addEventListener("change", actorChanged);
  actorChanged();

  // bought/result ã¨ stake/payout ã®æ•´åˆ
  const normalizeMoneyByResult = () => {
    const bought = el("bought").value;
    const result = el("result").value;

    // è²·ã‚ãªã‹ã£ãŸå ´åˆã¯ stake=0 æ¨å¥¨
    if (bought === "è²·ã‚ãªã‹ã£ãŸ") {
      el("stake").value = 0;
    } else {
      // è²·ã£ãŸã®ã«stakeãŒ0ãªã‚‰500ã‚’å…¥ã‚Œã‚‹ï¼ˆè»½ã„ä¿é™ºï¼‰
      if (parseInt(el("stake").value || "0", 10) === 0) el("stake").value = 500;
    }

    // ã€Œè²·ã‚ãšã«çš„ä¸­ã€ã®å ´åˆã€stake=0ã€payout=0ã§OKï¼ˆçµæœã ã‘æ®‹ã™ï¼‰
    if (result === "è²·ã‚ãšã«çš„ä¸­") {
      el("stake").value = 0;
      // æ‰•æˆ»ã¯å…¥åŠ›ã—ãªã„ï¼ˆ0æ‰±ã„ï¼‰
      el("payout").value = "";
    }

    // ä¸çš„ä¸­ãªã‚‰payoutç©ºã§OK
    if (result === "ä¸çš„ä¸­") {
      el("payout").value = "";
    }
  };

  el("bought").addEventListener("change", normalizeMoneyByResult);
  el("result").addEventListener("change", normalizeMoneyByResult);

  // ===== Save =====
  el("btnSave").addEventListener("click", () => {
    const date = el("date").value || todayISO();
    const track = el("track").value;
    const raceNo = el("raceNo").value;

    const zoneEl = document.querySelector('input[name="zone"]:checked');
    const zone = zoneEl ? zoneEl.value : "";
    if (!zone) {
      alert("zoneï¼ˆåˆ¤æ–­ã®ç½®ãå ´æ‰€ï¼‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
      return;
    }

    const actor = el("actor").value;
    const writerName = (actor === "è¨˜è€…") ? (el("writerName").value || "").trim() : "";
    const reason = (el("reason").value || "").trim();

    const bought = el("bought").value;
    const result = el("result").value;

    const stake = parseInt(el("stake").value || "0", 10) || 0;
    const payout = parseInt(el("payout").value || "0", 10) || 0;

    const profit = payout - stake;
    const roi = stake > 0 ? (payout / stake) : 0;

    const memo = (el("memo").value || "").trim();

    const logs = loadLogs();
    logs.push({
      ts: nowStr(),
      date, track, raceNo,
      zone, actor,
      writerName,
      reason,
      bought, result,
      stake,
      payout,
      profit,
      roi: roi.toFixed(2),
      memo
    });

    saveLogs(logs);
    refreshPreview();
    alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
  });

  // ===== Reset =====
  el("btnReset").addEventListener("click", () => {
    el("date").value = todayISO();
    el("track").value = "ä¸­å±±";
    el("raceNo").value = "11R";

    document.querySelectorAll('input[name="zone"]').forEach(r => r.checked = false);

    el("actor").value = "è‡ªåˆ†";
    actorChanged();

    el("reason").value = "";
    el("bought").value = "è²·ã£ãŸ";
    el("result").value = "çš„ä¸­";
    el("stake").value = 500;
    el("payout").value = "";
    el("memo").value = "";
    refreshPreview();
  });

  // ===== CSV buttons =====
  el("btnCopyCSV").addEventListener("click", async () => {
    const csv = toCSV(loadLogs());
    try {
      await navigator.clipboard.writeText(csv);
      alert("CSVã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
    } catch {
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚iOSã®è¨­å®šã§è¨±å¯ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚");
    }
  });

  el("btnDownloadCSV").addEventListener("click", () => {
    const csv = toCSV(loadLogs());
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `oji_review_${todayISO()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  el("btnClear").addEventListener("click", () => {
    if (!confirm("ãƒ­ã‚°ã‚’å…¨æ¶ˆã—ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(KEY);
    refreshPreview();
    alert("ãƒ­ã‚°ã‚’å…¨æ¶ˆã—ã—ã¾ã—ãŸã€‚");
  });

  // start
  refreshPreview();
})();
</script>
</body>
</html>
